This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.github/workflows/cleanup.yml
.gitignore
app/admin/create/page.tsx
app/admin/edit/[id]/page.tsx
app/admin/messages/page.tsx
app/admin/page.tsx
app/admin/profile/page.tsx
app/api/cleanup-images/route.ts
app/api/invite/route.ts
app/apply/page.tsx
app/auth/callback/route.ts
app/components/AccessibilityMenu.tsx
app/components/EventList.tsx
app/components/FilterBar.tsx
app/components/ImageCarousel.tsx
app/components/Maintenance.tsx
app/components/PostButton.tsx
app/components/ReportButton.tsx
app/components/ShareToLine.tsx
app/components/Tutorial.tsx
app/components/ViewCounter.tsx
app/error.tsx
app/events/[id]/page.tsx
app/forgot-password/page.tsx
app/globals.css
app/hooks/useAdminDashboard.ts
app/layout.tsx
app/login/page.tsx
app/page.tsx
app/privacy/page.tsx
app/register/page.tsx
app/terms/page.tsx
app/update-password/page.tsx
debug_code.txt
eslint.config.mjs
lib/supabaseClient.ts
lib/utils.ts
middleware.ts
next.config.mjs
package.json
postcss.config.js
public/file.svg
public/globe.svg
public/icon.png
public/logo.png
public/next.svg
public/vercel.svg
public/window.svg
README.md
tailwind.config.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="app/apply/page.tsx">
'use client';

import { useState } from 'react';
import { supabase } from '@/lib/supabaseClient';
import Link from 'next/link';

export default function ApplyPage() {
  const [formData, setFormData] = useState({
    organization_name: '',
    email: '',
    activity_details: ''
  });
  const [loading, setLoading] = useState(false);
  const [isSubmitted, setIsSubmitted] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setErrorMsg(null);

    try {
      const { error } = await supabase
        .from('applications')
        .insert([formData]);

      if (error) throw error;
      setIsSubmitted(true);
    } catch (err) {
      console.error(err);
      setErrorMsg('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
    } finally {
      setLoading(false);
    }
  };

  if (isSubmitted) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <div className="bg-white p-8 rounded-xl shadow-md w-full max-w-md text-center">
          <div className="text-5xl mb-4">âœ…</div>
          <h2 className="text-2xl font-bold text-gray-800 mb-2">ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ</h2>
          <p className="text-gray-600 mb-6">
            ç®¡ç†è€…ãŒå†…å®¹ã‚’ç¢ºèªå¾Œã€æ‰¿èªã•ã‚ŒãŸå ´åˆã¯ã”å…¥åŠ›ã„ãŸã ã„ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å®›ã«ç™»éŒ²ç”¨ãƒªãƒ³ã‚¯ã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚
          </p>
          <Link href="/" className="text-blue-600 hover:underline font-bold">
            ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
      <div className="bg-white p-8 rounded-xl shadow-md w-full max-w-lg">
        <h1 className="text-2xl font-bold mb-2 text-center text-gray-800">æ–°è¦åˆ©ç”¨ç”³è«‹</h1>
        <p className="text-sm text-gray-500 mb-6 text-center">
          ã‚¤ãƒ™ãƒ³ãƒˆæŠ•ç¨¿ã‚’ã”å¸Œæœ›ã®å›£ä½“æ§˜ã¯ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚ˆã‚Šç”³è«‹ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
        </p>

        {errorMsg && (
          <div className="bg-red-100 text-red-700 p-3 rounded mb-4 text-sm">
            {errorMsg}
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-5">
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">å›£ä½“åãƒ»æ´»å‹•å <span className="text-red-500">*</span></label>
            <input
              type="text"
              required
              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
              placeholder="ä¾‹ï¼šæµœæ¾è‡ªç„¶ã‚’å®ˆã‚‹ä¼š"
              value={formData.organization_name}
              onChange={(e) => setFormData({ ...formData, organization_name: e.target.value })}
            />
          </div>

          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span className="text-red-500">*</span></label>
            <input
              type="email"
              required
              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
              placeholder="contact@example.com"
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
            />
            <p className="text-xs text-gray-500 mt-1">ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ‹›å¾…çŠ¶ãŒå±Šãã¾ã™ã€‚</p>
          </div>

          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">æ´»å‹•å†…å®¹ãƒ»ç”³è«‹ç†ç”± <span className="text-red-500">*</span></label>
            <textarea
              required
              rows={4}
              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
              placeholder="ã©ã®ã‚ˆã†ãªã‚¤ãƒ™ãƒ³ãƒˆã‚’æŠ•ç¨¿äºˆå®šã‹ã€ç°¡å˜ã«ã”è¨˜å…¥ãã ã•ã„ã€‚"
              value={formData.activity_details}
              onChange={(e) => setFormData({ ...formData, activity_details: e.target.value })}
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-blue-700 transition-colors disabled:opacity-50"
          >
            {loading ? 'é€ä¿¡ä¸­...' : 'ç”³è«‹ã™ã‚‹'}
          </button>
        </form>

        <div className="mt-6 text-center">
          <Link href="/login" className="text-sm text-gray-600 hover:text-blue-600 hover:underline">
            ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
          </Link>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/components/AccessibilityMenu.tsx">
'use client';

import { useState, useEffect } from 'react';

type Props = {
  textToRead: string; // èª­ã¿ä¸Šã’ã‚‹æ–‡ç« 
};

export default function AccessibilityMenu({ textToRead }: Props) {
  const [isLargeText, setIsLargeText] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [speech, setSpeech] = useState<SpeechSynthesisUtterance | null>(null);

  // æ–‡å­—ã‚µã‚¤ã‚ºã®åˆ‡ã‚Šæ›¿ãˆ
  useEffect(() => {
    const html = document.documentElement;
    if (isLargeText) {
      html.style.fontSize = '125%'; // åŸºæº–ã‚’25%å¤§ããã™ã‚‹ï¼ˆTailwindã®remè¨ˆç®—å…¨ä½“ã«åŠ¹ãï¼‰
    } else {
      html.style.fontSize = '100%'; // å…ƒã«æˆ»ã™
    }
  }, [isLargeText]);

  // èª­ã¿ä¸Šã’ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  useEffect(() => {
    if (typeof window !== 'undefined' && window.speechSynthesis) {
      const u = new SpeechSynthesisUtterance(textToRead);
      u.lang = 'ja-JP'; // æ—¥æœ¬èªè¨­å®š
      u.rate = 0.9;     // å°‘ã—ã‚†ã£ãã‚Šè©±ã™
      u.pitch = 1;

      // èª­ã¿ä¸Šã’çµ‚äº†æ™‚ã®å‡¦ç†
      u.onend = () => setIsSpeaking(false);
      setSpeech(u);
    }
    
    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆãƒšãƒ¼ã‚¸ç§»å‹•æ™‚ãªã©ã«åœæ­¢ï¼‰
    return () => {
      window.speechSynthesis.cancel();
    };
  }, [textToRead]);

  const toggleSpeech = () => {
    if (!speech) return;

    if (isSpeaking) {
      window.speechSynthesis.cancel();
      setIsSpeaking(false);
    } else {
      window.speechSynthesis.speak(speech);
      setIsSpeaking(true);
    }
  };

  return (
    <div className="fixed bottom-4 right-4 flex flex-col gap-3 z-50">
      {/* æ–‡å­—ã‚µã‚¤ã‚ºå¤‰æ›´ãƒœã‚¿ãƒ³ */}
      <button
        onClick={() => setIsLargeText(!isLargeText)}
        className="bg-white border-2 border-teal-700 text-teal-800 rounded-full w-14 h-14 flex flex-col items-center justify-center shadow-lg hover:bg-teal-50 transition-transform active:scale-95"
        aria-label="æ–‡å­—ã‚µã‚¤ã‚ºå¤‰æ›´"
      >
        <span className="text-xs font-bold leading-none">æ–‡å­—</span>
        <span className="text-xl font-black leading-none">{isLargeText ? 'å°' : 'å¤§'}</span>
      </button>

      {/* èª­ã¿ä¸Šã’ãƒœã‚¿ãƒ³ */}
      <button
        onClick={toggleSpeech}
        className={`${
          isSpeaking ? 'bg-orange-500 text-white' : 'bg-white text-orange-600'
        } border-2 border-orange-500 rounded-full w-14 h-14 flex flex-col items-center justify-center shadow-lg hover:brightness-95 transition-transform active:scale-95`}
        aria-label={isSpeaking ? 'èª­ã¿ä¸Šã’åœæ­¢' : 'èª­ã¿ä¸Šã’é–‹å§‹'}
      >
        <span className="text-2xl">{isSpeaking ? 'â¹ï¸' : 'ğŸ”Š'}</span>
        <span className="text-[10px] font-bold">{isSpeaking ? 'åœæ­¢' : 'èã'}</span>
      </button>
    </div>
  );
}
</file>

<file path="app/components/FilterBar.tsx">
'use client';

import { useRouter, useSearchParams } from 'next/navigation';

export default function FilterBar() {
  const router = useRouter();
  const searchParams = useSearchParams();

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—
  const isRainOk = searchParams.get('rain') === 'true';
  const sortOrder = searchParams.get('sort') || 'date_asc'; // default: date_asc

  // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  const updateParams = (key: string, value: string | null) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value === null) {
      params.delete(key);
    } else {
      params.set(key, value);
    }
    // ãƒšãƒ¼ã‚¸ç•ªå·ã¯1ã«æˆ»ã™
    params.set('page', '1');
    router.push(`/?${params.toString()}`);
  };

  return (
    <div className="flex flex-col sm:flex-row justify-between items-center mb-8 bg-white p-5 rounded-2xl shadow-sm border border-slate-300 gap-4">
      
      {/* é›¨ã§ã‚‚OK ã‚¹ã‚¤ãƒƒãƒ */}
      <div 
        className="flex items-center gap-4 cursor-pointer group"
        onClick={() => updateParams('rain', isRainOk ? null : 'true')}
      >
        <div className={`w-14 h-8 rounded-full relative transition-colors duration-300 ${isRainOk ? 'bg-blue-500' : 'bg-slate-300'}`}>
          <div className={`w-6 h-6 bg-white rounded-full absolute top-1 shadow-sm transition-transform duration-300 ${isRainOk ? 'left-7' : 'left-1'}`}></div>
        </div>
        <span className={`text-base font-bold transition-colors ${isRainOk ? 'text-blue-700' : 'text-slate-700'}`}>
          é›¨ã§ã‚‚OK
        </span>
      </div>

      {/* ä¸¦ã³æ›¿ãˆ ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ */}
      <div className="flex items-center gap-3">
        <label htmlFor="sort" className="text-sm font-bold text-slate-500 whitespace-nowrap">ä¸¦ã³æ›¿ãˆ:</label>
        <div className="relative">
          <select
            id="sort"
            value={sortOrder}
            onChange={(e) => updateParams('sort', e.target.value)}
            className="appearance-none bg-slate-50 border border-slate-200 text-slate-700 font-bold py-2 pl-4 pr-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent cursor-pointer"
          >
            <option value="date_asc">ğŸ“… é–‹å‚¬ãŒæ—©ã„é †</option>
            <option value="newest">ğŸ†• æ–°ç€é †</option>
          </select>
          {/* ã‚«ã‚¹ã‚¿ãƒ çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ */}
          <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
            <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
          </div>
        </div>
      </div>

    </div>
  );
}
</file>

<file path="app/components/ImageCarousel.tsx">
'use client';

import { useState, useEffect, useRef } from 'react';

type Props = {
  images: string[];
  alt: string;
};

export default function ImageCarousel({ images, alt }: Props) {
  const scrollRef = useRef<HTMLDivElement>(null);
  const [activeIndex, setActiveIndex] = useState(0);

  // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆ10ç§’ï¼‰
  useEffect(() => {
    if (images.length <= 1) return;

    const interval = setInterval(() => {
      if (scrollRef.current) {
        const nextIndex = (activeIndex + 1) % images.length;
        const width = scrollRef.current.offsetWidth;
        scrollRef.current.scrollTo({
          left: width * nextIndex,
          behavior: 'smooth',
        });
      }
    }, 10000); // 10ç§’

    return () => clearInterval(interval);
  }, [activeIndex, images.length]);

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æ¤œçŸ¥ã—ã¦ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
  const handleScroll = () => {
    if (scrollRef.current) {
      const width = scrollRef.current.offsetWidth;
      // ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‹ã‚‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
      const index = Math.round(scrollRef.current.scrollLeft / width);
      if (index !== activeIndex) {
        setActiveIndex(index);
      }
    }
  };

  if (images.length === 0) {
    return (
      <div className="w-full h-64 md:h-96 bg-gray-200 flex items-center justify-center text-gray-400 text-2xl font-bold">
        No Image
      </div>
    );
  }

  return (
    <div className="relative w-full h-64 md:h-96 bg-gray-200 group">
      {/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ */}
      <div
        ref={scrollRef}
        onScroll={handleScroll}
        className="w-full h-full flex overflow-x-auto snap-x snap-mandatory no-scrollbar"
        style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }} // Firefox, IEç”¨
      >
        {images.map((src, i) => (
          <div key={i} className="flex-shrink-0 w-full h-full snap-center">
            <img
              src={src}
              alt={`${alt} - å†™çœŸ${i + 1}`}
              className="w-full h-full object-cover"
            />
          </div>
        ))}
      </div>
      
      {/* ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆãƒ‰ãƒƒãƒˆï¼‰ */}
      {images.length > 1 && (
        <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-10">
          {images.map((_, i) => (
            <div
              key={i}
              className={`w-2 h-2 rounded-full transition-all shadow-sm ${
                i === activeIndex ? 'bg-white scale-125' : 'bg-white/50'
              }`}
            />
          ))}
        </div>
      )}
      
      {/* å·¦å³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒã‚¦ã‚¹æ“ä½œç”¨ãƒ»ãƒ›ãƒãƒ¼æ™‚è¡¨ç¤ºï¼‰ */}
      {images.length > 1 && (
        <>
          <button
            onClick={(e) => {
              e.preventDefault();
              if (scrollRef.current) {
                const prev = activeIndex === 0 ? images.length - 1 : activeIndex - 1;
                scrollRef.current.scrollTo({ left: scrollRef.current.offsetWidth * prev, behavior: 'smooth' });
              }
            }}
            className="absolute left-2 top-1/2 -translate-y-1/2 p-2 bg-black/20 hover:bg-black/40 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
          >
            â†
          </button>
          <button
            onClick={(e) => {
              e.preventDefault();
              if (scrollRef.current) {
                const next = (activeIndex + 1) % images.length;
                scrollRef.current.scrollTo({ left: scrollRef.current.offsetWidth * next, behavior: 'smooth' });
              }
            }}
            className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-black/20 hover:bg-black/40 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
          >
            â†’
          </button>
        </>
      )}
      
      {/* Chrome/Safariç”¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */}
      <style jsx>{`
        .no-scrollbar::-webkit-scrollbar {
          display: none;
        }
      `}</style>
    </div>
  );
}
</file>

<file path="app/components/Maintenance.tsx">
'use client';

export default function Maintenance() {
  return (
    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4 text-center">
      <div className="bg-white p-8 md:p-12 rounded-2xl shadow-xl max-w-lg w-full border-t-8 border-orange-500">
        <div className="text-6xl mb-6">ğŸš§</div>
        <h1 className="text-2xl md:text-3xl font-bold text-gray-800 mb-4">
          ãŸã ã„ã¾ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­ã§ã™
        </h1>
        <p className="text-gray-600 leading-relaxed mb-6">
          ç¾åœ¨ã€ã‚·ã‚¹ãƒ†ãƒ ã®èª¿æ•´ã‚’è¡Œã£ã¦ãŠã‚Šã¾ã™ã€‚<br/>
          ã”ä¸ä¾¿ã‚’ãŠã‹ã‘ã—ã¾ã™ãŒã€ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚
        </p>
        <p className="text-sm text-gray-400">
          Administrator is working on updates.
        </p>
      </div>
    </div>
  );
}
</file>

<file path="app/components/ReportButton.tsx">
'use client';

import { useState } from 'react';
import { supabase } from '@/lib/supabaseClient';

export default function ReportButton({ eventId }: { eventId: number }) {
  const [isOpen, setIsOpen] = useState(false);
  const [reason, setReason] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async () => {
    if (!reason.trim()) return alert('ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (!confirm('ã“ã®å†…å®¹ã§é€šå ±ã—ã¾ã™ã‹ï¼Ÿ')) return;

    setIsSubmitting(true);
    try {
      const { error } = await supabase
        .from('reports')
        .insert({
          event_id: eventId,
          reason: reason
        });

      if (error) throw error;

      alert('é€šå ±ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚');
      setIsOpen(false);
      setReason('');
    } catch (e) {
      console.error(e);
      alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <>
      <button 
        onClick={() => setIsOpen(true)}
        className="text-gray-400 text-sm hover:text-red-600 underline"
      >
        âš ï¸ ä¸é©åˆ‡ãªæŠ•ç¨¿ã¨ã—ã¦å ±å‘Š
      </button>

      {isOpen && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white p-6 rounded-lg w-full max-w-md shadow-xl">
            <h3 className="font-bold text-lg mb-4 text-gray-800">é€šå ±ãƒ•ã‚©ãƒ¼ãƒ </h3>
            <p className="text-sm text-gray-600 mb-2">ã“ã®æŠ•ç¨¿ãŒä¸é©åˆ‡ã§ã‚ã‚‹ã¨æ€ã‚ã‚Œã‚‹ç†ç”±ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚</p>
            <textarea
              className="w-full border border-gray-300 rounded p-2 mb-4 h-32"
              placeholder="ä¾‹ï¼šç„¡é–¢ä¿‚ãªåºƒå‘Šã€ä¸å¿«ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€è©æ¬ºã®ç–‘ã„ãªã©..."
              value={reason}
              onChange={(e) => setReason(e.target.value)}
            />
            <div className="flex gap-2 justify-end">
              <button 
                onClick={() => setIsOpen(false)}
                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button 
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="px-4 py-2 bg-red-600 text-white font-bold rounded hover:bg-red-700 disabled:opacity-50"
              >
                {isSubmitting ? 'é€ä¿¡ä¸­...' : 'é€šå ±ã™ã‚‹'}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}
</file>

<file path="app/components/ViewCounter.tsx">
'use client';

import { useEffect, useRef } from 'react';
import { supabase } from '@/lib/supabaseClient';

export default function ViewCounter({ eventId }: { eventId: number }) {
  // äºŒé‡ã‚«ã‚¦ãƒ³ãƒˆé˜²æ­¢ã®ãŸã‚ã®ãƒ•ãƒ©ã‚°
  const hasCounted = useRef(false);

  useEffect(() => {
    if (hasCounted.current) return;

    const increment = async () => {
      // Supabaseã®RPCï¼ˆé–¢æ•°ï¼‰ã‚’å‘¼ã³å‡ºã™
      const { error } = await supabase.rpc('increment_view_count', {
        row_id: eventId
      });
      if (error) console.error('Count error:', error);
    };

    increment();
    hasCounted.current = true;
  }, [eventId]);

  return null; // ç”»é¢ã«ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„ï¼ˆæ©Ÿèƒ½ã ã‘ã®éƒ¨å“ï¼‰
}
</file>

<file path="app/error.tsx">
'use client';

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  return (
    <div className="p-10 text-center bg-white min-h-screen text-black">
      <h2 className="text-2xl font-bold text-red-600 mb-4">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
      <p className="bg-gray-100 p-4 rounded mb-4 text-left font-mono text-sm break-all">
        {error.message}
      </p>
      <button
        onClick={() => reset()}
        className="bg-blue-600 text-white px-4 py-2 rounded"
      >
        ã‚‚ã†ä¸€åº¦è©¦ã™
      </button>
    </div>
  );
}
</file>

<file path="app/forgot-password/page.tsx">
'use client';

import { useState } from 'react';
import { supabase } from '@/lib/supabaseClient';
import Link from 'next/link';

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState('');
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState<string | null>(null);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

  const handleResetRequest = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setMessage(null);
    setErrorMsg(null);

    // Supabaseã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šãƒ¡ãƒ¼ãƒ«ã‚’è¦æ±‚
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: `${window.location.origin}/update-password`, // å†è¨­å®šç”¨ãƒšãƒ¼ã‚¸ã®URL
    });

    if (error) {
      setErrorMsg('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    } else {
      setMessage('å†è¨­å®šç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }
    setLoading(false);
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
      <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <h1 className="text-2xl font-bold mb-6 text-center">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å†è¨­å®š</h1>

        {message && (
          <div className="bg-green-100 text-green-700 p-3 rounded mb-4 text-sm">
            {message}
          </div>
        )}
        
        {errorMsg && (
          <div className="bg-red-100 text-red-700 p-3 rounded mb-4 text-sm">
            {errorMsg}
          </div>
        )}

        <form onSubmit={handleResetRequest} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">ç™»éŒ²ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input
              type="email"
              required
              placeholder="example@email.com"
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 font-bold"
          >
            {loading ? 'é€ä¿¡ä¸­...' : 'å†è¨­å®šãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹'}
          </button>
        </form>

        <div className="mt-6 text-center text-sm">
          <Link href="/login" className="text-blue-600 hover:underline">
            ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
          </Link>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/privacy/page.tsx">
export default function PrivacyPage() {
  return (
    <div className="max-w-3xl mx-auto p-8 bg-white min-h-screen">
      <h1 className="text-2xl font-bold mb-6">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</h1>
      <p className="mb-4">å½“å›£ä½“ã¯ã€æœ¬ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆä¸Šã§æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã«ãŠã‘ã‚‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å€‹äººæƒ…å ±ã®å–æ‰±ã„ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®ã¨ãŠã‚Šãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ï¼ˆä»¥ä¸‹ï¼Œã€Œæœ¬ãƒãƒªã‚·ãƒ¼ã€ã¨ã„ã„ã¾ã™ã€‚ï¼‰ã‚’å®šã‚ã¾ã™ã€‚</p>
      
      <h2 className="text-xl font-bold mt-6 mb-2">ç¬¬1æ¡ï¼ˆå€‹äººæƒ…å ±ã®åˆ©ç”¨ç›®çš„ï¼‰</h2>
      <p>å½“å›£ä½“ãŒå€‹äººæƒ…å ±ã‚’åé›†ãƒ»åˆ©ç”¨ã™ã‚‹ç›®çš„ã¯ï¼Œä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚</p>
      <ul className="list-disc pl-6 mb-4">
        <li>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®æä¾›ãƒ»é‹å–¶ã®ãŸã‚</li>
        <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãŠå•ã„åˆã‚ã›ã«å›ç­”ã™ã‚‹ãŸã‚ï¼ˆæœ¬äººç¢ºèªã‚’è¡Œã†ã“ã¨ã‚’å«ã‚€ï¼‰</li>
        <li>é‡è¦ãªãŠçŸ¥ã‚‰ã›ãªã©å¿…è¦ã«å¿œã˜ãŸã”é€£çµ¡ã®ãŸã‚</li>
        <li>ä¸æ­£ãƒ»ä¸å½“ãªç›®çš„ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ã‚ˆã†ã¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰¹å®šã‚’ã—ï¼Œã”åˆ©ç”¨ã‚’ãŠæ–­ã‚Šã™ã‚‹ãŸã‚</li>
      </ul>

      {/* å¿…è¦ã«å¿œã˜ã¦æ¡æ–‡ã‚’è¿½åŠ  */}

      <p className="mt-8 text-sm text-gray-500">2025å¹´â—æœˆâ—æ—¥ åˆ¶å®š</p>
    </div>
  );
}
</file>

<file path="app/terms/page.tsx">
export default function TermsPage() {
  return (
    <div className="max-w-3xl mx-auto p-8 bg-white min-h-screen">
      <h1 className="text-2xl font-bold mb-6">åˆ©ç”¨è¦ç´„</h1>
      <p className="mb-4">ã“ã®åˆ©ç”¨è¦ç´„ï¼ˆä»¥ä¸‹ï¼Œã€Œæœ¬è¦ç´„ã€ã¨ã„ã„ã¾ã™ã€‚ï¼‰ã¯ã€å½“ã‚µã‚¤ãƒˆï¼ˆä»¥ä¸‹ï¼Œã€Œæœ¬ã‚µãƒ¼ãƒ“ã‚¹ã€ã¨ã„ã„ã¾ã™ã€‚ï¼‰ã®åˆ©ç”¨æ¡ä»¶ã‚’å®šã‚ã‚‹ã‚‚ã®ã§ã™ã€‚</p>
      
      <h2 className="text-xl font-bold mt-6 mb-2">ç¬¬1æ¡ï¼ˆé©ç”¨ï¼‰</h2>
      <p>æœ¬è¦ç´„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æœ¬ã‚µãƒ¼ãƒ“ã‚¹é‹å–¶è€…ã¨ã®é–“ã®ã€æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨ã«é–¢ã‚ã‚‹ä¸€åˆ‡ã®é–¢ä¿‚ã«é©ç”¨ã•ã‚Œã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚</p>

      <h2 className="text-xl font-bold mt-6 mb-2">ç¬¬2æ¡ï¼ˆç¦æ­¢äº‹é …ï¼‰</h2>
      <ul className="list-disc pl-6 mb-4">
        <li>æ³•ä»¤ã¾ãŸã¯å…¬åºè‰¯ä¿—ã«é•åã™ã‚‹è¡Œç‚º</li>
        <li>çŠ¯ç½ªè¡Œç‚ºã«é–¢é€£ã™ã‚‹è¡Œç‚º</li>
        <li>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®å†…å®¹ç­‰ã€æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã«å«ã¾ã‚Œã‚‹è‘—ä½œæ¨©ã€å•†æ¨™æ¨©ã»ã‹çŸ¥çš„è²¡ç”£æ¨©ã‚’ä¾µå®³ã™ã‚‹è¡Œç‚º</li>
        <li>ãã®ä»–ã€é‹å–¶è€…ãŒä¸é©åˆ‡ã¨åˆ¤æ–­ã™ã‚‹è¡Œç‚º</li>
      </ul>

      {/* å¿…è¦ã«å¿œã˜ã¦æ¡æ–‡ã‚’è¿½åŠ  */}
      
      <p className="mt-8 text-sm text-gray-500">2025å¹´â—æœˆâ—æ—¥ åˆ¶å®š</p>
    </div>
  );
}
</file>

<file path="app/update-password/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { useRouter } from 'next/navigation';

export default function UpdatePasswordPage() {
  const router = useRouter();
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false); // è¿½åŠ 
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

  useEffect(() => {
    const checkSession = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        alert('ç„¡åŠ¹ãªãƒªãƒ³ã‚¯ã‹ã€æœŸé™åˆ‡ã‚Œã§ã™ã€‚ã‚‚ã†ä¸€åº¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
        router.push('/forgot-password');
      }
    };
    checkSession();
  }, [router]);

  const handlePasswordUpdate = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setErrorMsg(null);

    const { error } = await supabase.auth.updateUser({
      password: password,
    });

    if (error) {
      setErrorMsg('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      setLoading(false);
    } else {
      alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼');
      router.push('/admin');
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
      <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <h1 className="text-2xl font-bold mb-6 text-center">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¨­å®š</h1>

        {errorMsg && (
          <div className="bg-red-100 text-red-700 p-3 rounded mb-4 text-sm">
            {errorMsg}
          </div>
        )}

        <form onSubmit={handlePasswordUpdate} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input
              type={showPassword ? 'text' : 'password'} // åˆ‡ã‚Šæ›¿ãˆ
              required
              minLength={6}
              placeholder="6æ–‡å­—ä»¥ä¸Š"
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
            />
            {/* â–¼â–¼ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ â–¼â–¼ */}
            <div className="mt-2 flex items-center">
              <input
                id="show-password-upd"
                type="checkbox"
                className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                checked={showPassword}
                onChange={() => setShowPassword(!showPassword)}
              />
              <label htmlFor="show-password-upd" className="ml-2 block text-sm text-gray-700 cursor-pointer select-none">
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹
              </label>
            </div>
            {/* â–²â–² ã“ã“ã¾ã§ â–²â–² */}
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 disabled:opacity-50 font-bold"
          >
            {loading ? 'æ›´æ–°ä¸­...' : 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹'}
          </button>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="debug_code.txt">
=== DEBUG INFO ===


================ package.json ================
{
  "name": "hamamatsu-events",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "pages:build": "npx @cloudflare/next-on-pages"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.89.0",
    "next": "16.1.1",
    "react": "19.2.3",
    "react-dom": "19.2.3"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.18",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.19",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.17",
    "typescript": "^5"
  }
}


================ next.config.ts ================
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
  images: {
    unoptimized: true,
  },
};

export default nextConfig;


[File Not Found]: next.config.js


[File Not Found]: middleware.ts


================ app/layout.tsx ================
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
      </body>
    </html>
  );
}


================ app/page.tsx ================
import { supabase } from '@/lib/supabaseClient';
import Link from 'next/link';
import { formatDate, getDaysUntil } from '@/lib/utils';

export const revalidate = 0;
export const dynamic = 'force-dynamic';
export const runtime = 'edge';

// è™å¥ï½®å¤‚ï½¾ï½©ç¸ºï½« avatar_url ç¹§å®šï½¿ï½½èœ‰ï£°
type Event = {
  id: number;
  title: string;
  event_date: string;
  location: string | null;
  image_url: string | null;
  profiles: {
    name: string | null;
    avatar_url: string | null; // éœ‘ï½½èœ‰ï£°
  } | null;
};

async function getEvents(): Promise<Event[]> {
  const today = new Date().toISOString().split('T')[0];
  const twoWeeksLater = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

  const { data, error } = await supabase
    .from('events')
    .select(`
      id, title, event_date, location, image_url,
      profiles ( name, avatar_url ) 
    `) // avatar_url ç¹§ã‚†ï½¸Â€é‚±åµâ†“èœ¿é–€ï½¾ãƒ»
    .gte('event_date', today)
    .lte('event_date', twoWeeksLater)
    .order('event_date', { ascending: true });

  if (error) {
    console.error(error);
    return [];
  }
  return data as unknown as Event[];
}

export default async function Home() {
  const events = await getEvents();

  return (
    <main className="min-h-screen bg-gray-100 pb-20 font-sans">
      <header className="bg-orange-500 text-white p-4 text-center shadow sticky top-0 z-20">
        <h1 className="text-2xl font-bold">è±¬æ‡ˆæ”¶ç¹§ï½¤ç¹å¶Î¦ç¹åŸŸãƒ¥è£ï½±</h1>
        <p className="text-xs mt-1 opacity-90">è¨ï½°è“æº˜ãƒ»è›¯ï½¬ç¸ºç¤¼é»„ç¸ºå¾Œâ˜†ç¸ºèˆŒï½ç¸ºä¹ï½‹</p>
      </header>

      <div className="max-w-md mx-auto md:max-w-4xl p-2">
        {events.length === 0 && (
          <div className="bg-white p-8 rounded-lg text-center mt-10 shadow-sm">
            <p className="text-xl text-gray-600 mb-2">è¿´ï½¾è¨ï½¨ç¸²âˆ½ï½ºäº¥ï½®å£¹ï¼†ç¹§å¾Œâ€»ç¸ºãƒ»ï½‹<br/>ç¹§ï½¤ç¹å¶Î¦ç¹åŒ»ãƒ»ç¸ºã‚…ï½Šç¸ºï½¾ç¸ºå¸™ï½“ç¸²ãƒ»/p>
          </div>
        )}

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
          {events.map((event) => {
            const statusLabel = getDaysUntil(event.event_date);
            const posterName = event.profiles?.name || 'è³ï½»è›¯ï½¬é– ãƒ»ï½¸è‚´ãƒ»';
            const posterIcon = event.profiles?.avatar_url; // ç¹§ï½¢ç¹§ï½¤ç¹§ï½³ç¹ï½³URL
            
            return (
              <Link key={event.id} href={`/events/${event.id}`} className="block group">
                <div className="bg-white rounded-2xl shadow-md overflow-hidden transform transition duration-200 active:scale-95 border-b-4 border-gray-200">
                  
                  {/* é€•ï½»èœ’ä¸ŠãŠç¹ï½ªç¹§ï½¢ */}
                  <div className="relative aspect-[4/3] bg-gray-200">
                    {event.image_url ? (
                      <img 
                        src={event.image_url} 
                        alt={event.title} 
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center bg-gray-300 text-gray-500 text-lg font-bold">
                        é€•ï½»èœ’ä¸Šâ†‘ç¸ºãƒ»
                      </div>
                    )}
                    
                    {statusLabel && (
                      <span className="absolute top-2 right-2 bg-red-600 text-white text-sm font-bold px-3 py-1 rounded-full shadow">
                        {statusLabel}
                      </span>
                    )}
                  </div>

                  {/* è« ãƒ»ï£°ï½±ç¹§ï½¨ç¹ï½ªç¹§ï½¢ */}
                  <div className="p-4">
                    <p className="text-orange-600 font-bold text-lg mb-1">
                      îå¥— {formatDate(event.event_date)}
                    </p>
                    
                    <h2 className="text-2xl font-bold text-gray-800 leading-tight mb-3">
                      {event.title}
                    </h2>
                    
                    <div className="text-gray-500 text-sm space-y-2">
                      <p>îæ¡ƒ {event.location || 'è£ï½´è¬‡Â€ç¸ºï½®éšªå€©ï½¼å³¨â†‘ç¸ºãƒ»}</p>
                      
                      {/* ç¬†ï½¼ç¬†ï½¼ ç¹§ï½¢ç¹§ï½¤ç¹§ï½³ç¹ï½³ç¸ºï½¨è—ï½£è´ç˜éŒç¹§å®šï½¡ï½¨é‰ï½º ç¬†ï½¼ç¬†ï½¼ */}
                      <div className="flex items-center gap-2 bg-gray-50 p-2 rounded-lg">
                        {/* ç¹§ï½¢ç¹§ï½¤ç¹§ï½³ç¹ï½³é€•ï½»èœ’æ“¾ï½¼åŒ»â†‘ç¸ºä»£ï½Œç¸ºï½°ç¹§ï½°ç¹ï½¬ç¹ï½¼ç¸ºï½®è³ï½¸ãƒ»ãƒ»*/}
                        <div className="w-8 h-8 rounded-full bg-gray-300 overflow-hidden flex-shrink-0 border border-gray-200">
                          {posterIcon ? (
                            <img src={posterIcon} alt={posterName} className="w-full h-full object-cover" />
                          ) : (
                            /* ç¹ãƒ»ãƒµç¹§ï½©ç¹ï½«ç¹åŒ»ã„ç¹§ï½¤ç¹§ï½³ç¹ï½³ãƒ»ãƒ»VGãƒ»ãƒ»*/
                            <svg className="w-full h-full text-gray-500 p-1" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                            </svg>
                          )}
                        </div>
                        <span className="font-bold text-gray-700">{posterName}</span>
                      </div>
                      {/* ç¬†ï½²ç¬†ï½² ç¸ºè–™ï¼…ç¸ºï½¾ç¸ºï½§ ç¬†ï½²ç¬†ï½² */}

                    </div>
                  </div>
                </div>
              </Link>
            );
          })}
        </div>
      </div>
    </main>
  );
}


================ app/globals.css ================
@tailwind base;
@tailwind components;
@tailwind utilities;
</file>

<file path="lib/utils.ts">
// æ—¥ä»˜ã‚’ã€Œ12æœˆ25æ—¥ (æ°´)ã€ã®å½¢å¼ã«å¤‰æ›ã™ã‚‹é–¢æ•°
export function formatDate(dateString: string): string {
  if (!dateString) return '';
  
  const date = new Date(dateString);
  // æ—¥æœ¬èªã®æ›œæ—¥
  const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const dayOfWeek = days[date.getDay()];

  return `${month}æœˆ${day}æ—¥ (${dayOfWeek})`;
}

// é–‹å‚¬ã¾ã§ã®æ—¥æ•°ã‚’è¨ˆç®—ã—ã¦ã€Œæ˜æ—¥ã€ã€Œä»Šæ—¥ã€ãªã©ã‚’è¿”ã™é–¢æ•°
export function getDaysUntil(dateString: string): string | null {
  const eventDate = new Date(dateString);
  const today = new Date();
  
  // æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ—¥ä»˜ã ã‘ã§æ¯”è¼ƒ
  eventDate.setHours(0,0,0,0);
  today.setHours(0,0,0,0);

  const diffTime = eventDate.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return 'ä»Šæ—¥é–‹å‚¬ï¼';
  if (diffDays === 1) return 'æ˜æ—¥é–‹å‚¬';
  if (diffDays < 0) return 'çµ‚äº†';
  
  return `ã‚ã¨${diffDays}æ—¥`;
}
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}", // â˜…ã“ã®è¡ŒãŒä¸€ç•ªé‡è¦ã§ã™ï¼ˆappãƒ•ã‚©ãƒ«ãƒ€å†…ã‚’å¯¾è±¡ã«ã™ã‚‹ï¼‰
  ],
  theme: {
    extend: {
      backgroundImage: {
        "gradient-radial": "radial-gradient(var(--tw-gradient-stops))",
        "gradient-conic":
          "conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))",
      },
    },
  },
  plugins: [],
};
export default config;
</file>

<file path="app/admin/messages/page.tsx">
'use client';

export const runtime = 'edge';

import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { useRouter } from 'next/navigation';
import Link from 'next/link';

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å‹å®šç¾©
type Profile = {
  id: string;
  name: string | null;
  role: string;
};

// ã‚¹ãƒ‘ãƒ å¯¾ç­–ã®è¨­å®š
const SPAM_CONFIG = {
  DAILY_LIMIT: 10,      // 1æ—¥ã‚ãŸã‚Šã®é€ä¿¡ä¸Šé™æ•°
  COOLDOWN_MINUTES: 3,  // é€£æŠ•é˜²æ­¢ã®å¾…æ©Ÿæ™‚é–“ï¼ˆåˆ†ï¼‰
};

export default function AdminMessagesPage() {
  const router = useRouter();
  const [profiles, setProfiles] = useState<Profile[]>([]);
  const [loading, setLoading] = useState(true);
  const [sending, setSending] = useState(false);
  const [currentUserId, setCurrentUserId] = useState<string | null>(null);
  const [myRole, setMyRole] = useState<string>('poster');

  // â˜…è¿½åŠ : æ®‹ã‚Šé€ä¿¡å¯èƒ½å›æ•°
  const [remainingCount, setRemainingCount] = useState<number | null>(null);

  // ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹
  const [selectedUserIds, setSelectedUserIds] = useState<Set<string>>(new Set());
  const [messageContent, setMessageContent] = useState('');

  useEffect(() => {
    const init = async () => {
      // 1. ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        router.push('/login');
        return;
      }
      setCurrentUserId(user.id);

      // 2. è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«ã‚’ç¢ºèª
      const { data: myProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single();

      if (!myProfile) {
        router.push('/admin');
        return;
      }
      setMyRole(myProfile.role);

      const isAdmin = ['admin', 'super_admin'].includes(myProfile.role);

      // 3. é€ä¿¡å…ˆå€™è£œã‚’å–å¾—
      let query = supabase
        .from('profiles')
        .select('id, name, role')
        .order('role', { ascending: true })
        .order('name', { ascending: true });

      if (!isAdmin) {
        query = query.in('role', ['admin', 'super_admin']);
      }

      const { data: targetProfiles, error } = await query;

      if (error) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      } else if (targetProfiles) {
        setProfiles(targetProfiles.filter(p => p.id !== user.id));
      }

      // 4. â˜…è¿½åŠ : ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€æ®‹ã‚Šé€ä¿¡å›æ•°ã‚’è¨ˆç®—ã™ã‚‹
      if (!isAdmin) {
        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
        const { count, error: countError } = await supabase
          .from('messages')
          .select('*', { count: 'exact', head: true })
          .eq('sender_id', user.id)
          .gte('created_at', yesterday);

        if (!countError && count !== null) {
          // ä¸Šé™ã‹ã‚‰é€ä¿¡æ¸ˆã¿ä»¶æ•°ã‚’å¼•ãï¼ˆãƒã‚¤ãƒŠã‚¹ã«ãªã‚‰ãªã„ã‚ˆã†ã«0ã§æ­¢ã‚ã‚‹ï¼‰
          const left = Math.max(0, SPAM_CONFIG.DAILY_LIMIT - count);
          setRemainingCount(left);
        }
      }
      
      setLoading(false);
    };

    init();
  }, [router]);

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆ‡ã‚Šæ›¿ãˆ
  const toggleUser = (id: string) => {
    const newSelected = new Set(selectedUserIds);
    if (newSelected.has(id)) {
      newSelected.delete(id);
    } else {
      newSelected.add(id);
    }
    setSelectedUserIds(newSelected);
  };

  // å…¨é¸æŠãƒ»å…¨è§£é™¤
  const toggleSelectAll = () => {
    if (selectedUserIds.size === profiles.length) {
      setSelectedUserIds(new Set());
    } else {
      setSelectedUserIds(new Set(profiles.map(p => p.id)));
    }
  };

  // ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯å‡¦ç†
  const checkSpamLimits = async (userId: string) => {
    // 1. é€£æŠ•ãƒã‚§ãƒƒã‚¯
    const { data: latestMsg, error: latestError } = await supabase
      .from('messages')
      .select('created_at')
      .eq('sender_id', userId)
      .order('created_at', { ascending: false })
      .limit(1)
      .single();

    if (!latestError && latestMsg) {
      const lastSentTime = new Date(latestMsg.created_at).getTime();
      const now = new Date().getTime();
      const diffMinutes = (now - lastSentTime) / (1000 * 60);

      if (diffMinutes < SPAM_CONFIG.COOLDOWN_MINUTES) {
        const waitTime = Math.ceil(SPAM_CONFIG.COOLDOWN_MINUTES - diffMinutes);
        throw new Error(`é€£æŠ•åˆ¶é™: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸã°ã‹ã‚Šã§ã™ã€‚\nã‚ã¨ç´„ ${waitTime} åˆ†ãŠå¾…ã¡ãã ã•ã„ã€‚`);
      }
    }

    // 2. é€ä¿¡æ•°ãƒã‚§ãƒƒã‚¯ï¼ˆStateã®å€¤ã‚‚ç¢ºèªï¼‰
    if (remainingCount !== null && remainingCount <= 0) {
      throw new Error(`é€ä¿¡åˆ¶é™: æœ¬æ—¥ã®é€ä¿¡ä¸Šé™ï¼ˆ${SPAM_CONFIG.DAILY_LIMIT}ä»¶ï¼‰ã«é”ã—ã¦ã„ã¾ã™ã€‚`);
    }
    
    // 3. ä»Šå›é€ã‚ã†ã¨ã—ã¦ã„ã‚‹ä»¶æ•°ãŒæ®‹æ•°ã‚’è¶…ãˆã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
    if (remainingCount !== null && selectedUserIds.size > remainingCount) {
       throw new Error(`é€ä¿¡åˆ¶é™: æ®‹ã‚Š ${remainingCount} ä»¶ã¾ã§ã—ã‹é€ä¿¡ã§ãã¾ã›ã‚“ã€‚\né€ä¿¡å…ˆã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚`);
    }
  };

  // é€ä¿¡å‡¦ç†
  const handleSend = async (e: React.FormEvent) => {
    e.preventDefault();

    if (selectedUserIds.size === 0) {
      alert('é€ä¿¡å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    if (!messageContent.trim()) {
      alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    if (!confirm(`${selectedUserIds.size} åã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) return;

    setSending(true);

    try {
      const isAdmin = ['admin', 'super_admin'].includes(myRole);
      
      // åˆ¶é™ãƒã‚§ãƒƒã‚¯
      if (!isAdmin && currentUserId) {
        await checkSpamLimits(currentUserId);
      }

      // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      const messagesToInsert = Array.from(selectedUserIds).map(receiverId => ({
        sender_id: currentUserId,
        receiver_id: receiverId,
        content: messageContent.trim(),
        is_read: false
      }));

      const { error } = await supabase
        .from('messages')
        .insert(messagesToInsert);

      if (error) throw error;

      // â˜…è¿½åŠ : é€ä¿¡æˆåŠŸæ™‚ã€æ®‹ã‚Šå›æ•°ã‚’æ¸›ã‚‰ã™ï¼ˆUIã®å³æ™‚åæ˜ ï¼‰
      if (!isAdmin && remainingCount !== null) {
        setRemainingCount(Math.max(0, remainingCount - selectedUserIds.size));
      }

      alert('é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
      setMessageContent('');
      setSelectedUserIds(new Set());
      
      // ç®¡ç†è€…ã®å ´åˆã¯ä¸€è¦§ã¸ã€ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯ãã®ã¾ã¾ï¼ˆé€£ç¶šé€ä¿¡ã—ãŸã„å ´åˆã®ãŸã‚ï¼‰
      if (isAdmin) {
        router.push('/admin');
      }

    } catch (error: any) {
      console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
      alert(error.message || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    } finally {
      setSending(false);
    }
  };

  if (loading) return <div className="p-10 text-center">èª­ã¿è¾¼ã¿ä¸­...</div>;

  const isAdmin = ['admin', 'super_admin'].includes(myRole);
  const pageTitle = isAdmin ? 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€æ–‰é€ä¿¡' : 'ç®¡ç†è€…ã¸ã®é€£çµ¡';

  // â˜…è¿½åŠ : é€ä¿¡å¯èƒ½ã‹ã©ã†ã‹ã®åˆ¤å®šãƒ•ãƒ©ã‚°
  const isLimitReached = !isAdmin && remainingCount !== null && remainingCount <= 0;

  return (
    <div className="min-h-screen bg-gray-50 p-4 md:p-8">
      <div className="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-md border border-gray-100">
        
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-2xl font-bold text-gray-800">{pageTitle}</h1>
          <Link href="/admin" className="text-sm text-gray-500 hover:text-gray-700 underline">
            ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
          </Link>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* å·¦ã‚«ãƒ©ãƒ ï¼šé€ä¿¡å…ˆé¸æŠ */}
          <div className="lg:col-span-1 border-r border-gray-200 pr-0 lg:pr-6">
            <div className="flex justify-between items-center mb-2">
              <label className="font-bold text-gray-700">é€ä¿¡å…ˆã‚’é¸æŠ</label>
              <button 
                type="button" 
                onClick={toggleSelectAll}
                disabled={isLimitReached} // ä¸Šé™ã«é”ã—ã¦ã„ãŸã‚‰é¸æŠä¸å¯
                className="text-xs text-blue-600 hover:underline disabled:text-gray-400 disabled:no-underline"
              >
                {selectedUserIds.size === profiles.length ? 'å…¨è§£é™¤' : 'å…¨å“¡é¸æŠ'}
              </button>
            </div>
            <p className="text-xs text-gray-500 mb-4">
              é¸æŠä¸­: <span className="font-bold text-blue-600">{selectedUserIds.size}</span> / {profiles.length} äºº
            </p>

            <div className="h-96 overflow-y-auto border border-gray-300 rounded-md bg-gray-50 p-2 space-y-1">
              {profiles.map(profile => (
                <label key={profile.id} className={`flex items-center p-2 rounded transition-colors ${isLimitReached ? 'opacity-50 cursor-not-allowed' : 'hover:bg-white cursor-pointer'}`}>
                  <input
                    type="checkbox"
                    className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300"
                    checked={selectedUserIds.has(profile.id)}
                    onChange={() => toggleUser(profile.id)}
                    disabled={isLimitReached} // ä¸Šé™ã«é”ã—ã¦ã„ãŸã‚‰é¸æŠä¸å¯
                  />
                  <div className="ml-3">
                    <p className="text-sm font-medium text-gray-900">{profile.name || 'åç„¡ã—'}</p>
                    <span className={`text-xs px-1.5 py-0.5 rounded ${
                      profile.role === 'super_admin' ? 'bg-purple-100 text-purple-700' :
                      profile.role === 'admin' ? 'bg-red-100 text-red-700' :
                      'bg-gray-200 text-gray-600'
                    }`}>
                      {profile.role}
                    </span>
                  </div>
                </label>
              ))}
              {profiles.length === 0 && (
                <p className="text-sm text-gray-400 text-center py-4">
                  é€ä¿¡å¯èƒ½ãªç›¸æ‰‹ãŒã„ã¾ã›ã‚“
                </p>
              )}
            </div>
          </div>

          {/* å³ã‚«ãƒ©ãƒ ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ› */}
          <div className="lg:col-span-2">
            <form onSubmit={handleSend} className="flex flex-col h-full">
              <label className="font-bold text-gray-700 mb-2">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹</label>
              
              {/* â˜…ä¿®æ­£: æ®‹ã‚Šå›æ•°ã®è¡¨ç¤º */}
              {!isAdmin && remainingCount !== null && (
                <div className={`mb-3 p-3 rounded-md text-sm border ${
                  remainingCount > 0 
                    ? 'bg-blue-50 border-blue-200 text-blue-800' 
                    : 'bg-red-50 border-red-200 text-red-800 font-bold'
                }`}>
                  {remainingCount > 0 ? (
                    <>
                      <span>æœ¬æ—¥ã‚ã¨ </span>
                      <span className="text-lg font-bold">{remainingCount}</span>
                      <span> ä»¶é€ä¿¡ã§ãã¾ã™ã€‚</span>
                    </>
                  ) : (
                    <span>âš ï¸ æœ¬æ—¥ã®é€ä¿¡ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚æ˜æ—¥ã¾ãŸã”åˆ©ç”¨ãã ã•ã„ã€‚</span>
                  )}
                </div>
              )}

              <div className="flex-grow">
                <textarea
                  className="w-full h-64 p-4 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 resize-none text-base disabled:bg-gray-100 disabled:text-gray-500"
                  placeholder={
                    isLimitReached 
                      ? "æœ¬æ—¥ã®é€ä¿¡ä¸Šé™ã«é”ã—ã¦ã„ã‚‹ãŸã‚å…¥åŠ›ã§ãã¾ã›ã‚“ã€‚" 
                      : (isAdmin ? "ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." : "ç®¡ç†è€…ã¸ã®é€£çµ¡äº‹é …ã€è³ªå•ãªã©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...")
                  }
                  value={messageContent}
                  onChange={(e) => setMessageContent(e.target.value)}
                  required
                  disabled={isLimitReached} // ä¸Šé™ã«é”ã—ã¦ã„ãŸã‚‰å…¥åŠ›ä¸å¯
                />
              </div>

              <div className="mt-6">
                <button
                  type="submit"
                  // ä¸Šé™ã«é”ã—ã¦ã„ã‚‹ã€é€ä¿¡ä¸­ã€ã¾ãŸã¯é¸æŠäººæ•°ãŒ0ãªã‚‰ç„¡åŠ¹åŒ–
                  disabled={sending || selectedUserIds.size === 0 || isLimitReached}
                  className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 shadow-md transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  {sending ? (
                    'é€ä¿¡ä¸­...'
                  ) : (
                    <>
                      <span>ğŸ“©</span> é€ä¿¡ã™ã‚‹
                    </>
                  )}
                </button>
                <p className="text-xs text-gray-500 mt-2 text-center">
                  â€»é€ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç›¸æ‰‹ã®ãƒã‚¤ãƒšãƒ¼ã‚¸ã«å³åº§ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </p>
              </div>
            </form>
          </div>

        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/api/invite/route.ts">
import { NextRequest, NextResponse } from 'next/server';

export const runtime = 'edge';

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const code = searchParams.get('code');

  if (code !== process.env.ADMIN_INVITE_CODE) {
    return NextResponse.json({ error: 'ç„¡åŠ¹ãªæ‹›å¾…ã‚³ãƒ¼ãƒ‰ã§ã™' }, { status: 403 });
  }

  // â˜…å¤‰æ›´: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§ã¯ãªãã€Œæ–°è¦ç™»éŒ²ç”»é¢ã€ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  const response = NextResponse.redirect(new URL('/register', request.url));

  // é€šè¡Œæ‰‹å½¢ (Cookie) ã‚’ç™ºè¡Œ
  response.cookies.set('admin_access_token', 'granted', {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24, // 1æ—¥æœ‰åŠ¹
    path: '/',
  });

  return response;
}
</file>

<file path="app/components/ShareToLine.tsx">
'use client';

type Props = {
  title: string;
  eventId: number;
  className?: string;
  variant?: 'primary' | 'modern'; // 'icon' ã‚’å»ƒæ­¢ã— 'modern' ã«å¤‰æ›´
};

export default function ShareToLine({ title, eventId, className = "", variant = 'primary' }: Props) {
  
  const handleShare = (e: React.MouseEvent) => {
    e.preventDefault(); 
    e.stopPropagation();

    const origin = window.location.origin;
    const url = `${origin}/events/${eventId}`;
    const text = `ã€æµœæ¾ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã€‘\n${title}\n${url}`;
    
    window.open(
      `https://line.me/R/msg/text/?${encodeURIComponent(text)}`,
      '_blank'
    );
  };

  // â–¼â–¼ ä¸€è¦§ç”»é¢ç”¨ï¼ˆãƒ¢ãƒ€ãƒ³ã ã‘ã©åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ â–¼â–¼
  if (variant === 'modern') {
    return (
      <button
        onClick={handleShare}
        className={`
          flex items-center gap-1.5 px-3 py-1.5 rounded-full
          border border-green-500 bg-green-50 text-green-700
          hover:bg-green-100 transition-colors
          ${className}
        `}
        title="LINEã§æ•™ãˆã‚‹"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" className="flex-shrink-0">
          <path d="M20.6 10c0-4.6-4.3-8.4-9.6-8.4S1.4 5.4 1.4 10c0 4.2 3.7 7.7 8.5 8.3.3 0 .7.1.8.3.1.2.1.5 0 .8-.1.4-.6 1.6-.7 1.9-.2.8-1 2.3.9 1.3l5.5-3.6c.3-.2.7-.2 1-.1 2.6.7 5.2-.2 5.2-4.9z"/>
        </svg>
        <span className="text-xs font-bold whitespace-nowrap">LINE</span>
      </button>
    );
  }

  // â–¼â–¼ è©³ç´°ãƒšãƒ¼ã‚¸ç”¨ï¼ˆä»Šã¾ã§é€šã‚Šã®ç›®ç«‹ã¤ãƒœã‚¿ãƒ³ï¼‰ â–¼â–¼
  return (
    <button
      onClick={handleShare}
      className={`
        flex items-center gap-1 bg-[#06C755] text-white font-bold rounded-full 
        transition-opacity hover:opacity-80 px-4 py-2 shadow-sm
        ${className}
      `}
      title="LINEã§æ•™ãˆã‚‹"
    >
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" className="flex-shrink-0">
        <path d="M20.6 10c0-4.6-4.3-8.4-9.6-8.4S1.4 5.4 1.4 10c0 4.2 3.7 7.7 8.5 8.3.3 0 .7.1.8.3.1.2.1.5 0 .8-.1.4-.6 1.6-.7 1.9-.2.8-1 2.3.9 1.3l5.5-3.6c.3-.2.7-.2 1-.1 2.6.7 5.2-.2 5.2-4.9z"/>
      </svg>
      <span className="text-sm">LINEã§é€ã‚‹</span>
    </button>
  );
}
</file>

<file path="app/components/Tutorial.tsx">
'use client';

import { useEffect } from 'react';
import { driver } from 'driver.js';
import 'driver.js/dist/driver.css';

type TutorialProps = {
  run: boolean;
  onClose: () => void;
  isAdmin: boolean;
};

export default function Tutorial({ run, onClose, isAdmin }: TutorialProps) {
  useEffect(() => {
    if (run) {
      const steps = [
        { 
          element: '#tutorial-header', 
          popover: { 
            title: 'ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸ã‚ˆã†ã“ã', 
            description: 'ã“ã“ã§ã¯æŠ•ç¨¿ã®ç®¡ç†ã‚„ã€é‹å–¶ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ã‚’ç¢ºèªã§ãã¾ã™ã€‚',
            side: "bottom" as const,
            align: 'start' as const
          } 
        },
        { 
          element: '#tutorial-mail', 
          popover: { 
            title: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½', 
            description: 'ã“ã“ã‹ã‚‰ã€ŒãŠçŸ¥ã‚‰ã›ï¼ˆå—ä¿¡ï¼‰ã€ã®ç¢ºèªã‚„ã€é‹å–¶ã¸ã®ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã€ãŒã§ãã¾ã™ã€‚æœªèª­ãŒã‚ã‚‹å ´åˆã¯ãƒãƒƒã‚¸ãŒã¤ãã¾ã™ã€‚',
            side: "bottom" as const
          } 
        },
        { 
          element: '#tutorial-create-btn', 
            popover: { 
            title: 'ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ', 
            description: 'ã“ã“ã‹ã‚‰æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’æŠ•ç¨¿ã§ãã¾ã™ã€‚',
            side: "bottom" as const
          } 
        },
        ...(isAdmin ? [
          { 
            element: '#tutorial-report', 
            popover: { 
              title: 'é€šå ±ãƒ»å ±å‘Š', 
              description: 'ã€ç®¡ç†è€…æ©Ÿèƒ½ã€‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®é€šå ±å†…å®¹ã¯ã“ã“ã§ç¢ºèªãƒ»å¯¾å¿œã§ãã¾ã™ã€‚',
              side: "bottom" as const
            } 
          },
          { 
            element: '#tutorial-application', 
            popover: { 
              title: 'æ–°è¦ç”³è«‹', 
              description: 'ã€ç®¡ç†è€…æ©Ÿèƒ½ã€‘æ–°ã—ã„å›£ä½“ã®åˆ©ç”¨ç”³è«‹ã¯ã“ã“ã«å±Šãã¾ã™ã€‚',
              side: "bottom" as const
            } 
          }
        ] : []),
        { 
          element: '#tutorial-profile', 
          popover: { 
            title: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š', 
            // â˜…å¤‰æ›´: HPã®URLã«ã¤ã„ã¦è¨€åŠ
            description: 'ã‚¢ã‚¤ã‚³ãƒ³ã€åå‰ã€å›£ä½“ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸URLã®è¨­å®šã¯ã“ã¡ã‚‰ã‹ã‚‰è¡Œãˆã¾ã™ã€‚',
            side: "left" as const
          } 
        },
      ];

      const driverObj = driver({
        showProgress: true,
        animate: true,
        nextBtnText: 'æ¬¡ã¸',
        prevBtnText: 'æˆ»ã‚‹',
        doneBtnText: 'å®Œäº†',
        onDestroyed: onClose,
        steps: steps 
      });

      driverObj.drive();
    }
  }, [run, onClose, isAdmin]);

  return null;
}
</file>

<file path="app/register/page.tsx">
'use client';

import { useState } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { useRouter } from 'next/navigation';
import Link from 'next/link';

export default function RegisterPage() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [name, setName] = useState('');
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

  // â–¼â–¼â–¼ â˜…è¿½åŠ æ©Ÿèƒ½: ãªã‚Šã™ã¾ã—é˜²æ­¢ç”¨ã®IDç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
  const generateSearchId = (str: string) => {
    return str
      // 1. NFKCæ­£è¦åŒ–ï¼ˆå…¨è§’è‹±æ•°ã‚’åŠè§’ã«ã€ãªã©ã‚’çµ±ä¸€ï¼‰
      .normalize('NFKC')
      // 2. å°æ–‡å­—ã«çµ±ä¸€ï¼ˆè‹±èªå¯¾ç­–ï¼‰
      .toLowerCase()
      // 3. ã‚¹ãƒšãƒ¼ã‚¹ã€ã‚¿ãƒ–ã€ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã€ãƒã‚¤ãƒ•ãƒ³ã€ãƒ‰ãƒƒãƒˆã€ã‚«ãƒ³ãƒã‚’å‰Šé™¤
      .replace(/[\s\t_.\-,]/g, '')
      // 4. èª¤èªã—ã‚„ã™ã„ã‚«ã‚¿ã‚«ãƒŠã‚’çµ±ä¸€ï¼ˆç°¡æ˜“ç‰ˆï¼‰
      .replace(/ãƒ³/g, 'ã‚½')  // ãƒ³ ã‚’ ã‚½ ã«å¤‰æ›ã—ã¦åŒä¸€è¦–
      .replace(/ã‚·/g, 'ãƒ„')  // ã‚· ã‚’ ãƒ„ ã«å¤‰æ›ã—ã¦åŒä¸€è¦–
      .replace(/å£/g, 'ãƒ­')  // æ¼¢å­—ã®å£(ãã¡) ã‚’ ã‚«ã‚¿ã‚«ãƒŠã®ãƒ­ ã«å¤‰æ›
      .replace(/ãƒ¼/g, '-');  // ä¼¸ã°ã—æ£’ã‚‚ãƒã‚¤ãƒ•ãƒ³æ‰±ã„ã§å‰Šé™¤å¯¾è±¡ã«ã—ã¦ã‚‚è‰¯ã„ãŒã€ã“ã“ã§ã¯çµ±ä¸€
  };

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setErrorMsg(null);

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!name.trim()) {
      setErrorMsg('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      setLoading(false);
      return;
    }

    try {
      // 1. æ¤œç´¢ç”¨IDï¼ˆãªã‚Šã™ã¾ã—åˆ¤å®šç”¨æ–‡å­—åˆ—ï¼‰ã‚’ç”Ÿæˆ
      const searchId = generateSearchId(name);

      if (searchId.length < 2) {
        setErrorMsg('æœ‰åŠ¹ãªæ–‡å­—ãŒå°‘ãªã™ãã¾ã™ã€‚è¨˜å·ã‚„ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤ã„ã¦2æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„ã€‚');
        setLoading(false);
        return;
      }

      // 2. é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆDBã®é–¢æ•°ã‚’å‘¼ã³å‡ºã™ï¼‰
      const { data: isExists, error: rpcError } = await supabase
        .rpc('check_search_id_exists', { target_id: searchId });

      if (rpcError) throw rpcError;

      if (isExists) {
        setErrorMsg('ã“ã®åå‰ï¼ˆã¾ãŸã¯é…·ä¼¼ã—ãŸåå‰ï¼‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®åå‰å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        setLoading(false);
        return;
      }

      // 3. ç™»éŒ²å‡¦ç†ï¼ˆmetadataã« search_id ã‚’å«ã‚ã‚‹ï¼‰
      const location = window.location.origin;
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: { 
            name: name,          // è¡¨ç¤ºç”¨ã®åå‰ï¼ˆãã®ã¾ã¾ï¼‰
            search_id: searchId  // é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ã®åå‰ï¼ˆè£å´ã§ä¿å­˜ï¼‰
          },
          emailRedirectTo: `${location}/admin`,
        },
      });

      if (error) {
        setErrorMsg('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      } else {
        if (data.user) {
          alert('ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™ã€‚');
          router.push('/login'); // æ–°è¦ç™»éŒ²å¾Œã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸é£›ã°ã™ã®ãŒä¸€èˆ¬çš„
        }
      }

    } catch (err: any) {
      console.error(err);
      setErrorMsg('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
      <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <h1 className="text-2xl font-bold mb-6 text-center">æ–°è¦ä¼šå“¡ç™»éŒ²</h1>
        
        {errorMsg && (
          <div className="bg-red-100 text-red-700 p-3 rounded mb-4 text-sm whitespace-pre-line">
            {errorMsg}
          </div>
        )}

        <form onSubmit={handleRegister} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">ãŠåå‰ï¼ˆè¡¨ç¤ºåï¼‰</label>
            <input
              type="text"
              required
              placeholder="ä¾‹ï¼šæµœæ¾ å¤ªéƒ"
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              value={name}
              onChange={(e) => setName(e.target.value)}
            />
            <p className="text-xs text-gray-400 mt-1">
              â€»ã‚¹ãƒšãƒ¼ã‚¹ã‚„è¨˜å·ã®é•ã„ã®ã¿ã€ç´›ã‚‰ã‚ã—ã„æ–‡å­—ï¼ˆãƒ³ã¨ã‚½ãªã©ï¼‰ã®é•ã„ã®ã¿ã®åå‰ã¯ç™»éŒ²ã§ãã¾ã›ã‚“ã€‚
            </p>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input
              type="email"
              required
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input
              type={showPassword ? 'text' : 'password'}
              required
              minLength={6}
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
            />
            <div className="mt-2 flex items-center">
              <input
                id="show-password-reg"
                type="checkbox"
                className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                checked={showPassword}
                onChange={() => setShowPassword(!showPassword)}
              />
              <label htmlFor="show-password-reg" className="ml-2 block text-sm text-gray-700 cursor-pointer select-none">
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹
              </label>
            </div>
            <p className="text-xs text-gray-500 mt-2">â€»6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</p>
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 disabled:opacity-50 font-bold"
          >
            {loading ? 'ãƒã‚§ãƒƒã‚¯ä¸­...' : 'ç™»éŒ²ã™ã‚‹'}
          </button>
        </form>

        <div className="mt-6 text-center text-sm">
          <Link href="/login" className="text-blue-600 hover:underline">
            ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯ãƒ­ã‚°ã‚¤ãƒ³ã¸
          </Link>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="eslint.config.mjs">
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  // Next.jsã®æ¨å¥¨è¨­å®šã‚’èª­ã¿è¾¼ã‚€ï¼ˆã“ã“ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãŸéƒ¨åˆ†ã‚’ä¿®æ­£ï¼‰
  ...compat.extends("next/core-web-vitals", "next/typescript"),

  // ç„¡è¦–ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šï¼ˆå…ƒã®è¨­å®šã‚’ç¶­æŒï¼‰
  {
    ignores: [".next/**", "out/**", "build/**", "next-env.d.ts"],
  },
];

export default eslintConfig;
</file>

<file path="lib/supabaseClient.ts">
import { createClient } from '@supabase/supabase-js'

// 1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€Œé–¢æ•°ã€ã‚’ä½œã‚‹ï¼ˆã“ã‚Œã§ä½¿ã†ç¬é–“ã¾ã§é…å»¶ã•ã›ã‚‹ï¼‰
export const createSupabaseClient = () => {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
  const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

  if (!supabaseUrl || !supabaseKey) {
    throw new Error('Supabase environment variables are missing!')
  }

  return createClient(supabaseUrl, supabaseKey)
}

// 2. æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã¸ã®å½±éŸ¿ã‚’æœ€å°é™ã«ã™ã‚‹ãŸã‚ã€ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚‚exportã—ã¦ãŠã
// ï¼ˆãŸã ã—ã€Server Componentã‹ã‚‰ã¯ä¸Šã®é–¢æ•°ã‚’ä½¿ã†ã®ãŒæ¨å¥¨ã§ã™ï¼‰
export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL || '',
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || ''
)
</file>

<file path="middleware.ts">
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // ä¿è­·ã—ãŸã„ãƒšãƒ¼ã‚¸
  const protectedPaths = ['/register', '/forgot-password', '/update-password'];

  // ä»Šã®ã‚¢ã‚¯ã‚»ã‚¹å…ˆãŒä¿è­·å¯¾è±¡ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
  if (protectedPaths.some((path) => pathname.startsWith(path))) {
    
    // Cookieã€Œadmin_access_tokenã€ã‚’æŒã£ã¦ã„ã‚‹ã‹ç¢ºèª
    const hasAccessToken = request.cookies.has('admin_access_token');

    // æŒã£ã¦ã„ãªã‘ã‚Œã°ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    if (!hasAccessToken) {
      return NextResponse.redirect(new URL('/', request.url));
    }
  }

  return NextResponse.next();
}

// Middlewareã‚’é©ç”¨ã™ã‚‹ãƒ‘ã‚¹ã®è¨­å®š
export const config = {
  matcher: [
    '/register',
    '/forgot-password',
    '/update-password',
  ],
};
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="app/admin/profile/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import imageCompression from 'browser-image-compression';

export default function ProfileEditPage() {
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [updating, setUpdating] = useState(false);
  
  const [name, setName] = useState('');
  // â˜…è¿½åŠ : ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸URLã‚¹ãƒ†ãƒ¼ãƒˆ
  const [websiteUrl, setWebsiteUrl] = useState('');

  const [currentAvatarUrl, setCurrentAvatarUrl] = useState<string | null>(null);
  const [newAvatarFile, setNewAvatarFile] = useState<File | null>(null);
  const [mySearchId, setMySearchId] = useState<string | null>(null);

  useEffect(() => {
    const fetchProfile = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        router.push('/login');
        return;
      }

      const { data, error } = await supabase
        .from('profiles')
        .select('name, avatar_url, search_id, website_url') // â˜…è¿½åŠ : website_urlã‚’å–å¾—
        .eq('id', user.id)
        .single();

      if (error) {
        console.error(error);
      } else if (data) {
        setName(data.name || '');
        setCurrentAvatarUrl(data.avatar_url);
        setMySearchId(data.search_id);
        // â˜…è¿½åŠ : å–å¾—ã—ãŸURLã‚’ã‚»ãƒƒãƒˆ
        setWebsiteUrl(data.website_url || '');
      }
      setLoading(false);
    };

    fetchProfile();
  }, [router]);

  // URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŠ½å‡ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  const getFilePathFromUrl = (url: string) => {
    try {
      const parts = url.split('/profile-images/');
      if (parts.length > 1) {
        return decodeURIComponent(parts[1]);
      }
      return null;
    } catch (e) {
      console.error('ãƒ‘ã‚¹è§£æã‚¨ãƒ©ãƒ¼', e);
      return null;
    }
  };

  const generateSearchId = (str: string) => {
    return str
      .normalize('NFKC')
      .toLowerCase()
      .replace(/[\s\t_.\-,]/g, '')
      .replace(/ãƒ³/g, 'ã‚½')
      .replace(/ã‚·/g, 'ãƒ„')
      .replace(/å£/g, 'ãƒ­')
      .replace(/ãƒ¼/g, '-');
  };

  const uploadAvatar = async (file: File) => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('No user');

      console.log(`ã‚¢ã‚¤ã‚³ãƒ³åœ§ç¸®å‰: ${(file.size / 1024).toFixed(2)} KB`);

      const options = {
        maxSizeMB: 0.5,
        maxWidthOrHeight: 800,
        useWebWorker: true,
        initialQuality: 0.7,
      };

      const compressedFile = await imageCompression(file, options);
      console.log(`ã‚¢ã‚¤ã‚³ãƒ³åœ§ç¸®å¾Œ: ${(compressedFile.size / 1024).toFixed(2)} KB`);

      const fileExt = file.name.split('.').pop();
      const fileName = `${user.id}-${Math.random().toString(36).substring(2)}.${fileExt}`;
      const filePath = `${fileName}`;

      const { error: uploadError } = await supabase.storage
        .from('profile-images') 
        .upload(filePath, compressedFile, { upsert: true });

      if (uploadError) throw uploadError;

      const { data } = supabase.storage
        .from('profile-images')
        .getPublicUrl(filePath);

      return data.publicUrl;

    } catch (error) {
      console.error('ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!name.trim()) {
      alert('åå‰ã¯å¿…é ˆã§ã™');
      return;
    }
    setUpdating(true);

    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not logged in');

      const newSearchId = generateSearchId(name);

      if (newSearchId.length < 2) {
        alert('åå‰ãŒçŸ­ã™ãã¾ã™ã€‚è¨˜å·ãªã©ã‚’é™¤ã„ã¦2æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„ã€‚');
        setUpdating(false);
        return;
      }

      if (newSearchId !== mySearchId) {
        const { data: isExists, error: rpcError } = await supabase
          .rpc('check_search_id_exists', { target_id: newSearchId });

        if (rpcError) throw rpcError;

        if (isExists) {
          alert('ã“ã®åå‰ï¼ˆã¾ãŸã¯é…·ä¼¼ã—ãŸåå‰ï¼‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚\nåˆ¥ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          setUpdating(false);
          return;
        }
      }

      let avatarUrl = currentAvatarUrl;
      
      // æ–°ã—ã„ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
      if (newAvatarFile) {
        avatarUrl = await uploadAvatar(newAvatarFile);

        if (currentAvatarUrl) {
          const oldFilePath = getFilePathFromUrl(currentAvatarUrl);
          if (oldFilePath) {
            const { error: deleteError } = await supabase.storage
              .from('profile-images')
              .remove([oldFilePath]);
            
            if (deleteError) {
              console.error('æ—§ã‚¢ã‚¤ã‚³ãƒ³å‰Šé™¤å¤±æ•—:', deleteError);
            } else {
              console.log('æ—§ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ:', oldFilePath);
            }
          }
        }
      }

      const { error } = await supabase
        .from('profiles')
        .update({
          name: name,
          avatar_url: avatarUrl,
          search_id: newSearchId,
          website_url: websiteUrl, // â˜…è¿½åŠ : URLã‚’ä¿å­˜
        })
        .eq('id', user.id);

      if (error) throw error;

      setMySearchId(newSearchId);
      setCurrentAvatarUrl(avatarUrl); 
      setNewAvatarFile(null);

      alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
      router.push('/admin');

    } catch (error) {
      console.error(error);
      alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setUpdating(false);
    }
  };

  const handleDeleteAccount = async () => {
    if (!window.confirm('ã€è­¦å‘Šã€‘æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\næŠ•ç¨¿ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ç”»åƒãªã©å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã€å¾©å…ƒã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚')) {
      return;
    }
    
    if (!window.confirm('æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
      return;
    }

    setUpdating(true);

    try {
      const { error } = await supabase.rpc('delete_own_account');

      if (error) throw error;

      await supabase.auth.signOut();
      alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚');
      router.push('/');

    } catch (error) {
      console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      setUpdating(false);
    }
  };

  if (loading) return <div className="p-10">èª­ã¿è¾¼ã¿ä¸­...</div>;

  return (
    <div className="min-h-screen bg-gray-50 p-8">
      <div className="max-w-xl mx-auto bg-white p-8 rounded-lg shadow">
        <h1 className="text-2xl font-bold mb-6">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ç·¨é›†</h1>
        
        <form onSubmit={handleSave} className="space-y-6">
          {/* ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒ</label>
            <div className="flex items-center gap-6">
              <div className="w-20 h-20 rounded-full bg-gray-200 border overflow-hidden flex-shrink-0 relative">
                {newAvatarFile ? (
                  <img src={URL.createObjectURL(newAvatarFile)} className="w-full h-full object-cover" alt="New Avatar" />
                ) : currentAvatarUrl ? (
                  <img src={currentAvatarUrl} className="w-full h-full object-cover" alt="Current Avatar" />
                ) : (
                  <div className="w-full h-full flex items-center justify-center text-gray-400 font-bold">No Img</div>
                )}
              </div>
              
              <div className="flex-1">
                <input 
                  type="file" 
                  accept="image/*"
                  onChange={(e) => setNewAvatarFile(e.target.files?.[0] || null)}
                  className="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer w-full"
                />
                <p className="text-xs text-gray-400 mt-2">â€»ç”»åƒã¯è‡ªå‹•çš„ã«è»½é‡åŒ–ã•ã‚Œã¾ã™</p>
              </div>
            </div>
          </div>

          {/* åå‰è¨­å®š */}
          <div>
            <label className="block text-sm font-medium text-gray-700">å›£ä½“åãƒ»è¡¨ç¤ºå <span className="text-red-500">*</span></label>
            <input
              type="text"
              required
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"
              placeholder="ä¾‹ï¼šæµœæ¾è€äººä¼š"
            />
            <p className="text-xs text-gray-400 mt-1">
              â€»ã™ã§ã«å­˜åœ¨ã™ã‚‹åå‰ã‚„ã€ç´›ã‚‰ã‚ã—ã„åå‰ã«ã¯å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚
            </p>
          </div>

          {/* â˜…è¿½åŠ : ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸URLå…¥åŠ›æ¬„ */}
          <div>
            <label className="block text-sm font-medium text-gray-700">
              å›£ä½“ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸URL <span className="text-gray-400 font-normal text-xs">(ä»»æ„)</span>
            </label>
            <input 
              type="url" 
              value={websiteUrl} 
              onChange={(e) => setWebsiteUrl(e.target.value)}
              placeholder="https://example.com"
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"
            />
            <p className="text-xs text-gray-400 mt-1">
              ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ã«ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚SNSã®URLã§ã‚‚OKã§ã™ã€‚
            </p>
          </div>

          {/* ãƒœã‚¿ãƒ³ */}
          <div className="flex gap-4 pt-4 pb-8 border-b border-gray-200">
            <Link href="/admin" className="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 text-gray-700">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </Link>
            <button
              type="submit"
              disabled={updating}
              className="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 font-bold disabled:opacity-50"
            >
              {updating ? 'ä¿å­˜ä¸­...' : 'å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹'}
            </button>
          </div>
        </form>

        {/* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã‚¨ãƒªã‚¢ */}
        <div className="mt-8 pt-4">
          <h3 className="text-sm font-bold text-gray-900 mb-2">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç®¡ç†</h3>
          <p className="text-xs text-gray-500 mb-4">
            ä¸€åº¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã¨ã€æŠ•ç¨¿ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã©å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆå»ã•ã‚Œã€å…ƒã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
          </p>
          <button
            onClick={handleDeleteAccount}
            disabled={updating}
            className="text-red-600 border border-red-200 bg-red-50 hover:bg-red-100 px-4 py-2 rounded text-sm font-bold w-full md:w-auto"
          >
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹
          </button>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="app/auth/callback/route.ts">
// app/auth/callback/route.ts
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { type NextRequest, NextResponse } from 'next/server';

export const runtime = 'edge';
export const dynamic = 'force-dynamic';

export async function GET(request: NextRequest) {
  const { searchParams, origin } = new URL(request.url);
  const code = searchParams.get('code');
  // èªè¨¼å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ãŸã„å…ˆ
  const next = searchParams.get('next') ?? '/';

  if (code) {
    // 1. å…ˆã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™
    const response = NextResponse.redirect(`${origin}${next}`);

    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          get(name: string) {
            return request.cookies.get(name)?.value;
          },
          // 2. ä½œæˆã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å¯¾ã—ã¦Cookieã‚’è¨­å®šã—ã¾ã™
          set(name: string, value: string, options: CookieOptions) {
            response.cookies.set({
              name,
              value,
              ...options,
            });
          },
          remove(name: string, options: CookieOptions) {
            response.cookies.set({
              name,
              value: '',
              ...options,
            });
          },
        },
      }
    );

    const { error } = await supabase.auth.exchangeCodeForSession(code);

    if (!error) {
      // 3. Cookieè¨­å®šæ¸ˆã¿ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™
      return response;
    }
  }

  // ã‚¨ãƒ©ãƒ¼ç­‰ã®å ´åˆ
  return NextResponse.redirect(`${origin}/auth/auth-code-error`);
}
</file>

<file path="app/components/EventList.tsx">
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { formatDate, getDaysUntil } from '@/lib/utils';
import ShareToLine from '@/app/components/ShareToLine';

type Event = {
  id: number;
  title: string;
  event_date: string;
  location: string | null;
  area: string | null;
  category: string | null;
  image_url: string | null;
  // â–¼â–¼â–¼ è¿½åŠ : ã‚¿ã‚°ã®å‹å®šç¾© â–¼â–¼â–¼
  tags: string[] | null;
  profiles: {
    name: string | null;
    avatar_url: string | null;
  } | null;
};

type Props = {
  events: Event[];
  page: number;
  totalPages: number;
};

export default function EventList({ events, page, totalPages }: Props) {
  const [keptIds, setKeptIds] = useState<number[]>([]);
  const [showKeptOnly, setShowKeptOnly] = useState(false);
  const [isLoaded, setIsLoaded] = useState(false);

  useEffect(() => {
    const saved = localStorage.getItem('hamamatsu_event_keeps_v1');
    if (saved) {
      try {
        setKeptIds(JSON.parse(saved));
      } catch (e) {
        console.error('Failed to parse keeps', e);
      }
    }
    setIsLoaded(true);
  }, []);

  const toggleKeep = (e: React.MouseEvent, id: number) => {
    e.preventDefault();
    let newIds;
    if (keptIds.includes(id)) {
      newIds = keptIds.filter(keepId => keepId !== id);
    } else {
      newIds = [...keptIds, id];
    }
    setKeptIds(newIds);
    localStorage.setItem('hamamatsu_event_keeps_v1', JSON.stringify(newIds));
  };

  const displayedEvents = showKeptOnly
    ? events.filter(event => keptIds.includes(event.id))
    : events;

  if (!isLoaded) return null;

  return (
    <div>
      {/* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */}
      <div className="flex justify-center mb-8">
        <div className="bg-white p-1 rounded-full shadow-sm border border-gray-200 inline-flex">
          <button
            onClick={() => setShowKeptOnly(false)}
            className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${
              !showKeptOnly ? 'bg-slate-700 text-white shadow' : 'text-gray-500 hover:bg-gray-100'
            }`}
          >
            ä¸€è¦§
          </button>
          <button
            onClick={() => setShowKeptOnly(true)}
            className={`px-6 py-2 rounded-full text-sm font-bold transition-all flex items-center gap-1 ${
              showKeptOnly ? 'bg-pink-500 text-white shadow' : 'text-gray-500 hover:bg-gray-100'
            }`}
          >
            <span>â™¥</span> æ°—ã«ãªã‚‹ ({events.filter(e => keptIds.includes(e.id)).length})
          </button>
        </div>
      </div>

      {displayedEvents.length === 0 && (
        <div className="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300">
          <p className="text-lg text-gray-500">è¡¨ç¤ºã§ãã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
          {showKeptOnly && (
            <button onClick={() => setShowKeptOnly(false)} className="text-blue-600 underline mt-4 text-sm font-bold">
              ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¦‹ã‚‹
            </button>
          )}
        </div>
      )}

      {/* â–¼â–¼ ãƒªã‚¹ãƒˆè¡¨ç¤º â–¼â–¼ */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {displayedEvents.map((event, index) => {
          const statusLabel = getDaysUntil(event.event_date);
          const posterName = event.profiles?.name || 'ä¸»å‚¬è€…ä¸æ˜';
          const posterIcon = event.profiles?.avatar_url;
          const isKept = keptIds.includes(event.id);
          const loadingType = index < 3 ? "eager" : "lazy";

          return (
            <Link key={event.id} href={`/events/${event.id}`} className="block group">
              <div className="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-lg transition-all duration-300 border border-slate-200 h-full flex flex-col">
                
                {/* 1. ç”»åƒã‚¨ãƒªã‚¢ (16:9 ã§æ¨ªé•·å¯¾å¿œ) */}
                <div className="relative aspect-video bg-gray-100">
                  {event.image_url ? (
                    <img 
                      src={event.image_url} 
                      alt={event.title} 
                      loading={loadingType}
                      className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-400 font-bold">No Image</div>
                  )}
                  
                  {/* === ã‚¿ã‚°é…ç½®ã‚¨ãƒªã‚¢ï¼ˆåˆ†æ•£ã•ã›ã¦é‡ãªã‚Šé˜²æ­¢ï¼‰ === */}
                  
                  {/* å·¦ä¸Š: ã‚«ãƒ†ã‚´ãƒª */}
                  {event.category && (
                    <span className="absolute top-3 left-3 bg-white/95 backdrop-blur-sm text-teal-800 text-xs font-bold px-2.5 py-1 rounded-md shadow-sm border border-teal-100">
                      {event.category}
                    </span>
                  )}

                  {/* å³ä¸Š: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */}
                  {statusLabel && (
                    <span className="absolute top-3 right-3 bg-rose-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md border-2 border-white">
                      {statusLabel}
                    </span>
                  )}

                  {/* å·¦ä¸‹: ã‚¨ãƒªã‚¢ */}
                  {event.area && (
                    <span className="absolute bottom-3 left-3 bg-white/95 backdrop-blur-sm text-slate-700 text-xs font-bold px-2.5 py-1 rounded-md shadow-sm border border-slate-100 flex items-center gap-1">
                      ğŸ“ {event.area}
                    </span>
                  )}
                </div>

                {/* 2. æƒ…å ±ã‚¨ãƒªã‚¢ */}
                <div className="p-4 flex flex-col flex-grow">
                  
                  {/* ä¸»å‚¬è€…ã‚¢ã‚¤ã‚³ãƒ³ */}
                  <div className="flex items-center gap-3 mb-3">
                    <div className="w-10 h-10 rounded-full bg-gray-200 overflow-hidden flex-shrink-0 border border-gray-200">
                      {posterIcon ? (
                        <img src={posterIcon} alt="" className="w-full h-full object-cover" />
                      ) : (
                        <div className="w-full h-full bg-gray-300" />
                      )}
                    </div>
                    <span className="text-sm text-gray-700 font-bold truncate">{posterName}</span>
                  </div>

                  {/* â–¼â–¼â–¼ è¿½åŠ : ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸Šã€ç°è‰²ï¼‰ â–¼â–¼â–¼ */}
                  {event.tags && event.tags.length > 0 && (
                    <div className="flex flex-wrap gap-2 mb-1">
                      {event.tags.map((tag, idx) => (
                        <span key={idx} className="text-xs font-bold text-gray-400">
                          #{tag}
                        </span>
                      ))}
                    </div>
                  )}

                  {/* ã‚¿ã‚¤ãƒˆãƒ« */}
                  <h2 className="text-lg font-bold text-gray-900 leading-snug mb-3 line-clamp-2 group-hover:text-blue-800 transition-colors">
                    {event.title}
                  </h2>

                  {/* æ—¥ä»˜ã¨å ´æ‰€ï¼ˆè¦‹ã‚„ã™ã„ã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰ */}
                  <div className="space-y-2 mb-4">
                    <div className="flex items-center gap-2 text-slate-700">
                      <span className="text-xl text-blue-600">ğŸ“…</span>
                      <span className="font-bold text-base">{formatDate(event.event_date)}</span>
                    </div>
                    <div className="flex items-center gap-2 text-slate-600">
                      <span className="text-xl text-red-500">ğŸ“</span>
                      <span className="text-sm truncate">{event.location || 'å ´æ‰€ã®è¨˜è¼‰ãªã—'}</span>
                    </div>
                  </div>

                  {/* 3. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}
                  <div className="mt-auto pt-3 border-t border-gray-100 flex justify-end gap-2">
                    <ShareToLine 
                      title={event.title} 
                      eventId={event.id} 
                      variant="modern" 
                    />
                    <button
                      onClick={(e) => toggleKeep(e, event.id)}
                      className={`
                        flex items-center gap-1.5 px-3 py-1.5 rounded-full border transition-colors
                        ${isKept 
                          ? 'border-pink-500 bg-pink-50 text-pink-600' 
                          : 'border-slate-200 bg-white text-slate-500 hover:bg-slate-50 hover:border-slate-300'
                        }
                      `}
                    >
                      <svg 
                        xmlns="http://www.w3.org/2000/svg" 
                        viewBox="0 0 24 24" 
                        fill={isKept ? "currentColor" : "none"} 
                        stroke="currentColor" 
                        strokeWidth="2" 
                        className="w-5 h-5"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                      </svg>
                      <span className="text-xs font-bold">
                        {isKept ? 'ä¿å­˜æ¸ˆ' : 'æ°—ã«ãªã‚‹'}
                      </span>
                    </button>
                  </div>
                </div>
              </div>
            </Link>
          );
        })}
      </div>

      {/* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */}
      {!showKeptOnly && totalPages > 1 && (
        <div className="flex justify-center items-center gap-4 mt-12 mb-8">
          {page > 1 ? (
            <Link 
              href={`/?page=${page - 1}`}
              className="px-6 py-3 bg-white text-slate-700 border border-slate-300 rounded-full font-bold shadow-sm hover:bg-slate-50 transition"
            >
              å‰ã¸
            </Link>
          ) : (
            <button disabled className="px-6 py-3 bg-gray-100 text-gray-400 border border-gray-200 rounded-full font-bold cursor-not-allowed">
              å‰ã¸
            </button>
          )}

          <span className="text-gray-600 font-bold">
            {page} / {totalPages}
          </span>

          {page < totalPages ? (
            <Link 
              href={`/?page=${page + 1}`}
              className="px-6 py-3 bg-blue-700 text-white rounded-full font-bold shadow-md hover:bg-blue-800 transition"
            >
              æ¬¡ã¸
            </Link>
          ) : (
            <button disabled className="px-6 py-3 bg-gray-100 text-gray-400 border border-gray-200 rounded-full font-bold cursor-not-allowed">
              æ¬¡ã¸
            </button>
          )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/components/PostButton.tsx">
'use client';

import { supabase } from '@/lib/supabaseClient';
import { useRouter } from 'next/navigation';

export default function PostButton() {
  const router = useRouter();

  const handleClick = async () => {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ï¼‰ã‚’ç¢ºèª
    const { data: { session } } = await supabase.auth.getSession();

    if (session) {
      // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰æŠ•ç¨¿ç”»é¢ã¸
      router.push('/admin');
    } else {
      // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
      router.push('/login');
    }
  };

  return (
    <button 
      onClick={handleClick}
      // â–¼â–¼ ã‚ªãƒ¬ãƒ³ã‚¸ã‹ã‚‰é’(text-blue-700)ãƒ»ç©ºè‰²ãƒ›ãƒãƒ¼(hover:bg-sky-50)ã«å¤‰æ›´ â–¼â–¼
      className="bg-white text-blue-700 font-bold py-2 px-5 rounded-full shadow hover:bg-sky-50 transition duration-200 flex items-center gap-2"
    >
      <span className="text-lg">âœï¸</span>
      {/* æ–‡å­—ã‚µã‚¤ã‚ºã‚’å°‘ã—å¤§ããèª¿æ•´ */}
      <span className="text-base">æŠ•ç¨¿ã™ã‚‹</span>
    </button>
  );
}
</file>

<file path="app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

/* â–¼â–¼â–¼ è¿½åŠ : ãµã‚ã£ã¨æµ®ãä¸ŠãŒã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© â–¼â–¼â–¼ */
@layer utilities {
  .animate-fade-in-up {
    animation: fadeInUp 1s ease-out forwards;
    opacity: 0; /* åˆæœŸçŠ¶æ…‹ã¯é€æ˜ */
  }

  /* é…å»¶ç”¨ã®ã‚¯ãƒ©ã‚¹ */
  .animation-delay-200 {
    animation-delay: 0.2s;
  }
  .animation-delay-400 {
    animation-delay: 0.4s;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
}
</file>

<file path="app/hooks/useAdminDashboard.ts">
'use client';

import { useState, useEffect, useRef } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { useRouter } from 'next/navigation';

// --- å‹å®šç¾© ---
export type Event = {
  id: number;
  title: string;
  event_date: string;
  poster_id?: string;
  view_count?: number;
  is_hidden: boolean;
  image_url: string | null;
  category: string | null;
  profiles: { name: string | null } | null;
};

export type Message = {
  id: string;
  content: string;
  created_at: string;
  is_read: boolean;
  sender: { name: string | null } | null;
};

export type MyProfile = {
  id: string;
  role: string;
  name: string | null;
  avatar_url: string | null;
};

export type Application = {
  id: number;
  organization_name: string;
  email: string;
  activity_details: string;
  status: 'pending' | 'approved' | 'rejected';
  created_at: string;
};

export type Report = {
  id: number;
  reason: string;
  created_at: string;
  events: { id: number; title: string } | null;
};

const WORKER_URL = 'https://mail-sender.campustocommunityshizuoka.workers.dev/';

// â˜…å¤‰æ›´: ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚­ãƒ¼ã‚’æ›´æ–°
const TUTORIAL_KEY = 'hasSeenAdminTutorial_v2';

export function useAdminDashboard() {
  const router = useRouter();
  
  // State
  const [events, setEvents] = useState<Event[]>([]);
  const [messages, setMessages] = useState<Message[]>([]);
  const [applications, setApplications] = useState<Application[]>([]);
  const [reports, setReports] = useState<Report[]>([]);
  const [loading, setLoading] = useState(true);
  const [currentUserId, setCurrentUserId] = useState<string | null>(null);
  const [myProfile, setMyProfile] = useState<MyProfile | null>(null);
  const [isMaintenance, setIsMaintenance] = useState(false);
  
  const [inviteUrl, setInviteUrl] = useState('');
  const [showQrCode, setShowQrCode] = useState(false);
  
  const [showMailMenu, setShowMailMenu] = useState(false);
  const [showMessages, setShowMessages] = useState(false);
  const [showApplications, setShowApplications] = useState(false);
  const [showReports, setShowReports] = useState(false);
  const [runTutorial, setRunTutorial] = useState(false);

  // Refs
  const mailMenuRef = useRef<HTMLDivElement>(null);
  const messagePanelRef = useRef<HTMLDivElement>(null);
  const applicationPanelRef = useRef<HTMLDivElement>(null);
  const reportPanelRef = useRef<HTMLDivElement>(null);

  // ãƒ‡ãƒ¼ã‚¿å–å¾—
  useEffect(() => {
    const fetchData = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        router.push('/login');
        return;
      }
      setCurrentUserId(user.id);

      const { data: profile } = await supabase
        .from('profiles')
        .select('id, role, name, avatar_url')
        .eq('id', user.id)
        .single();
      
      if (profile) setMyProfile(profile);
      
      const role = profile?.role || 'poster';
      const hasAdminPrivileges = ['admin', 'super_admin'].includes(role);

      if (role === 'super_admin') {
        const { data: setting } = await supabase
          .from('system_settings')
          .select('value')
          .eq('key', 'maintenance_mode')
          .single();
        if (setting) setIsMaintenance(setting.value === 'true');
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—
      let query = supabase
        .from('events')
        .select(`
          id, title, event_date, poster_id, view_count, is_hidden, image_url, category,
          profiles ( name )
        `)
        .order('event_date', { ascending: false });

      if (!hasAdminPrivileges) {
        query = query.eq('poster_id', user.id);
      }

      const { data: eventsData } = await query;
      if (eventsData) setEvents(eventsData as unknown as Event[]);

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
      const { data: messagesData } = await supabase
        .from('messages')
        .select(`
          id, content, created_at, is_read,
          sender:sender_id ( name )
        `)
        .eq('receiver_id', user.id)
        .order('created_at', { ascending: false })
        .limit(100);

      if (messagesData) setMessages(messagesData as unknown as Message[]);

      // ç®¡ç†è€…ç”¨ãƒ‡ãƒ¼ã‚¿
      if (hasAdminPrivileges) {
        const { data: appsData } = await supabase
          .from('applications')
          .select('*')
          .eq('status', 'pending')
          .order('created_at', { ascending: false });
        if (appsData) setApplications(appsData as Application[]);

        const { data: reportsData } = await supabase
          .from('reports')
          .select(`
            id, reason, created_at,
            events ( id, title )
          `)
          .order('created_at', { ascending: false });
        if (reportsData) setReports(reportsData as unknown as Report[]);
      }

      setLoading(false);

      // â˜…å¤‰æ›´: å®šæ•°åŒ–ã—ãŸã‚­ãƒ¼ã‚’ä½¿ç”¨
      const hasSeenTutorial = localStorage.getItem(TUTORIAL_KEY);
      if (!hasSeenTutorial) {
        setTimeout(() => setRunTutorial(true), 1000);
      }
    };
    fetchData();
  }, [router]);

  useEffect(() => {
    setInviteUrl('https://hamamtsu-events.shizuoka-connect.com/api/invite?code=hamamatsu2025secret');
  }, []);

  // ã‚¯ãƒªãƒƒã‚¯å¤–æ¤œçŸ¥
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (mailMenuRef.current && !mailMenuRef.current.contains(event.target as Node)) setShowMailMenu(false);
      if (applicationPanelRef.current && !applicationPanelRef.current.contains(event.target as Node)) setShowApplications(false);
      if (reportPanelRef.current && !reportPanelRef.current.contains(event.target as Node)) setShowReports(false);
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
  const handleLogout = async () => {
    await supabase.auth.signOut();
    router.push('/login');
  };

  const toggleMaintenance = async () => {
    if (myProfile?.role !== 'super_admin') return;
    
    const newValue = !isMaintenance;
    const confirmMessage = newValue 
      ? "ã€è­¦å‘Šã€‘ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚’ONã«ã—ã¾ã™ã‹ï¼Ÿ\né–²è¦§è€…ãŒã‚µã‚¤ãƒˆã‚’è¦‹ã‚‰ã‚Œãªããªã‚Šã¾ã™ã€‚"
      : "ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã—ã¦ã‚µã‚¤ãƒˆã‚’å…¬é–‹ã—ã¾ã™ã‹ï¼Ÿ";

    if (!confirm(confirmMessage)) return;

    try {
      const { error } = await supabase
        .from('system_settings')
        .update({ value: String(newValue) })
        .eq('key', 'maintenance_mode');

      if (error) throw error;
      
      setIsMaintenance(newValue);
      alert(newValue ? "ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚" : "ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚");
    } catch (e) {
      console.error(e);
      alert("è¨­å®šã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  };

  const markAsRead = async (messageId: string) => {
    const { error } = await supabase.from('messages').update({ is_read: true }).eq('id', messageId);
    if (!error) {
      setMessages(prev => prev.map(msg => msg.id === messageId ? { ...msg, is_read: true } : msg));
    }
  };

  const deleteMessage = async (messageId: string) => {
    if (!confirm('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    const { error } = await supabase.from('messages').delete().eq('id', messageId);
    if (!error) setMessages(prev => prev.filter(msg => msg.id !== messageId));
  };

  const deleteReport = async (reportId: number) => {
    if (!confirm('ã“ã®é€šå ±ã‚’ã€Œå¯¾å¿œæ¸ˆã¿ã€ã¨ã—ã¦ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const { error } = await supabase.from('reports').delete().eq('id', reportId);
    if (!error) setReports(prev => prev.filter(r => r.id !== reportId));
  };

  const handleDelete = async (id: number, poster_id?: string, eventTitle?: string) => {
    if (!window.confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    
    let deleteReason = '';
    const isDeletingOthersPost = poster_id && poster_id !== currentUserId;
    const hasAdminPrivileges = ['admin', 'super_admin'].includes(myProfile?.role || '');

    if (hasAdminPrivileges && isDeletingOthersPost) {
      const input = window.prompt('å‰Šé™¤ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã—ã¾ã™ã‹ï¼Ÿ\n(ç©ºæ¬„ã®ã¾ã¾OKã‚’æŠ¼ã™ã¨é€šçŸ¥ã‚’é€ã‚‰ãšã«å‰Šé™¤ã—ã¾ã™)');
      if (input === null) return;
      deleteReason = input;
    }

    try {
      const targetEvent = events.find(e => e.id === id);
      if (targetEvent?.image_url) {
        const filePath = targetEvent.image_url.split('/event-images/')[1];
        if (filePath) await supabase.storage.from('event-images').remove([decodeURIComponent(filePath)]);
      }

      const { error } = await supabase.from('events').delete().eq('id', id);
      if (error) throw error;

      if (deleteReason && poster_id && currentUserId) {
        await supabase.from('messages').insert({
          sender_id: currentUserId,
          receiver_id: poster_id,
          content: `ã€é‡è¦ã€‘ã‚ãªãŸã®æŠ•ç¨¿ã€Œ${eventTitle || 'ä¸æ˜ãªã‚¤ãƒ™ãƒ³ãƒˆ'}ã€ã¯ç®¡ç†è€…ã«ã‚ˆã‚Šå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚\n\nç†ç”±: ${deleteReason}`
        });
        alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‰Šé™¤ç†ç”±ã‚’é€šçŸ¥ã—ã¾ã—ãŸã€‚");
      }

      setEvents((prev) => prev.filter((e) => e.id !== id));
      if (!deleteReason) alert('å‰Šé™¤ã—ã¾ã—ãŸ');
    } catch (err) {
      console.error(err);
      alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  };

  const handleToggleHidden = async (id: number, currentHiddenStatus: boolean, poster_id?: string, eventTitle?: string) => {
    if (myProfile?.role !== 'super_admin') {
      alert('ã“ã®æ“ä½œã¯ç‰¹æ¨©ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
      return;
    }
    const newStatus = !currentHiddenStatus;
    if (!window.confirm(`ã“ã®æŠ•ç¨¿ã‚’ã€Œ${newStatus ? 'éè¡¨ç¤º' : 'å†å…¬é–‹'}ã€ã«ã—ã¾ã™ã‹ï¼Ÿ`)) return;

    let hideReason = '';
    if (newStatus === true && poster_id && poster_id !== currentUserId) {
       const input = window.prompt(`éè¡¨ç¤ºã«ã™ã‚‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦é€šçŸ¥ã—ã¾ã™ã‹ï¼Ÿ`);
       if (input === null) return;
       hideReason = input;
    }

    const { error } = await supabase.from('events').update({ is_hidden: newStatus }).eq('id', id);
    if (!error) {
      setEvents(prev => prev.map(e => e.id === id ? { ...e, is_hidden: newStatus } : e));
      if (hideReason && poster_id && currentUserId) {
         await supabase.from('messages').insert({
           sender_id: currentUserId,
           receiver_id: poster_id,
           content: `ã€ç®¡ç†è€…é€šçŸ¥ã€‘æŠ•ç¨¿ã€Œ${eventTitle}ã€ã¯éè¡¨ç¤ºã«è¨­å®šã•ã‚Œã¾ã—ãŸã€‚\nç†ç”±: ${hideReason}`
         });
         alert("é€šçŸ¥ã—ã¾ã—ãŸã€‚");
      }
    }
  };

  const sendEmailViaWorker = async (toEmail: string, toName: string, subject: string, bodyText: string) => {
    await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        toEmail, toName, subject,
        htmlContent: `<p>${toName} æ§˜</p><p>${bodyText.replace(/\n/g, '<br/>')}</p>`
      })
    });
  };

  const handleApprove = async (app: Application) => {
    if (!confirm(`ã€Œ${app.organization_name}ã€ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ`)) return;
    const subject = "ã€æµœæ¾ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã€‘åˆ©ç”¨ç”³è«‹ã®æ‰¿èªã¨æ‹›å¾…ã«ã¤ã„ã¦";
    const body = `æ‰¿èªã„ãŸã—ã¾ã—ãŸã€‚\n\nâ–¼ç™»éŒ²ç”¨ãƒªãƒ³ã‚¯\n${inviteUrl}\n\nã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;

    try {
      await sendEmailViaWorker(app.email, app.organization_name, subject, body);
      await supabase.from('applications').delete().eq('id', app.id);
      setApplications(prev => prev.filter(a => a.id !== app.id));
      alert('æ‰¿èªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã€å®Œäº†ã—ã¾ã—ãŸã€‚');
    } catch (e) {
      console.error("æ‰¿èªã‚¨ãƒ©ãƒ¼:", e); 
      alert("è‡ªå‹•é€ä¿¡å¤±æ•—ã€‚æ‰‹å‹•ã§å¯¾å¿œã—ã¦ãã ã•ã„ã€‚");
      window.location.href = `mailto:${app.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
  };

  const handleReject = async (id: number, email: string, name: string) => {
    const reason = window.prompt("å´ä¸‹ã®ç†ç”±:", "æ´»å‹•å†…å®¹ãŒæœ¬ã‚µã‚¤ãƒˆã®è¶£æ—¨ã¨ç•°ãªã‚‹ãŸã‚");
    if (reason === null) return;
    const subject = "ã€æµœæ¾ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã€‘åˆ©ç”¨ç”³è«‹ã®çµæœã«ã¤ã„ã¦";
    const body = `èª ã«æ®‹å¿µãªãŒã‚‰æ‰¿èªã‚’è¦‹é€ã‚‰ã›ã¦ã„ãŸã ãã“ã¨ã¨ãªã‚Šã¾ã—ãŸã€‚\nç†ç”±: ${reason}`;

    try {
      await sendEmailViaWorker(email, name, subject, body);
      await supabase.from('applications').delete().eq('id', id);
      setApplications(prev => prev.filter(a => a.id !== id));
      alert('å´ä¸‹ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã€å®Œäº†ã—ã¾ã—ãŸã€‚');
    } catch (e) {
      console.error("å´ä¸‹ã‚¨ãƒ©ãƒ¼:", e); 
      alert("é€ä¿¡å¤±æ•—ã€‚æ‰‹å‹•ã§å¯¾å¿œã—ã¦ãã ã•ã„ã€‚");
      window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
  };

  const handleTutorialClose = () => {
    setRunTutorial(false);
    // â˜…å¤‰æ›´: å®šæ•°åŒ–ã—ãŸã‚­ãƒ¼ã‚’ä½¿ç”¨
    localStorage.setItem(TUTORIAL_KEY, 'true');
  };

  return {
    events, messages, applications, reports, loading, myProfile,
    inviteUrl, currentUserId, isMaintenance,
    showQrCode, setShowQrCode,
    showMailMenu, setShowMailMenu,
    showMessages, setShowMessages,
    showApplications, setShowApplications,
    showReports, setShowReports,
    runTutorial, setRunTutorial,
    mailMenuRef, messagePanelRef, applicationPanelRef, reportPanelRef,
    handleLogout, markAsRead, deleteMessage, deleteReport, handleDelete, handleToggleHidden, handleApprove, handleReject, handleTutorialClose, toggleMaintenance
  };
}
</file>

<file path="app/layout.tsx">
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "æµœæ¾å¸‚ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚µã‚¤ãƒˆ",
  description: "æµœæ¾å¸‚ã§é–‹å‚¬ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’æä¾›ã—ã¾ã™ã€‚",
  icons: {
    icon: '/icon.png', // publicãƒ•ã‚©ãƒ«ãƒ€ã®ç”»åƒã‚’æŒ‡å®š
  },
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
      </body>
    </html>
  );
}
</file>

<file path="app/api/cleanup-images/route.ts">
import { createClient } from '@supabase/supabase-js';
import { NextResponse } from 'next/server';

// ãƒ‡ãƒ¼ã‚¿ã®å‹å®šç¾©ï¼ˆanyå›é¿ã®ãŸã‚ï¼‰
interface EventRow {
  id: number;
  image_url: string | null;
}

export const dynamic = 'force-dynamic';
export const runtime = 'edge';

export async function GET(request: Request) {
  try {
    // 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
    const { searchParams } = new URL(request.url);
    const key = searchParams.get('key');
    
    const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;

    if (!serviceRoleKey || !supabaseUrl) {
      console.error('Environment variables missing');
      return NextResponse.json({ error: 'Server configuration error' }, { status: 500 });
    }

    if (key !== process.env.CRON_SECRET_KEY) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
    const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey);

    // 2. ã€Œä»Šæ—¥ã‚ˆã‚Šå‰ã€ã®æ—¥ä»˜ã‚’å–å¾—
    // ç¾åœ¨æ™‚åˆ»(UTCã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³)ã‹ã‚‰æ—¥ä»˜éƒ¨åˆ†ã®ã¿æŠ½å‡º (ä¾‹: "2025-12-30")
    const todayStr = new Date().toISOString().split('T')[0];

    // 3. ç”»åƒã‚’æŒã£ã¦ã„ã¦ã€ã‹ã¤é–‹å‚¬æ—¥ãŒã€Œä»Šæ—¥ã‚ˆã‚Šå‰ï¼ˆä»Šæ—¥ã‚’å«ã¾ãªã„ï¼‰ã€ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
    // .lt('event_date', todayStr) ã¯ event_date < "2025-12-30" ã‚’æ„å‘³ã—ã¾ã™
    const { data: expiredEvents, error: fetchError } = await supabaseAdmin
      .from('events')
      .select('id, image_url')
      .lt('event_date', todayStr)
      .not('image_url', 'is', null)
      .returns<EventRow[]>(); // å‹ã‚’æŒ‡å®š

    if (fetchError) throw fetchError;

    if (!expiredEvents || expiredEvents.length === 0) {
      return NextResponse.json({ message: 'No expired images found' });
    }

    // 4. ç”»åƒã®å‰Šé™¤å‡¦ç†
    const filesToDelete: string[] = [];
    const eventIdsToUpdate: number[] = [];

    expiredEvents.forEach((event) => {
      if (event.image_url) {
        const parts = event.image_url.split('/event-images/');
        if (parts.length > 1) {
          // ãƒ‡ã‚³ãƒ¼ãƒ‰å‡¦ç†
          filesToDelete.push(decodeURIComponent(parts[1]));
          eventIdsToUpdate.push(event.id);
        }
      }
    });

    if (filesToDelete.length > 0) {
      // Storageã‹ã‚‰å‰Šé™¤
      const { error: storageError } = await supabaseAdmin
        .storage
        .from('event-images')
        .remove(filesToDelete);

      if (storageError) throw storageError;

      // DBã®image_urlã‚’nullã«æ›´æ–°
      const { error: dbError } = await supabaseAdmin
        .from('events')
        .update({ image_url: null })
        .in('id', eventIdsToUpdate);

      if (dbError) throw dbError;
    }

    return NextResponse.json({ 
      success: true, 
      deleted_count: filesToDelete.length,
      deleted_files: filesToDelete 
    });

  } catch (error: unknown) {
    // anyã‚’ä½¿ã‚ãš unknown ã¨ã—ã¦å—ã‘å–ã‚Šã€å‹ã‚¬ãƒ¼ãƒ‰ã§å‡¦ç†
    console.error('Cleanup error:', error);
    
    let errorMessage = 'An unexpected error occurred';
    if (error instanceof Error) {
      errorMessage = error.message;
    }

    return NextResponse.json({ error: errorMessage }, { status: 500 });
  }
}
</file>

<file path="app/login/page.tsx">
'use client';

import { useState } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { useRouter } from 'next/navigation';
import Link from 'next/link';

export default function LoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setErrorMsg(null);

    const { error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      setErrorMsg('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
      setLoading(false);
    } else {
      router.push('/admin');
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
      <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        
        {/* â˜…è¿½åŠ : æˆ»ã‚‹ãƒªãƒ³ã‚¯ */}
        <div className="mb-4">
          <Link href="/" className="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1">
            â† ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
          </Link>
        </div>

        <h1 className="text-2xl font-bold mb-6 text-center">é–¢ä¿‚è€…ãƒ­ã‚°ã‚¤ãƒ³</h1>
        
        {errorMsg && (
          <div className="bg-red-100 text-red-700 p-3 rounded mb-4 text-sm">
            {errorMsg}
          </div>
        )}

        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input
              type="email"
              required
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input
              type={showPassword ? 'text' : 'password'}
              required
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
            />
            <div className="mt-2 flex items-center">
              <input
                id="show-password"
                type="checkbox"
                className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                checked={showPassword}
                onChange={() => setShowPassword(!showPassword)}
              />
              <label htmlFor="show-password" className="ml-2 block text-sm text-gray-700 cursor-pointer select-none">
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹
              </label>
            </div>
          </div>
          
          <button
            type="submit"
            disabled={loading}
            className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50"
          >
            {loading ? 'å‡¦ç†ä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
          </button>
        </form>

        <div className="mt-6 flex flex-col gap-3 text-center text-sm border-t pt-4">
           <Link href="/forgot-password" className="text-blue-600 hover:underline">
             ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆ
           </Link>
           
           <div className="bg-green-50 p-3 rounded-lg border border-green-200 mt-2">
             <p className="text-gray-600 mb-1 font-bold">ã¾ã ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹</p>
             <Link href="/apply" className="text-green-700 font-bold hover:underline text-base block">
               ğŸ‘‰ æ–°è¦åˆ©ç”¨ç”³è«‹ã¯ã“ã¡ã‚‰
             </Link>
           </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="next.config.mjs">
/** @type {import('next').NextConfig} */
const nextConfig = {
  poweredByHeader: false,
  // â–¼â–¼â–¼ æ—¢å­˜ã®è¨­å®šï¼ˆãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ç„¡è¦–ãªã©ï¼‰ â–¼â–¼â–¼
  eslint: {
    ignoreDuringBuilds: true,
  },
  typescript: {
    ignoreBuildErrors: true,
  },
  images: {
    unoptimized: true,
  },
  // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

  // â–¼â–¼â–¼ â˜…ã“ã“ã‹ã‚‰è¿½åŠ ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®š â–¼â–¼â–¼
  async headers() {
    return [
      {
        // å…¨ã¦ã®ãƒšãƒ¼ã‚¸ã«é©ç”¨
        source: '/:path*',
        headers: [
          {
            key: 'X-DNS-Prefetch-Control',
            value: 'on'
          },
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=63072000; includeSubDomains; preload'
          },
          {
            key: 'X-Frame-Options',
            value: 'SAMEORIGIN' // è‡ªåˆ†ã®ã‚µã‚¤ãƒˆä»¥å¤–ã§ã®åŸ‹ã‚è¾¼ã¿ã‚’ç¦æ­¢
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff' // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®å½è£…ã‚’é˜²æ­¢
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin' // ãƒªãƒ³ã‚¯é·ç§»æ™‚ã®æƒ…å ±æ¼æ´©é˜²æ­¢
          },
          {
            // CSPï¼ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ï¼‰
            // è¨±å¯ã™ã‚‹ã‚‚ã®ï¼šè‡ªåˆ†è‡ªèº«(self)ã€Supabaseã®ç”»åƒã€Googleãƒãƒƒãƒ—ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ãªã©
            key: 'Content-Security-Policy',
            value: [
              "default-src 'self';",
              "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.google.com https://*.gstatic.com;", 
              "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;",
              "img-src 'self' blob: data: https://*.supabase.co https://*.googleusercontent.com https://*.google.com;",
              "font-src 'self' data: https://fonts.gstatic.com;",
              "frame-src 'self' https://*.google.com https://*.googleusercontent.com;",
              // â˜…ä¿®æ­£ç®‡æ‰€ï¼šCloudflare Workers (https://*.workers.dev) ã¸ã®é€šä¿¡ã‚’è¨±å¯ã«è¿½åŠ 
              "connect-src 'self' https://*.supabase.co https://*.googleapis.com https://*.workers.dev;"
            ].join(' ').replace(/\s{2,}/g, ' ').trim()
          }
        ],
      },
    ];
  },
};

export default nextConfig;
</file>

<file path=".github/workflows/cleanup.yml">
name: Cleanup Old Images

on:
  schedule:
    # æ—¥æœ¬æ™‚é–“ 16:10 (UTC 07:10) ã«å®Ÿè¡Œ
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Call Cleanup API
        run: |
          curl --fail -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" "${{ secrets.APP_URL }}/api/cleanup-images?key=${{ secrets.CRON_SECRET_KEY }}"
</file>

<file path="app/admin/edit/[id]/page.tsx">
'use client';

export const runtime = 'edge';

import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import imageCompression from 'browser-image-compression';

const AREA_OPTIONS = [
  "ä¸­å¤®åŒºï¼ˆæ—§ä¸­åŒºï¼‰",
  "ä¸­å¤®åŒºï¼ˆæ—§æ±åŒºï¼‰",
  "ä¸­å¤®åŒºï¼ˆæ—§è¥¿åŒºï¼‰",
  "ä¸­å¤®åŒºï¼ˆæ—§å—åŒºï¼‰",
  "ä¸­å¤®åŒºï¼ˆæ—§åŒ—åŒºãƒ»ä¸‰æ–¹åŸï¼‰",
  "æµœååŒºï¼ˆæ—§æµœåŒ—åŒºï¼‰",
  "æµœååŒºï¼ˆæ—§åŒ—åŒºï¼‰",
  "å¤©ç«œåŒºï¼ˆæ—§å¤©ç«œåŒºï¼‰"
];

const CATEGORY_OPTIONS = [
  "ãŠç¥­ã‚Šãƒ»ãƒãƒ«ã‚·ã‚§",
  "éŸ³æ¥½ãƒ»ãƒ©ã‚¤ãƒ–",
  "ã‚¹ãƒãƒ¼ãƒ„ãƒ»é‹å‹•",
  "å­¦ã³ãƒ»è¬›åº§",
  "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢",
  "å­è‚²ã¦ãƒ»å­ä¾›å‘ã‘",
  "å±•ç¤ºãƒ»èŠ¸è¡“",
  "ãã®ä»–"
];

// ã‚¿ã‚°è¨­å®š
const MAX_TAGS = 4;
const COMMON_TAGS = ["ç„¡æ–™", "é›¨ã§ã‚‚OK", "äºˆç´„ä¸è¦", "å½“æ—¥å‚åŠ å¯"];
const CATEGORY_TAGS: Record<string, string[]> = {
  "ãŠç¥­ã‚Šãƒ»ãƒãƒ«ã‚·ã‚§": ["é£Ÿã¹æ­©ã", "åœ°ç”£åœ°æ¶ˆ", "ç¸æ—¥"],
  "éŸ³æ¥½ãƒ»ãƒ©ã‚¤ãƒ–": ["ç”Ÿæ¼”å¥", "é‡å¤–ãƒ•ã‚§ã‚¹", "è¦³è¦§ç„¡æ–™"],
  "ã‚¹ãƒãƒ¼ãƒ„ãƒ»é‹å‹•": ["åˆå¿ƒè€…æ­“è¿", "ä½“é¨“ä¼š", "ãƒ¨ã‚¬"],
  "å­¦ã³ãƒ»è¬›åº§": ["ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—", "è‡ªç„¶è¦³å¯Ÿ", "æ­´å²"],
  "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢": ["åœ°åŸŸè²¢çŒ®", "ã‚´ãƒŸæ‹¾ã„", "åˆå¿ƒè€…OK"],
  "å­è‚²ã¦ãƒ»å­ä¾›å‘ã‘": ["ãƒ™ãƒ“ãƒ¼ã‚«ãƒ¼OK", "æˆä¹³å®¤ã‚ã‚Š", "èª­ã¿èã‹ã›"],
  "å±•ç¤ºãƒ»èŠ¸è¡“": ["å†™çœŸå±•", "ã‚¢ãƒ¼ãƒˆ", "å…¥å ´ç„¡æ–™"],
  "ãã®ä»–": ["äº¤æµä¼š", "ç›¸è«‡ä¼š"]
};

const IMAGE_UPDATE_LIMIT = 2;

export default function EditEventPage() {
  const router = useRouter();
  const params = useParams();
  const id = params.id; 

  const [loading, setLoading] = useState(true);
  const [updating, setUpdating] = useState(false);
  
  const [title, setTitle] = useState('');
  const [category, setCategory] = useState('');
  const [area, setArea] = useState('');
  const [date, setDate] = useState('');
  const [location, setLocation] = useState('');
  const [phone, setPhone] = useState('');
  const [description, setDescription] = useState('');
  
  // ã‚¿ã‚°é–¢é€£ã‚¹ãƒ†ãƒ¼ãƒˆ
  const [tags, setTags] = useState<string[]>([]);
  const [customTagInput, setCustomTagInput] = useState('');
  
  const [posterId, setPosterId] = useState<string | null>(null);
  const [myRole, setMyRole] = useState<string | null>(null);
  const [currentUserId, setCurrentUserId] = useState<string | null>(null);
  const [imageUpdateCount, setImageUpdateCount] = useState<number>(0);
  const [currentImageUrl, setCurrentImageUrl] = useState<string | null>(null);
  const [newImageFile, setNewImageFile] = useState<File | null>(null);

  useEffect(() => {
    const fetchEventAndProfile = async () => {
      if (!id) return;
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          setCurrentUserId(user.id);
          const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
          if (profile) setMyRole(profile.role);
        }
        const { data, error } = await supabase.from('events').select('*').eq('id', id).single();
        if (error) throw error;
        if (data) {
          setTitle(data.title || '');
          setCategory(data.category || '');
          setArea(data.area || '');
          setDate(data.event_date || '');
          setLocation(data.location || '');
          setPhone(data.contact_phone || '');
          setDescription(data.description || '');
          setCurrentImageUrl(data.image_url);
          setPosterId(data.poster_id);
          setImageUpdateCount(data.image_update_count || 0);
          setTags(data.tags || []); // ã‚¿ã‚°ã‚’ã‚»ãƒƒãƒˆ
        }
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        router.push('/admin');
      } finally {
        setLoading(false);
      }
    };
    fetchEventAndProfile();
  }, [id, router]);

  const getFilePathFromUrl = (url: string) => {
    try {
      const parts = url.split('/event-images/');
      if (parts.length > 1) {
        return decodeURIComponent(parts[1]);
      }
      return null;
    } catch (e) {
      console.error('ãƒ‘ã‚¹è§£æã‚¨ãƒ©ãƒ¼', e);
      return null;
    }
  };

  const uploadImage = async (file: File) => {
    try {
      console.log(`åœ§ç¸®å‰: ${(file.size / 1024).toFixed(2)} KB`);
      const options = { maxSizeMB: 0.8, maxWidthOrHeight: 1920, useWebWorker: true, initialQuality: 0.7 };
      const compressedFile = await imageCompression(file, options);
      console.log(`åœ§ç¸®å¾Œ: ${(compressedFile.size / 1024).toFixed(2)} KB`);
      const fileExt = file.name.split('.').pop();
      const fileName = `${Math.random().toString(36).substring(2)}.${fileExt}`;
      const filePath = `${fileName}`;
      const { error: uploadError } = await supabase.storage.from('event-images').upload(filePath, compressedFile);
      if (uploadError) throw uploadError;
      const { data } = supabase.storage.from('event-images').getPublicUrl(filePath);
      return data.publicUrl;
    } catch (error) {
      console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
      throw new Error('ç”»åƒã®åœ§ç¸®ã¾ãŸã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };

  // ã‚¿ã‚°è¿½åŠ å‡¦ç†
  const addTag = (tagToAdd: string) => {
    const trimmedTag = tagToAdd.trim();
    if (!trimmedTag) return;
    if (tags.length >= MAX_TAGS) return;
    if (tags.includes(trimmedTag)) return;
    setTags([...tags, trimmedTag]);
  };

  // ã‚¿ã‚°å‰Šé™¤å‡¦ç†
  const removeTag = (tagToRemove: string) => {
    setTags(tags.filter(t => t !== tagToRemove));
  };

  // ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°è¿½åŠ 
  const handleCustomTagAdd = (e: React.KeyboardEvent<HTMLInputElement> | React.MouseEvent) => {
    if (e.type === 'keydown' && (e as React.KeyboardEvent).key !== 'Enter') return;
    e.preventDefault();
    if (customTagInput) {
      addTag(customTagInput);
      setCustomTagInput('');
    }
  };

  const handleUpdate = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!title || !date || !area || !category) { alert('æ´»å‹•åã€ã‚«ãƒ†ã‚´ãƒªã€åœ°åŸŸã€é–‹å‚¬æ—¥ã¯å¿…é ˆã§ã™'); return; }
    
    const hasAdminPrivileges = ['admin', 'super_admin'].includes(myRole || '');
    if (newImageFile && !hasAdminPrivileges && imageUpdateCount >= IMAGE_UPDATE_LIMIT) {
      alert(`ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã®å†™çœŸã¯æ—¢ã«${IMAGE_UPDATE_LIMIT}å›å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã‚Œä»¥ä¸Šå¤‰æ›´ã§ãã¾ã›ã‚“ã€‚`);
      return;
    }
    if (!confirm('ã“ã®å†…å®¹ã§æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) return;

    let editReason = '';
    const isEditingOthersPost = posterId && posterId !== currentUserId;
    if (hasAdminPrivileges && isEditingOthersPost) {
      const input = window.prompt('ã€ç®¡ç†è€…æ“ä½œã€‘ç·¨é›†ç†ç”±ã‚’å…¥åŠ›ï¼ˆç©ºæ¬„OKï¼‰');
      if (input === null) return;
      editReason = input;
    }

    setUpdating(true);

    try {
      const { data: { session }, error: authError } = await supabase.auth.getSession();
      if (authError || !session) throw new Error('ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚');

      let imageUrl = currentImageUrl;
      let nextImageUpdateCount = imageUpdateCount;

      if (newImageFile) {
        imageUrl = await uploadImage(newImageFile);
        nextImageUpdateCount = imageUpdateCount + 1;

        if (currentImageUrl) {
          const oldFilePath = getFilePathFromUrl(currentImageUrl);
          if (oldFilePath) {
            const { error: deleteError } = await supabase.storage
              .from('event-images')
              .remove([oldFilePath]);
            
            if (deleteError) console.error('æ—§ç”»åƒå‰Šé™¤å¤±æ•—:', deleteError);
          }
        }
      }

      const { error: updateError } = await supabase
        .from('events')
        .update({
          title, 
          category,
          area, 
          event_date: date, 
          location, 
          contact_phone: phone,
          description, 
          image_url: imageUrl, 
          image_update_count: nextImageUpdateCount,
          updated_at: new Date().toISOString(),
          tags: tags, // ã‚¿ã‚°ã‚’æ›´æ–°
        })
        .eq('id', id);

      if (updateError) throw updateError;

      if (editReason && posterId && currentUserId) {
        await supabase.from('messages').insert({
            sender_id: currentUserId, receiver_id: posterId,
            content: `ã€ç®¡ç†è€…é€šçŸ¥ã€‘ã‚ãªãŸã®æŠ•ç¨¿ã€Œ${title}ã€ãŒç·¨é›†ã•ã‚Œã¾ã—ãŸã€‚\nç†ç”±: ${editReason}`
        });
      }

      if (!editReason) alert('ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
      router.push('/admin');

    } catch (error: unknown) {
      console.error(error);
      let message = 'æ›´æ–°ã‚¨ãƒ©ãƒ¼';
      if (error instanceof Error) {
        message = error.message;
      }
      alert(message);
    } finally {
      setUpdating(false);
    }
  };

  if (loading) return <div className="p-10 text-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>;

  const isImageLocked = !['admin', 'super_admin'].includes(myRole || '') && imageUpdateCount >= IMAGE_UPDATE_LIMIT;
  const isTagLimitReached = tags.length >= MAX_TAGS;

  return (
    <div className="min-h-screen bg-gray-50 p-4 md:p-8">
      <div className="max-w-2xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-md border border-gray-100">
        <h1 className="text-2xl font-bold mb-6 text-teal-800 text-center">æŠ•ç¨¿ã®ç·¨é›†</h1>
        <form onSubmit={handleUpdate} className="space-y-6">
          
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">æ´»å‹•å</label>
            <input type="text" required value={title} onChange={(e) => setTitle(e.target.value)} className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm" />
          </div>

          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
            <select required value={category} onChange={(e) => setCategory(e.target.value)} className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm bg-white">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              {CATEGORY_OPTIONS.map((opt) => <option key={opt} value={opt}>{opt}</option>)}
            </select>
          </div>

          {/* â–¼â–¼â–¼ ã‚¿ã‚°ç·¨é›†ã‚¨ãƒªã‚¢ â–¼â–¼â–¼ */}
          <div className="border border-gray-200 rounded-md p-4 bg-gray-50">
            <label className="block text-sm font-bold text-gray-700 mb-2">
              ã‚¿ã‚°è¨­å®š <span className="text-xs font-normal text-gray-500">ï¼ˆæœ€å¤§{MAX_TAGS}ã¤ã¾ã§ï¼‰</span>
            </label>
            
            {/* é¸æŠæ¸ˆã¿ã‚¿ã‚° */}
            <div className="flex flex-wrap gap-2 mb-4 min-h-[30px]">
              {tags.map((tag, idx) => (
                <span key={idx} className="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1">
                  #{tag}
                  <button type="button" onClick={() => removeTag(tag)} className="hover:text-blue-200 ml-1">Ã—</button>
                </span>
              ))}
              {tags.length === 0 && <span className="text-sm text-gray-400 py-1">ã‚¿ã‚°ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</span>}
            </div>

            {/* ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°å…¥åŠ› */}
            <div className="flex gap-2 mb-4">
              <input 
                type="text" 
                value={customTagInput} 
                onChange={(e) => setCustomTagInput(e.target.value)}
                onKeyDown={handleCustomTagAdd}
                placeholder="è‡ªç”±ã«å…¥åŠ›ã—ã¦è¿½åŠ " 
                className="flex-1 p-2 border border-gray-300 rounded text-sm"
                disabled={isTagLimitReached}
              />
              <button 
                type="button" 
                onClick={handleCustomTagAdd}
                className="bg-gray-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-gray-700 disabled:opacity-50"
                disabled={isTagLimitReached || !customTagInput.trim()}
              >
                è¿½åŠ 
              </button>
            </div>

            {/* æ¨å¥¨ã‚¿ã‚° */}
            <div className="space-y-3">
              <div>
                <span className="text-xs font-bold text-gray-500 block mb-1">ã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚¿ã‚°:</span>
                <div className="flex flex-wrap gap-2">
                  {COMMON_TAGS.map(t => (
                    <button
                      key={t}
                      type="button"
                      onClick={() => addTag(t)}
                      disabled={isTagLimitReached || tags.includes(t)}
                      className={`text-xs px-2 py-1 rounded border ${tags.includes(t) ? 'bg-gray-200 text-gray-400 border-gray-200' : 'bg-white text-gray-700 border-gray-300 hover:bg-blue-50 hover:border-blue-300'}`}
                    >
                      {t}
                    </button>
                  ))}
                </div>
              </div>
              
              {category && CATEGORY_TAGS[category] && (
                <div>
                  <span className="text-xs font-bold text-gray-500 block mb-1">ã€Œ{category}ã€ã®ãŠã™ã™ã‚:</span>
                  <div className="flex flex-wrap gap-2">
                    {CATEGORY_TAGS[category].map(t => (
                      <button
                        key={t}
                        type="button"
                        onClick={() => addTag(t)}
                        disabled={isTagLimitReached || tags.includes(t)}
                        className={`text-xs px-2 py-1 rounded border ${tags.includes(t) ? 'bg-gray-200 text-gray-400 border-gray-200' : 'bg-white text-gray-700 border-gray-300 hover:bg-blue-50 hover:border-blue-300'}`}
                      >
                        {t}
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
          {/* â–²â–²â–² ã‚¿ã‚°ç·¨é›†ã‚¨ãƒªã‚¢çµ‚äº† â–²â–²â–² */}

          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">åœ°åŸŸ</label>
            <select required value={area} onChange={(e) => setArea(e.target.value)} className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm bg-white">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              {AREA_OPTIONS.map((op) => <option key={op} value={op}>{op}</option>)}
            </select>
          </div>

          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">é–‹å‚¬æ—¥</label>
            <input type="date" required value={date} onChange={(e) => setDate(e.target.value)} className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm" />
          </div>

          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">æ´»å‹•è©³ç´°</label>
            <textarea rows={6} value={description} onChange={(e) => setDescription(e.target.value)} className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm" />
          </div>

          <div className="border-t pt-6">
            <label className="block text-sm font-bold text-gray-700 mb-2">å†™çœŸ</label>
            {currentImageUrl && !newImageFile && (
              <div className="mb-4">
                <div className="w-40 h-32 bg-gray-100 border rounded overflow-hidden">
                  <img src={currentImageUrl} className="w-full h-full object-cover" />
                </div>
              </div>
            )}
            {newImageFile && (
              <div className="mb-4">
                <div className="w-40 h-32 bg-gray-100 border rounded overflow-hidden relative">
                   <img src={URL.createObjectURL(newImageFile)} className="w-full h-full object-cover" />
                </div>
              </div>
            )}
            {isImageLocked ? (
              <div className="bg-gray-100 p-4 rounded text-sm text-gray-500">ğŸ”’ å¤‰æ›´å›æ•°ä¸Šé™ã§ã™</div>
            ) : (
              <input type="file" accept="image/*" onChange={(e) => setNewImageFile(e.target.files?.[0] || null)} className="block w-full text-sm text-gray-500" />
            )}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t">
            <input type="text" value={location} onChange={(e) => setLocation(e.target.value)} placeholder="å ´æ‰€" className="mt-1 block w-full p-2 border border-gray-300 rounded-md" />
            <input type="tel" value={phone} onChange={(e) => setPhone(e.target.value)} placeholder="é›»è©±ç•ªå·" className="mt-1 block w-full p-2 border border-gray-300 rounded-md" />
          </div>

          <div className="flex flex-col gap-4 pt-4">
            <button type="submit" disabled={updating} className="w-full bg-teal-700 text-white py-3 px-4 rounded-md font-bold disabled:opacity-50">{updating ? 'æ›´æ–°ä¸­...' : 'å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹'}</button>
            <Link href="/admin" className="text-center text-gray-500 underline text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</Link>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="app/admin/create/page.tsx">
'use client';

import { useState, useEffect, Suspense } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { useRouter, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import imageCompression from 'browser-image-compression';

// è¨­å®š: 1æ—¥ã‚ãŸã‚Šã®æŠ•ç¨¿ä¸Šé™æ•°
const EVENT_POST_LIMIT = 5;
// è¨­å®š: ã‚¿ã‚°ã®æœ€å¤§æ•°
const MAX_TAGS = 4;
// è¨­å®š: è¿½åŠ ç”»åƒã®æœ€å¤§æ•°
const MAX_ADDITIONAL_IMAGES = 2;

// ã‚«ãƒ†ã‚´ãƒªã®é¸æŠè‚¢
const CATEGORY_OPTIONS = [
  "ãŠç¥­ã‚Šãƒ»ãƒãƒ«ã‚·ã‚§",
  "éŸ³æ¥½ãƒ»ãƒ©ã‚¤ãƒ–",
  "ã‚¹ãƒãƒ¼ãƒ„ãƒ»é‹å‹•",
  "å­¦ã³ãƒ»è¬›åº§",
  "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢",
  "å­è‚²ã¦ãƒ»å­ä¾›å‘ã‘",
  "å±•ç¤ºãƒ»èŠ¸è¡“",
  "ãã®ä»–"
];

// åœ°åŸŸã®é¸æŠè‚¢
const AREA_OPTIONS = [
  "ä¸­å¤®åŒºï¼ˆæ—§ä¸­åŒºï¼‰",
  "ä¸­å¤®åŒºï¼ˆæ—§æ±åŒºï¼‰",
  "ä¸­å¤®åŒºï¼ˆæ—§è¥¿åŒºï¼‰",
  "ä¸­å¤®åŒºï¼ˆæ—§å—åŒºï¼‰",
  "ä¸­å¤®åŒºï¼ˆæ—§åŒ—åŒºãƒ»ä¸‰æ–¹åŸï¼‰",
  "æµœååŒºï¼ˆæ—§æµœåŒ—åŒºï¼‰",
  "æµœååŒºï¼ˆæ—§åŒ—åŒºï¼‰",
  "å¤©ç«œåŒºï¼ˆæ—§å¤©ç«œåŒºï¼‰"
];

// å…±é€šã®æ¨å¥¨ã‚¿ã‚°
const COMMON_TAGS = ["ç„¡æ–™", "é›¨ã§ã‚‚OK", "äºˆç´„ä¸è¦", "å½“æ—¥å‚åŠ å¯"];

// ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®æ¨å¥¨ã‚¿ã‚°å®šç¾©
const CATEGORY_TAGS: Record<string, string[]> = {
  "ãŠç¥­ã‚Šãƒ»ãƒãƒ«ã‚·ã‚§": ["é£Ÿã¹æ­©ã", "åœ°ç”£åœ°æ¶ˆ", "ç¸æ—¥"],
  "éŸ³æ¥½ãƒ»ãƒ©ã‚¤ãƒ–": ["ç”Ÿæ¼”å¥", "é‡å¤–ãƒ•ã‚§ã‚¹", "è¦³è¦§ç„¡æ–™"],
  "ã‚¹ãƒãƒ¼ãƒ„ãƒ»é‹å‹•": ["åˆå¿ƒè€…æ­“è¿", "ä½“é¨“ä¼š", "ãƒ¨ã‚¬"],
  "å­¦ã³ãƒ»è¬›åº§": ["ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—", "è‡ªç„¶è¦³å¯Ÿ", "æ­´å²"],
  "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢": ["åœ°åŸŸè²¢çŒ®", "ã‚´ãƒŸæ‹¾ã„", "åˆå¿ƒè€…OK"],
  "å­è‚²ã¦ãƒ»å­ä¾›å‘ã‘": ["ãƒ™ãƒ“ãƒ¼ã‚«ãƒ¼OK", "æˆä¹³å®¤ã‚ã‚Š", "èª­ã¿èã‹ã›"],
  "å±•ç¤ºãƒ»èŠ¸è¡“": ["å†™çœŸå±•", "ã‚¢ãƒ¼ãƒˆ", "å…¥å ´ç„¡æ–™"],
  "ãã®ä»–": ["äº¤æµä¼š", "ç›¸è«‡ä¼š"]
};

export default function CreateEventPage() {
  return (
    <Suspense fallback={<div className="p-10 text-center">èª­ã¿è¾¼ã¿ä¸­...</div>}>
      <CreateEventForm />
    </Suspense>
  );
}

function CreateEventForm() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const copyFromId = searchParams.get('copy_from');

  const [loading, setLoading] = useState(false);
  const [isPreview, setIsPreview] = useState(false); 

  const [remainingPosts, setRemainingPosts] = useState<number | null>(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [userRole, setUserRole] = useState<string>('');

  const [title, setTitle] = useState('');
  const [category, setCategory] = useState('');
  const [area, setArea] = useState(''); 
  const [date, setDate] = useState('');
  const [location, setLocation] = useState('');
  const [phone, setPhone] = useState('');
  const [description, setDescription] = useState('');
  const [tags, setTags] = useState<string[]>([]);
  const [customTagInput, setCustomTagInput] = useState('');

  // ç”»åƒé–¢é€£ã‚¹ãƒ†ãƒ¼ãƒˆ
  const [imageFile, setImageFile] = useState<File | null>(null);
  const [previewImageUrl, setPreviewImageUrl] = useState<string | null>(null);
  
  // è¿½åŠ ç”»åƒé–¢é€£ã‚¹ãƒ†ãƒ¼ãƒˆ
  const [additionalImages, setAdditionalImages] = useState<File[]>([]);
  const [additionalPreviews, setAdditionalPreviews] = useState<string[]>([]);

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ç®¡ç†
  const [currentSlideIndex, setCurrentSlideIndex] = useState(0);

  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  const maxDateObj = new Date();
  maxDateObj.setMonth(maxDateObj.getMonth() + 1);
  const maxDateStr = maxDateObj.toISOString().split('T')[0];

  useEffect(() => {
    const checkLimit = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data: profile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single();
      
      const role = profile?.role || 'poster';
      setUserRole(role);
      const adminFlag = ['admin', 'super_admin'].includes(role);
      setIsAdmin(adminFlag);

      if (!adminFlag) {
        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
        const { count, error } = await supabase
          .from('events')
          .select('*', { count: 'exact', head: true })
          .eq('poster_id', user.id)
          .gte('created_at', yesterday);

        if (!error && count !== null) {
          setRemainingPosts(Math.max(0, EVENT_POST_LIMIT - count));
        } else if (error) {
          console.error("æŠ•ç¨¿æ•°ã‚«ã‚¦ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼:", error);
        }
      }
    };
    checkLimit();
  }, []);

  useEffect(() => {
    if (!copyFromId) return;
    const fetchSourceEvent = async () => {
      const { data, error } = await supabase
        .from('events')
        .select('*')
        .eq('id', copyFromId)
        .single();

      if (error) {
        console.error('ã‚³ãƒ”ãƒ¼å…ƒã®å–å¾—ã«å¤±æ•—', error);
        return;
      }

      if (data) {
        setTitle(data.title);
        setCategory(data.category || '');
        setArea(data.area || '');
        setLocation(data.location || '');
        setPhone(data.contact_phone || '');
        setDescription(data.description || '');
        setTags(data.tags || []);
        // ç”»åƒã¯ã‚³ãƒ”ãƒ¼ã—ãªã„ä»•æ§˜
      }
    };
    fetchSourceEvent();
  }, [copyFromId]);

  const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setImageFile(file);
      const objectUrl = URL.createObjectURL(file);
      setPreviewImageUrl(objectUrl);
    }
  };

  const handleAdditionalImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files && files.length > 0) {
      const newFile = files[0];
      if (additionalImages.length >= MAX_ADDITIONAL_IMAGES) {
        alert(`è¿½åŠ å†™çœŸã¯æœ€å¤§${MAX_ADDITIONAL_IMAGES}æšã¾ã§ã§ã™`);
        return;
      }
      setAdditionalImages([...additionalImages, newFile]);
      setAdditionalPreviews([...additionalPreviews, URL.createObjectURL(newFile)]);
    }
    e.target.value = '';
  };

  const removeAdditionalImage = (index: number) => {
    const newImages = [...additionalImages];
    const newPreviews = [...additionalPreviews];
    newImages.splice(index, 1);
    newPreviews.splice(index, 1);
    setAdditionalImages(newImages);
    setAdditionalPreviews(newPreviews);
  };

  const addTag = (tagToAdd: string) => {
    const trimmedTag = tagToAdd.trim();
    if (!trimmedTag) return;
    if (tags.length >= MAX_TAGS) return;
    if (tags.includes(trimmedTag)) return;
    setTags([...tags, trimmedTag]);
  };

  const removeTag = (tagToRemove: string) => {
    setTags(tags.filter(t => t !== tagToRemove));
  };

  const handleCustomTagAdd = (e: React.KeyboardEvent<HTMLInputElement> | React.MouseEvent) => {
    if (e.type === 'keydown' && (e as React.KeyboardEvent).key !== 'Enter') return;
    e.preventDefault();
    if (customTagInput) {
      addTag(customTagInput);
      setCustomTagInput('');
    }
  };

  const handlePreview = (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!title || !date || !area || !category) {
      alert('ã‚¤ãƒ™ãƒ³ãƒˆåã€ã‚«ãƒ†ã‚´ãƒªã€åœ°åŸŸã€é–‹å‚¬æ—¥ã¯å¿…é ˆã§ã™');
      return;
    }

    if (!imageFile && !copyFromId) {
        if(!imageFile) {
            alert('ãƒ¡ã‚¤ãƒ³å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
    }

    const isSuperAdmin = userRole === 'super_admin';
    if (!isSuperAdmin) {
      if (date < todayStr) {
        alert('éå»ã®æ—¥ä»˜ã¯è¨­å®šã§ãã¾ã›ã‚“');
        return;
      }
      if (date > maxDateStr) {
        alert('é–‹å‚¬æ—¥ã¯æœ¬æ—¥ã‚ˆã‚Š1ãƒ¶æœˆä»¥å†…ã§è¨­å®šã—ã¦ãã ã•ã„');
        return;
      }
    }

    if (!isAdmin && remainingPosts !== null && remainingPosts <= 0) {
      alert(`æœ¬æ—¥ã®æŠ•ç¨¿ä¸Šé™ï¼ˆ${EVENT_POST_LIMIT}ä»¶ï¼‰ã«é”ã—ã¦ã„ã¾ã™ã€‚`);
      return;
    }

    setIsPreview(true);
    setCurrentSlideIndex(0);
    window.scrollTo(0, 0);
  };

  // â˜…å…±é€šã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢æ•°ï¼ˆã“ã“ã§åœ§ç¸®ã‚’è¡Œã†ãŸã‚ã€ã™ã¹ã¦ã®ç”»åƒã«é©ç”¨ã•ã‚Œã¾ã™ï¼‰
  const uploadToStorage = async (file: File) => {
    // åœ§ç¸®è¨­å®š
    const options = { maxSizeMB: 0.8, maxWidthOrHeight: 1920, useWebWorker: true, initialQuality: 0.7 };
    // åœ§ç¸®å®Ÿè¡Œ
    const compressedFile = await imageCompression(file, options);
    
    const fileExt = file.name.split('.').pop();
    const fileName = `${Math.random().toString(36).substring(2)}.${fileExt}`;
    
    const { error: uploadError } = await supabase.storage
      .from('event-images')
      .upload(fileName, compressedFile);

    if (uploadError) throw uploadError;

    const { data } = supabase.storage
      .from('event-images')
      .getPublicUrl(fileName);
    
    return data.publicUrl;
  };

  const handleSubmit = async () => {
    setLoading(true);

    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');

      // 1. ãƒ¡ã‚¤ãƒ³ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      let mainImageUrl = null;
      if (imageFile) {
        mainImageUrl = await uploadToStorage(imageFile);
      }

      // 2. è¿½åŠ ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆâ˜…ä¸¦åˆ—å‡¦ç†ã§é«˜é€ŸåŒ–ï¼‰
      // Promise.allã‚’ä½¿ã£ã¦ã€ã™ã¹ã¦ã®è¿½åŠ ç”»åƒã‚’åŒæ™‚ã«åœ§ç¸®ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™
      const additionalImageUrls = await Promise.all(
        additionalImages.map((file) => uploadToStorage(file))
      );

      const { error: insertError } = await supabase
        .from('events')
        .insert({
          title,
          category,
          area,
          event_date: date,
          location,
          contact_phone: phone,
          description,
          image_url: mainImageUrl,
          poster_id: user.id,
          tags: tags,
          additional_images: additionalImageUrls, // è¿½åŠ ç”»åƒURLãƒªã‚¹ãƒˆ
        });

      if (insertError) throw insertError;

      alert('ã‚¤ãƒ™ãƒ³ãƒˆã‚’å…¬é–‹ã—ã¾ã—ãŸï¼');
      router.push('/admin');

    } catch (error: unknown) {
      console.error(error);
      let message = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
      if (error instanceof Error) {
        message = error.message;
      }
      alert(message);
    } finally {
      setLoading(false);
    }
  };

  const isLimitReached = !isAdmin && remainingPosts !== null && remainingPosts <= 0;
  const isSuperAdmin = userRole === 'super_admin';
  const isTagLimitReached = tags.length >= MAX_TAGS;
  const isAdditionalImageLimitReached = additionalImages.length >= MAX_ADDITIONAL_IMAGES;

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ç”»åƒãƒªã‚¹ãƒˆï¼ˆãƒ¡ã‚¤ãƒ³ + è¿½åŠ ï¼‰
  const allPreviewImages = [previewImageUrl, ...additionalPreviews].filter(Boolean) as string[];

  if (isPreview) {
    return (
      <div className="min-h-screen bg-gray-50 p-4 md:p-8">
        <div className="max-w-2xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden border border-teal-100">
          <div className="bg-teal-50 p-4 border-b border-teal-100 text-center">
            <h2 className="text-xl font-bold text-teal-800">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª</h2>
            <p className="text-sm text-teal-600">å®Ÿéš›ã®è¡¨ç¤ºã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ï¼ˆå†™çœŸã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ï¼‰</p>
          </div>

          <div className="p-6 space-y-6">
            {/* ç°¡æ˜“ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰ */}
            <div className="w-full aspect-video bg-gray-100 rounded-lg overflow-hidden relative group">
              {allPreviewImages.length > 0 ? (
                <>
                  <img 
                    src={allPreviewImages[currentSlideIndex]} 
                    alt="Preview" 
                    className="w-full h-full object-cover transition-opacity duration-500" 
                  />
                  
                  {allPreviewImages.length > 1 && (
                    <>
                      <button 
                        onClick={(e) => {
                          e.preventDefault();
                          setCurrentSlideIndex((prev) => (prev === 0 ? allPreviewImages.length - 1 : prev - 1));
                        }}
                        className="absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full hover:bg-black/50"
                      >
                        â—€
                      </button>
                      <button 
                        onClick={(e) => {
                          e.preventDefault();
                          setCurrentSlideIndex((prev) => (prev === allPreviewImages.length - 1 ? 0 : prev + 1));
                        }}
                        className="absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full hover:bg-black/50"
                      >
                        â–¶
                      </button>
                      <div className="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1">
                        {allPreviewImages.map((_, idx) => (
                          <div 
                            key={idx} 
                            className={`w-2 h-2 rounded-full ${idx === currentSlideIndex ? 'bg-white' : 'bg-white/50'}`} 
                          />
                        ))}
                      </div>
                    </>
                  )}
                </>
              ) : (
                <div className="w-full h-full flex items-center justify-center text-gray-400">No Image</div>
              )}

              <span className="absolute top-2 left-2 bg-white/90 text-teal-800 text-xs font-bold px-2 py-1 rounded shadow">
                {category}
              </span>
              <span className="absolute top-2 right-2 bg-black/60 text-white text-xs font-bold px-2 py-1 rounded">
                {area}
              </span>
            </div>

            <div>
              <p className="text-gray-500 text-sm mb-1">{date.replaceAll('-', '/')}</p>
              
              {tags.length > 0 && (
                <div className="flex flex-wrap gap-2 mb-1">
                  {tags.map((tag, index) => (
                    <span key={index} className="text-sm text-gray-500 font-bold">
                      #{tag}
                    </span>
                  ))}
                </div>
              )}

              <h1 className="text-2xl font-bold text-gray-900 mb-4">{title}</h1>
              
              <div className="bg-gray-50 p-4 rounded-lg space-y-2 text-sm">
                <p><strong>ğŸ“ å ´æ‰€:</strong> {location || 'è©³ç´°ãªã—'}</p>
                <p><strong>ğŸ“ é€£çµ¡å…ˆ:</strong> {phone || 'è©³ç´°ãªã—'}</p>
              </div>

              <div className="mt-6 whitespace-pre-wrap text-gray-700 leading-relaxed">
                {description}
              </div>
            </div>
          </div>

          <div className="p-6 bg-gray-50 border-t flex flex-col md:flex-row gap-4">
             <button
              onClick={() => setIsPreview(false)}
              className="flex-1 bg-white border border-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-100 transition"
             >
               ä¿®æ­£ã™ã‚‹
             </button>
             <button
              onClick={handleSubmit}
              disabled={loading}
              className="flex-1 bg-teal-800 text-white py-3 rounded-lg font-bold hover:bg-teal-900 transition shadow-md"
             >
               {loading ? 'é€ä¿¡ä¸­...' : 'å…¬é–‹ã™ã‚‹'}
             </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 p-8">
      <div className="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow">
        <h1 className="text-2xl font-bold mb-6 text-teal-800 text-center">
          {copyFromId ? 'éå»ã®æŠ•ç¨¿ã‹ã‚‰ä½œæˆ' : 'æ–°è¦æŠ•ç¨¿'}
        </h1>
        
        {!isAdmin && remainingPosts !== null && (
          <div className={`mb-6 p-4 rounded-md text-sm border ${
            remainingPosts > 0 ? 'bg-blue-50 border-blue-200 text-blue-800' : 'bg-red-50 border-red-200 text-red-800 font-bold'
          }`}>
            {remainingPosts > 0 ? (
               <>æœ¬æ—¥ã‚ã¨ <span className="font-bold text-lg">{remainingPosts}</span> ä»¶æŠ•ç¨¿ã§ãã¾ã™ã€‚</>
            ) : (
               <>âš ï¸ æœ¬æ—¥ã®æŠ•ç¨¿ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚</>
            )}
          </div>
        )}
        
        {isSuperAdmin && (
           <div className="mb-6 bg-purple-50 text-purple-800 p-4 rounded-md text-sm border border-purple-200 font-bold">
             âš¡ ç‰¹æ¨©ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰: æ—¥ä»˜åˆ¶é™ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚
           </div>
        )}

        <form onSubmit={handlePreview} className="space-y-6">
          
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">
              æ´»å‹•å <span className="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded ml-2">å¿…é ˆ</span>
            </label>
            <input type="text" required value={title} onChange={(e) => setTitle(e.target.value)} className="mt-1 block w-full p-3 border border-gray-300 rounded-md" disabled={isLimitReached} />
          </div>

          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">
              ã‚«ãƒ†ã‚´ãƒª <span className="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded ml-2">å¿…é ˆ</span>
            </label>
            <select required value={category} onChange={(e) => setCategory(e.target.value)} className="mt-1 block w-full p-3 border border-gray-300 rounded-md bg-white" disabled={isLimitReached}>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              {CATEGORY_OPTIONS.map((opt) => <option key={opt} value={opt}>{opt}</option>)}
            </select>
          </div>

          {/* ã‚¿ã‚°è¨­å®šã‚¨ãƒªã‚¢ */}
          <div className="border border-gray-200 rounded-md p-4 bg-gray-50">
            <label className="block text-sm font-bold text-gray-700 mb-2">
              ã‚¿ã‚°è¨­å®š <span className="text-xs font-normal text-gray-500">ï¼ˆæœ€å¤§{MAX_TAGS}ã¤ã¾ã§ãƒ»æ¤œç´¢ã«ä½¿ã‚ã‚Œã¾ã™ï¼‰</span>
            </label>
            
            <div className="flex flex-wrap gap-2 mb-4 min-h-[30px]">
              {tags.map((tag, idx) => (
                <span key={idx} className="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1">
                  #{tag}
                  <button type="button" onClick={() => removeTag(tag)} className="hover:text-blue-200 ml-1">Ã—</button>
                </span>
              ))}
              {tags.length === 0 && <span className="text-sm text-gray-400 py-1">ã‚¿ã‚°ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</span>}
            </div>

            <div className="flex gap-2 mb-4">
              <input 
                type="text" 
                value={customTagInput} 
                onChange={(e) => setCustomTagInput(e.target.value)}
                onKeyDown={handleCustomTagAdd}
                placeholder="è‡ªç”±ã«å…¥åŠ›ã—ã¦è¿½åŠ " 
                className="flex-1 p-2 border border-gray-300 rounded text-sm"
                disabled={isLimitReached || isTagLimitReached}
              />
              <button 
                type="button" 
                onClick={handleCustomTagAdd}
                className="bg-gray-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-gray-700 disabled:opacity-50"
                disabled={isLimitReached || isTagLimitReached || !customTagInput.trim()}
              >
                è¿½åŠ 
              </button>
            </div>

            <div className="space-y-3">
              <div>
                <span className="text-xs font-bold text-gray-500 block mb-1">ã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚¿ã‚°:</span>
                <div className="flex flex-wrap gap-2">
                  {COMMON_TAGS.map(t => (
                    <button
                      key={t}
                      type="button"
                      onClick={() => addTag(t)}
                      disabled={isTagLimitReached || tags.includes(t)}
                      className={`text-xs px-2 py-1 rounded border ${tags.includes(t) ? 'bg-gray-200 text-gray-400 border-gray-200' : 'bg-white text-gray-700 border-gray-300 hover:bg-blue-50 hover:border-blue-300'}`}
                    >
                      {t}
                    </button>
                  ))}
                </div>
              </div>
              
              {category && CATEGORY_TAGS[category] && (
                <div>
                  <span className="text-xs font-bold text-gray-500 block mb-1">ã€Œ{category}ã€ã®ãŠã™ã™ã‚:</span>
                  <div className="flex flex-wrap gap-2">
                    {CATEGORY_TAGS[category].map(t => (
                      <button
                        key={t}
                        type="button"
                        onClick={() => addTag(t)}
                        disabled={isTagLimitReached || tags.includes(t)}
                        className={`text-xs px-2 py-1 rounded border ${tags.includes(t) ? 'bg-gray-200 text-gray-400 border-gray-200' : 'bg-white text-gray-700 border-gray-300 hover:bg-blue-50 hover:border-blue-300'}`}
                      >
                        {t}
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>

          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">
              åœ°åŸŸ <span className="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded ml-2">å¿…é ˆ</span>
            </label>
            <select required value={area} onChange={(e) => setArea(e.target.value)} className="mt-1 block w-full p-3 border border-gray-300 rounded-md bg-white" disabled={isLimitReached}>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              {AREA_OPTIONS.map((opt) => <option key={opt} value={opt}>{opt}</option>)}
            </select>
          </div>

          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">
              é–‹å‚¬æ—¥ {isSuperAdmin ? '(åˆ¶é™ãªã—)' : '(1ãƒ¶æœˆå…ˆã¾ã§)'} <span className="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded ml-2">å¿…é ˆ</span>
            </label>
            <input type="date" required min={isSuperAdmin ? undefined : todayStr} max={isSuperAdmin ? undefined : maxDateStr} value={date} onChange={(e) => setDate(e.target.value)} className={`mt-1 block w-full p-3 border rounded-md ${isSuperAdmin ? 'border-purple-300 bg-purple-50' : 'border-gray-300'}`} disabled={isLimitReached} />
          </div>

          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">æ´»å‹•ã®è©³ã—ã„å†…å®¹...</label>
            <textarea rows={6} value={description} onChange={(e) => setDescription(e.target.value)} className="mt-1 block w-full p-3 border border-gray-300 rounded-md" disabled={isLimitReached} />
          </div>

          {/* â–¼â–¼â–¼ å†™çœŸã‚¨ãƒªã‚¢ï¼ˆãƒ¡ã‚¤ãƒ³ + è¿½åŠ 2æšï¼‰ â–¼â–¼â–¼ */}
          <div className="border-t pt-6 border-dashed border-gray-300">
            <label className="block text-sm font-bold text-gray-700 mb-2">
              ãƒ¡ã‚¤ãƒ³å†™çœŸ <span className="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded ml-2">å¿…é ˆ</span>
            </label>
            
            {imageFile ? (
              <div className="mb-4 relative w-48 aspect-video bg-gray-100 rounded-lg overflow-hidden border">
                <img src={URL.createObjectURL(imageFile)} alt="Main" className="w-full h-full object-cover" />
                <button
                  type="button"
                  onClick={() => { setImageFile(null); setPreviewImageUrl(null); }}
                  className="absolute top-1 right-1 bg-black/50 text-white rounded-full p-1 hover:bg-black/70 transition"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
              </div>
            ) : (
              <div className="flex justify-start mb-4">
                <label className={`cursor-pointer text-white font-bold py-3 px-8 rounded-full shadow-md flex items-center gap-2 transition ${isLimitReached ? 'bg-gray-400 cursor-not-allowed' : 'bg-orange-400 hover:bg-orange-500'}`}>
                  <span>ğŸ“· ãƒ¡ã‚¤ãƒ³å†™çœŸã‚’é¸æŠ</span>
                  <input type="file" accept="image/*" onChange={handleImageSelect} className="hidden" disabled={isLimitReached} />
                </label>
              </div>
            )}

            <label className="block text-sm font-bold text-gray-700 mb-2 mt-6">
              è¿½åŠ å†™çœŸ <span className="text-gray-400 text-xs font-normal">ï¼ˆä»»æ„ãƒ»æœ€å¤§2æšï¼‰</span>
            </label>
            
            <div className="flex flex-wrap gap-4">
              {additionalImages.map((img, idx) => (
                <div key={idx} className="relative w-32 aspect-video bg-gray-100 rounded-lg overflow-hidden border">
                  <img src={URL.createObjectURL(img)} alt={`Sub ${idx}`} className="w-full h-full object-cover" />
                  <button
                    type="button"
                    onClick={() => removeAdditionalImage(idx)}
                    className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600 transition"
                  >
                    Ã—
                  </button>
                </div>
              ))}

              {!isAdditionalImageLimitReached && (
                <label className={`cursor-pointer w-32 aspect-video bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:bg-gray-50 hover:border-blue-400 transition ${isLimitReached ? 'opacity-50 cursor-not-allowed' : ''}`}>
                  <span className="text-2xl">+</span>
                  <span className="text-xs font-bold">è¿½åŠ ã™ã‚‹</span>
                  <input 
                    type="file" 
                    accept="image/*" 
                    onChange={handleAdditionalImageSelect} 
                    className="hidden" 
                    disabled={isLimitReached} 
                  />
                </label>
              )}
            </div>
          </div>
          {/* â–²â–²â–² å†™çœŸã‚¨ãƒªã‚¢çµ‚äº† â–²â–²â–² */}

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">è©³ã—ã„å ´æ‰€</label>
              <input type="text" value={location} onChange={(e) => setLocation(e.target.value)} className="mt-1 block w-full p-2 border border-gray-300 rounded-md" disabled={isLimitReached} />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">é›»è©±ç•ªå·</label>
              <input type="tel" value={phone} onChange={(e) => setPhone(e.target.value)} className="mt-1 block w-full p-2 border border-gray-300 rounded-md" disabled={isLimitReached} />
            </div>
          </div>

          <div className="flex flex-col gap-4 pt-4">
            <button type="submit" disabled={loading || isLimitReached} className="w-full bg-teal-800 text-white py-3 px-4 rounded-md hover:bg-teal-900 font-bold shadow-lg">
              ç¢ºèªç”»é¢ã¸é€²ã‚€
            </button>
            <Link href="/admin" className="text-center text-gray-500 hover:text-gray-700 underline">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</Link>
          </div>
          
          <div className="pt-8 border-t mt-8 text-center text-xs text-gray-500">
             æŠ•ç¨¿ã™ã‚‹ã“ã¨ã§ã€<Link href="/terms" target="_blank" className="text-blue-600 underline">åˆ©ç”¨è¦ç´„</Link>ãŠã‚ˆã³<Link href="/privacy" target="_blank" className="text-blue-600 underline">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</Link>ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã•ã‚Œã¾ã™ã€‚
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="app/events/[id]/page.tsx">
import { supabase } from '@/lib/supabaseClient';
import Link from 'next/link';
import { notFound } from 'next/navigation';
import { formatDate } from '@/lib/utils';
import AccessibilityMenu from '@/app/components/AccessibilityMenu';
import ViewCounter from '@/app/components/ViewCounter';
import ReportButton from '@/app/components/ReportButton';
import ImageCarousel from '@/app/components/ImageCarousel'; // â˜…è¿½åŠ 

export const runtime = 'edge';
export const revalidate = 0;

type Event = {
  id: number;
  title: string;
  description: string | null;
  event_date: string;
  location: string | null;
  category: string | null;
  contact_phone: string | null;
  image_url: string | null;
  additional_images: string[] | null; // â˜…è¿½åŠ 
  tags: string[] | null;
  profiles: {
    name: string | null;
    avatar_url: string | null;
    website_url: string | null;
  } | null;
};

async function getEvent(id: string) {
  const { data, error } = await supabase
    .from('events')
    .select(`
      *,
      profiles ( name, avatar_url, website_url )
    `)
    .eq('id', id)
    .single();

  if (error) {
    console.error(error);
    return null;
  }
  return data as unknown as Event;
}

export default async function EventDetailPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const event = await getEvent(id);

  if (!event) return notFound();

  const posterName = event.profiles?.name || 'ä¸»å‚¬è€…ä¸æ˜';
  const posterIcon = event.profiles?.avatar_url;
  const posterUrl = event.profiles?.website_url;

  // ç”»åƒãƒªã‚¹ãƒˆã®ä½œæˆï¼ˆãƒ¡ã‚¤ãƒ³ç”»åƒ + è¿½åŠ ç”»åƒï¼‰
  const allImages = [
    event.image_url,
    ...(event.additional_images || [])
  ].filter((img): img is string => !!img);

  // èª­ã¿ä¸Šã’ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
  const spokenDate = new Date(event.event_date).toLocaleDateString('ja-JP', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    weekday: 'long'
  });

  const readingText = `
    ã‚¤ãƒ™ãƒ³ãƒˆåã€${event.title}ã€‚
    ã‚«ãƒ†ã‚´ãƒªã€${event.category || 'ãªã—'}ã€‚
    é–‹å‚¬æ—¥ã€${spokenDate}ã€‚
    å ´æ‰€ã€${event.location || 'æœªå®š'}ã€‚
    å†…å®¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚${event.description || 'è©³ç´°ã¯ã‚ã‚Šã¾ã›ã‚“'}ã€‚
    ä¸»å‚¬ã¯ã€${posterName}ã§ã™ã€‚
  `;

  return (
    <main className="min-h-screen bg-white pb-20 font-sans">
      
      {/* ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—å‡¦ç† */}
      <ViewCounter eventId={event.id} />
      
      {/* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
      <AccessibilityMenu textToRead={readingText} />

      <div className="p-4 bg-gray-100 border-b sticky top-0 z-10">
        <Link href="/" className="inline-flex items-center text-sm font-bold text-slate-600 py-2 px-4 border border-slate-300 rounded-full bg-white hover:bg-slate-50 transition-colors">
          â† ã‚‚ã©ã‚‹
        </Link>
      </div>

      <div className="max-w-2xl mx-auto">
        
        {/* â˜…ä¿®æ­£: ç”»åƒã‚«ãƒ«ãƒ¼ã‚»ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ */}
        <ImageCarousel images={allImages} alt={event.title} />

        <div className="p-6 space-y-8">
              {/* ä¸»å‚¬è€…æƒ…å ± & HPãƒªãƒ³ã‚¯ */}
              <div className="flex items-center gap-4 border-b pb-6">
                  <div className="w-14 h-14 rounded-full bg-gray-200 overflow-hidden border border-gray-300 flex-shrink-0">
                    {posterIcon ? (
                      <img src={posterIcon} alt={posterName} className="w-full h-full object-cover" />
                    ) : (
                      <svg className="w-full h-full text-gray-500 p-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                      </svg>
                    )}
                  </div>
                  <div>
                    <p className="text-xs text-gray-500 font-bold mb-0.5">æŠ•ç¨¿ãƒ»ä¸»å‚¬</p>
                    <p className="text-lg font-bold text-gray-900 leading-tight">{posterName}</p>
                    
                    {posterUrl && (
                      <a 
                        href={posterUrl} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="inline-flex items-center gap-1 text-sm font-bold text-blue-600 hover:text-blue-800 hover:underline mt-1"
                      >
                        ã“ã®å›£ä½“ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¯ã“ã¡ã‚‰
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                      </a>
                    )}
                  </div>
              </div>

              <div>
                {/* ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤º */}
                <div className="flex flex-wrap items-center gap-2 mb-3">
                  {event.category && (
                    <span className="inline-block bg-teal-600 text-white text-sm font-bold px-3 py-1 rounded-full shadow-sm">
                      {event.category}
                    </span>
                  )}
                </div>

                {/* ã‚¿ã‚°è¡¨ç¤º */}
                {event.tags && event.tags.length > 0 && (
                  <div className="flex flex-wrap gap-2 mb-2">
                    {event.tags.map((tag, index) => (
                      <span key={index} className="text-sm font-bold text-gray-500">
                        #{tag}
                      </span>
                    ))}
                  </div>
                )}

                <h1 className="text-3xl font-extrabold text-gray-900 leading-tight tracking-tight">
                  {event.title}
                </h1>
              </div>

              <div className="space-y-6 text-xl">
                <div>
                  <span className="text-gray-500 text-xs font-bold block mb-1">é–‹å‚¬æ—¥</span>
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">ğŸ“…</span>
                    <span className="font-bold text-2xl text-gray-800">{formatDate(event.event_date)}</span>
                  </div>
                </div>
                
                <div className="bg-gray-50 rounded-2xl p-6 border border-gray-100">
                  <span className="text-gray-500 text-xs font-bold block mb-3">é–‹å‚¬å ´æ‰€</span>
                  <div className="flex flex-col gap-4">
                    <div>
                        <div className="flex items-start gap-2 mb-2">
                          <span className="text-2xl mt-0.5">ğŸ“</span>
                          <p className="font-bold text-2xl text-gray-800 leading-tight">{event.location || 'æœªå®š'}</p>
                        </div>
                        
                        {event.location && (
                          <a 
                            href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.location)}`}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-sm font-bold text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1 ml-9"
                          >
                            Googleãƒãƒƒãƒ—ã‚¢ãƒ—ãƒªã§è¦‹ã‚‹
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                          </a>
                        )}
                    </div>

                    {event.location && (
                      <div className="w-full h-64 bg-gray-200 rounded-xl overflow-hidden border border-gray-300 shadow-sm relative">
                        <iframe
                          width="100%"
                          height="100%"
                          style={{ border: 0 }}
                          loading="lazy"
                          allowFullScreen
                          src={`https://maps.google.com/maps?q=${encodeURIComponent(event.location)}&output=embed`}
                          title="Google Map"
                        ></iframe>
                      </div>
                    )}
                  </div>
                </div>

                {event.contact_phone && (
                  <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <span className="text-blue-800 text-xs font-bold block mb-1">ãŠå•ã„åˆã‚ã›é›»è©±ç•ªå·</span>
                    <span className="font-bold text-2xl text-slate-800">{event.contact_phone}</span>
                  </div>
                )}

                <div className="mt-8 pt-8 border-t border-gray-200">
                  <span className="text-gray-500 text-xs font-bold block mb-4">ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°</span>
                  <p className="whitespace-pre-wrap leading-loose text-base text-gray-700 font-medium">
                    {event.description}
                  </p>
                </div>

                {/* é€šå ±ãƒœã‚¿ãƒ³ */}
                <div className="mt-12 flex justify-center">
                  <ReportButton eventId={event.id} />
                </div>

              </div>
        </div>
      </div>
    </main>
  );
}
</file>

<file path="package.json">
{
  "name": "hamamatsu-events",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "pages:build": "npx @cloudflare/next-on-pages@1"
  },
  "dependencies": {
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.47.0",
    "browser-image-compression": "^2.0.2",
    "driver.js": "^1.4.0",
    "next": "15.1.0",
    "qrcode.react": "^4.2.0",
    "react": "19.0.0",
    "react-dom": "19.0.0"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.20",
    "eslint": "^9",
    "eslint-config-next": "15.1.0",
    "postcss": "^8.4.49",
    "tailwindcss": "^3.4.17",
    "typescript": "^5"
  }
}
</file>

<file path="app/admin/page.tsx">
'use client';

import Link from 'next/link';
import { formatDate } from '@/lib/utils';
import { QRCodeSVG } from 'qrcode.react';
import Tutorial from '@/app/components/Tutorial';
import { useAdminDashboard, Event } from '@/app/hooks/useAdminDashboard';

export default function AdminDashboard() {
  const {
    events, messages, applications, reports, loading, myProfile, inviteUrl, currentUserId,
    // â˜…è¿½åŠ : ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é–¢é€£
    isMaintenance, toggleMaintenance,
    showQrCode, setShowQrCode, showMailMenu, setShowMailMenu, showMessages, setShowMessages,
    showApplications, setShowApplications, showReports, setShowReports, runTutorial, setRunTutorial,
    mailMenuRef, applicationPanelRef, reportPanelRef,
    handleLogout, markAsRead, deleteMessage, deleteReport, handleDelete, handleToggleHidden, handleApprove, handleReject, handleTutorialClose
  } = useAdminDashboard();

  if (loading) return <div className="p-10 text-center">èª­ã¿è¾¼ã¿ä¸­...</div>;

  const hasAdminPrivileges = ['admin', 'super_admin'].includes(myProfile?.role || '');
  const isSuperAdmin = myProfile?.role === 'super_admin';
  const unreadCount = messages.filter(m => !m.is_read).length;
  const pendingAppsCount = applications.length;
  const reportsCount = reports.length;

  const splitEventsByDate = (list: Event[]) => {
    const today = new Date().toISOString().split('T')[0];
    return {
      upcoming: list.filter(e => e.event_date >= today),
      past: list.filter(e => e.event_date < today)
    };
  };

  const myEvents = hasAdminPrivileges ? events.filter(e => e.poster_id === currentUserId) : events;
  const { upcoming: myUpcoming, past: myPast } = splitEventsByDate(myEvents);

  const otherEvents = hasAdminPrivileges ? events.filter(e => e.poster_id !== currentUserId) : [];
  const groupedOtherEvents: Record<string, Event[]> = {};
  otherEvents.forEach(e => {
    const name = e.profiles?.name || 'ä¸æ˜';
    if (!groupedOtherEvents[name]) groupedOtherEvents[name] = [];
    groupedOtherEvents[name].push(e);
  });

  return (
    <div className="min-h-screen bg-gray-50 p-4 md:p-8">
      <Tutorial run={runTutorial} onClose={handleTutorialClose} isAdmin={hasAdminPrivileges} />

      <div className="max-w-4xl mx-auto">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ */}
        <div id="tutorial-header" className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 bg-white p-4 md:p-6 rounded-xl shadow-sm relative z-20">
          <div className="flex items-center gap-4 w-full md:w-auto">
            <div className="w-12 h-12 md:w-16 md:h-16 rounded-full bg-gray-200 overflow-hidden border border-gray-300 flex-shrink-0">
              {myProfile?.avatar_url ? (
                <img src={myProfile.avatar_url} alt="Icon" className="w-full h-full object-cover" />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-gray-400 font-bold text-xs">No Img</div>
              )}
            </div>
            <div className="flex-1">
              <div className="flex flex-wrap items-center gap-2">
                <h1 className="text-xl md:text-2xl font-bold">ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
                <Link href="/" className="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded hover:bg-blue-100 flex items-center gap-1 border border-blue-200">
                  <span>ğŸ </span> ãƒ›ãƒ¼ãƒ 
                </Link>
                <button onClick={() => setRunTutorial(true)} className="text-xs text-gray-400 underline hover:text-gray-600">? ãƒ˜ãƒ«ãƒ—</button>
              </div>
              <p className="text-gray-600 font-medium text-sm md:text-base mt-1">
                {myProfile?.name || 'åç„¡ã—'} ã•ã‚“
                {hasAdminPrivileges && <span className="ml-2 text-xs bg-red-100 text-red-600 px-2 py-1 rounded">ç®¡ç†è€…</span>}
              </p>
            </div>
          </div>

          <div className="flex flex-wrap items-center gap-2 md:gap-4 w-full md:w-auto justify-end">
            {hasAdminPrivileges && (
              <>
                {/* é€šå ±ãƒœã‚¿ãƒ³ */}
                <div className="relative" ref={reportPanelRef} id="tutorial-report">
                  <button onClick={() => setShowReports(!showReports)} className="relative px-3 py-2 text-red-700 font-bold hover:bg-red-50 rounded-lg border border-red-200 text-sm flex items-center gap-2">
                    <span>âš ï¸ é€šå ±</span>
                    {reportsCount > 0 && <span className="px-1.5 py-0.5 text-xs text-white bg-red-600 rounded-full animate-pulse">{reportsCount}</span>}
                  </button>
                  {showReports && (
                    <div className="absolute right-0 top-full mt-2 w-80 bg-white rounded-lg shadow-xl border border-red-200 overflow-hidden z-50 max-h-96 overflow-y-auto">
                      {reports.length === 0 ? <div className="p-4 text-center text-gray-500 text-sm">ãªã—</div> : (
                        reports.map(r => (
                          <div key={r.id} className="p-3 border-b hover:bg-gray-50">
                            <p className="text-xs font-bold text-red-800">{r.reason}</p>
                            <p className="text-xs text-gray-500 mt-1">å¯¾è±¡: {r.events?.title || 'å‰Šé™¤æ¸ˆ'}</p>
                            <button onClick={() => deleteReport(r.id)} className="text-xs text-red-600 underline mt-2">å¯¾å¿œæ¸ˆã¨ã—ã¦å‰Šé™¤</button>
                          </div>
                        ))
                      )}
                    </div>
                  )}
                </div>

                {/* ç”³è«‹ãƒœã‚¿ãƒ³ */}
                <div className="relative" ref={applicationPanelRef} id="tutorial-application">
                  <button onClick={() => setShowApplications(!showApplications)} className="relative px-3 py-2 text-orange-700 font-bold hover:bg-orange-50 rounded-lg border border-orange-200 text-sm flex items-center gap-2">
                    <span>æ–°è¦ç”³è«‹</span>
                    {pendingAppsCount > 0 && <span className="px-1.5 py-0.5 text-xs text-white bg-red-600 rounded-full animate-pulse">{pendingAppsCount}</span>}
                  </button>
                  {showApplications && (
                    <div className="absolute right-0 top-full mt-2 w-96 bg-white rounded-lg shadow-xl border border-orange-200 overflow-hidden z-50 max-h-96 overflow-y-auto">
                      {applications.length === 0 ? <div className="p-4 text-center text-gray-500 text-sm">ãªã—</div> : (
                        applications.map(app => (
                          <div key={app.id} className="p-4 border-b hover:bg-gray-50">
                            <h4 className="font-bold text-sm">{app.organization_name}</h4>
                            <p className="text-xs text-gray-500 mb-2">{app.activity_details}</p>
                            <div className="flex gap-2 justify-end">
                              <button onClick={() => handleReject(app.id, app.email, app.organization_name)} className="px-2 py-1 text-xs border rounded">å´ä¸‹</button>
                              <button onClick={() => handleApprove(app)} className="px-2 py-1 text-xs bg-orange-500 text-white rounded font-bold">æ‰¿èª</button>
                            </div>
                          </div>
                        ))
                      )}
                    </div>
                  )}
                </div>
              </>
            )}

            {/* ãƒ¡ãƒ¼ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
            <div className="relative" ref={mailMenuRef} id="tutorial-mail">
              <button onClick={() => setShowMailMenu(!showMailMenu)} className="relative p-2 text-gray-500 hover:bg-gray-100 rounded-full">
                <span className="text-xl">ğŸ“©</span>
                {unreadCount > 0 && <span className="absolute top-0 right-0 bg-red-600 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">{unreadCount}</span>}
              </button>
              {showMailMenu && (
                <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border z-50">
                  <button onClick={() => { setShowMailMenu(false); setShowMessages(true); }} className="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex justify-between">
                    <span>ğŸ“¥ å—ä¿¡ç®±</span>
                    {unreadCount > 0 && <span className="bg-red-100 text-red-600 text-xs px-2 rounded-full">{unreadCount}</span>}
                  </button>
                  <Link href="/admin/messages" className="block px-4 py-2 text-sm hover:bg-gray-100">ğŸ“¤ ä½œæˆ</Link>
                </div>
              )}
              {showMessages && (
                <>
                  <div className="fixed inset-0 bg-black/20 z-40" onClick={() => setShowMessages(false)} />
                  <div className="fixed top-20 right-4 w-96 bg-white rounded-lg shadow-xl z-50 max-h-[70vh] overflow-y-auto border">
                    <div className="p-3 bg-gray-50 border-b flex justify-between font-bold text-sm">
                      <span>ãŠçŸ¥ã‚‰ã›</span>
                      <button onClick={() => setShowMessages(false)}>âœ•</button>
                    </div>
                    {messages.length === 0 ? <div className="p-4 text-center text-sm text-gray-500">ãªã—</div> : (
                      messages.map(msg => (
                        <div key={msg.id} className={`p-4 border-b ${!msg.is_read ? 'bg-yellow-50' : ''}`}>
                          <div className="flex justify-between text-xs text-gray-500 mb-1">
                            <span className="font-bold">{msg.sender?.name || 'ç®¡ç†è€…'}</span>
                            <span>{formatDate(msg.created_at)}</span>
                          </div>
                          <p className="text-sm mb-2">{msg.content}</p>
                          <div className="flex justify-end gap-3">
                            {!msg.is_read && <button onClick={() => markAsRead(msg.id)} className="text-xs text-blue-600 font-bold">æ—¢èª­ã«ã™ã‚‹</button>}
                            <button onClick={() => deleteMessage(msg.id)} className="text-xs text-gray-400 hover:text-red-600">å‰Šé™¤</button>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </>
              )}
            </div>

            <Link href="/admin/profile" id="tutorial-profile" className="text-sm font-bold text-gray-600 border px-3 py-2 rounded-lg hover:bg-gray-100 bg-white">
              âš™ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
            </Link>
            <button onClick={handleLogout} className="text-xs text-red-600 underline">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          </div>
        </div>

        {/* â˜…è¿½åŠ : ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹åˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒï¼ˆç‰¹æ¨©ç®¡ç†è€…ã®ã¿ï¼‰ */}
        {isSuperAdmin && (
          <div className={`mb-8 p-4 rounded-xl border flex items-center justify-between shadow-sm transition-colors ${isMaintenance ? 'bg-orange-100 border-orange-300' : 'bg-white border-gray-200'}`}>
            <div>
              <h3 className="font-bold text-gray-800 flex items-center gap-2">
                {isMaintenance ? 'ğŸš§ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰: ON' : 'ğŸŸ¢ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰: OFF'}
              </h3>
              <p className="text-xs text-gray-600 mt-1">
                {isMaintenance 
                  ? 'ç¾åœ¨ã€é–²è¦§è€…ã«ã¯ã€Œãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­ã€ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚' 
                  : 'é€šå¸¸é€šã‚Šå…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚'}
              </p>
            </div>
            <button
              onClick={toggleMaintenance}
              className={`px-4 py-2 rounded-lg font-bold text-sm shadow ${
                isMaintenance 
                  ? 'bg-white text-orange-600 border border-orange-300 hover:bg-orange-50' 
                  : 'bg-gray-800 text-white hover:bg-gray-700'
              }`}
            >
              {isMaintenance ? 'è§£é™¤ã™ã‚‹' : 'ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã«ã™ã‚‹'}
            </button>
          </div>
        )}

        {/* QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ */}
        {hasAdminPrivileges && (
          <div className="mb-6">
            <button onClick={() => setShowQrCode(!showQrCode)} className="w-full md:w-auto flex items-center gap-2 text-teal-700 font-bold border border-teal-300 bg-teal-50 px-4 py-3 rounded-lg hover:bg-teal-100 shadow-sm">
              <span className="text-xl">ğŸŸï¸</span> {showQrCode ? 'æ‹›å¾…QRã‚’éš ã™' : 'æ‰‹å‹•æ‹›å¾…ç”¨QRã‚’è¡¨ç¤º'}
            </button>
            {showQrCode && (
              <div className="mt-4 bg-white p-6 rounded-xl shadow border border-teal-200 flex flex-col md:flex-row items-center gap-6">
                <div className="p-2 border rounded">{inviteUrl && <QRCodeSVG value={inviteUrl} size={150} />}</div>
                <div className="flex-1">
                  <h3 className="font-bold text-teal-800">æ‰‹å‹•æ‹›å¾…ç”¨QRã‚³ãƒ¼ãƒ‰</h3>
                  <p className="text-sm text-gray-600 mt-2 break-all font-mono bg-gray-100 p-2 rounded">{inviteUrl}</p>
                </div>
              </div>
            )}
          </div>
        )}

        <Link href="/admin/create" id="tutorial-create-btn" className="block w-full md:w-auto text-center bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-blue-700 mb-8">
          + æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œã‚‹
        </Link>

        {/* ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆ */}
        {hasAdminPrivileges ? (
          <div className="space-y-10">
            {/* è‡ªåˆ†ã®æŠ•ç¨¿ */}
            <div className="bg-white rounded-lg shadow overflow-hidden border-2 border-blue-100">
              <div className="bg-blue-50 px-4 py-3 border-b border-blue-200">
                <h3 className="font-bold text-blue-800 text-sm">ğŸ“Œ ã‚ãªãŸã®æŠ•ç¨¿</h3>
              </div>
              <EventTable events={myUpcoming} onDelete={handleDelete} onToggleHidden={handleToggleHidden} isSuperAdmin={isSuperAdmin} emptyMessage="é–‹å‚¬äºˆå®šã®æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚" />
              {myPast.length > 0 && (
                <details className="group border-t border-gray-100">
                  <summary className="cursor-pointer bg-gray-50 px-4 py-3 text-sm font-bold text-gray-500 flex items-center gap-2">
                    <span className="group-open:rotate-90 transition-transform">â–¶</span> çµ‚äº†ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ ({myPast.length})
                  </summary>
                  <EventTable events={myPast} onDelete={handleDelete} onToggleHidden={handleToggleHidden} isSuperAdmin={isSuperAdmin} />
                </details>
              )}
            </div>

            {/* ä»–ã®å›£ä½“ã®æŠ•ç¨¿ */}
            {Object.keys(groupedOtherEvents).length > 0 && (
              <div className="space-y-6">
                <h2 className="text-lg md:text-xl font-bold text-gray-700 pl-2 border-l-4 border-gray-400">ä»–ã®å›£ä½“ã®æŠ•ç¨¿</h2>
                {Object.entries(groupedOtherEvents).map(([name, list]) => {
                  const { upcoming, past } = splitEventsByDate(list);
                  return (
                    <div key={name} className="bg-white rounded-lg shadow overflow-hidden">
                      <div className="bg-gray-100 px-4 py-3 border-b"><h3 className="font-bold text-gray-700 text-sm">ğŸ“‚ {name}</h3></div>
                      <EventTable events={upcoming} onDelete={handleDelete} onToggleHidden={handleToggleHidden} isSuperAdmin={isSuperAdmin} emptyMessage="äºˆå®šãªã—" />
                      {past.length > 0 && (
                         <details className="group border-t border-gray-100">
                           <summary className="cursor-pointer bg-gray-50 px-4 py-2 text-xs font-bold text-gray-500 flex gap-2"><span className="group-open:rotate-90 transition-transform">â–¶</span> çµ‚äº†åˆ† ({past.length})</summary>
                           <EventTable events={past} onDelete={handleDelete} onToggleHidden={handleToggleHidden} isSuperAdmin={isSuperAdmin} />
                         </details>
                      )}
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        ) : (
          /* ä¸€èˆ¬æŠ•ç¨¿è€…ç”¨ */
          <div className="bg-white rounded-lg shadow overflow-hidden">
            <div className="bg-teal-50 px-4 py-3 border-b border-teal-100"><h3 className="font-bold text-teal-800 text-sm">é–‹å‚¬äºˆå®šãƒ»é–‹å‚¬ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆ</h3></div>
            <EventTable events={myUpcoming} onDelete={handleDelete} onToggleHidden={handleToggleHidden} isSuperAdmin={isSuperAdmin} emptyMessage="æ²è¼‰ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚" />
            {myPast.length > 0 && (
              <details className="group border-t border-gray-200">
                <summary className="cursor-pointer bg-gray-100 px-4 py-3 text-sm font-bold text-gray-500 flex gap-2"><span className="group-open:rotate-90 transition-transform">â–¶</span> çµ‚äº†ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ ({myPast.length})</summary>
                <div className="bg-gray-50"><EventTable events={myPast} onDelete={handleDelete} onToggleHidden={handleToggleHidden} isSuperAdmin={isSuperAdmin} /></div>
              </details>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

// ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
function EventTable({ events, onDelete, onToggleHidden, isSuperAdmin, emptyMessage = "æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“" }: { 
  events: Event[], 
  onDelete: (id: number, poster_id?: string, title?: string) => void, 
  onToggleHidden: (id: number, current: boolean, poster_id?: string, title?: string) => void,
  isSuperAdmin: boolean,
  emptyMessage?: string 
}) {
  if (events.length === 0) return <div className="p-6 text-center text-gray-400 text-sm">{emptyMessage}</div>;

  return (
    <div className="w-full">
      <div className="hidden md:grid grid-cols-12 bg-gray-50 px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
        <div className="col-span-2">é–‹å‚¬æ—¥</div>
        <div className="col-span-5">ã‚¤ãƒ™ãƒ³ãƒˆå</div>
        <div className="col-span-1 text-center">é–²è¦§æ•°</div>
        <div className="col-span-4 text-right">æ“ä½œ</div>
      </div>
      <div className="divide-y divide-gray-200">
        {events.map((event) => (
          <div key={event.id} className={`p-4 md:px-6 md:py-4 ${event.is_hidden ? "bg-gray-100" : "bg-white"}`}>
            {/* ã‚¹ãƒãƒ› */}
            <div className="md:hidden">
              <div className="flex justify-between items-start mb-2">
                <span className="text-sm text-gray-500 font-mono">{event.event_date}</span>
                {event.is_hidden && <span className="px-2 py-0.5 rounded text-xs font-medium bg-gray-500 text-white">éè¡¨ç¤ºä¸­</span>}
              </div>
              <Link href={`/admin/edit/${event.id}`} className={`block text-base font-bold mb-2 ${event.is_hidden ? 'text-gray-500' : 'text-gray-900'}`}>{event.title}</Link>
              <div className="flex flex-wrap gap-2 mb-3">
                {event.category && <span className="px-2 py-0.5 text-xs bg-teal-50 text-teal-700 rounded border border-teal-100">{event.category}</span>}
                <span className="text-xs text-gray-500">é–²è¦§æ•°: <span className="font-bold">{event.view_count || 0}</span></span>
              </div>
              <div className="flex flex-wrap gap-3 mt-3 pt-3 border-t border-gray-100">
                {isSuperAdmin && <button onClick={() => onToggleHidden(event.id, event.is_hidden, event.poster_id, event.title)} className={`text-xs font-bold ${event.is_hidden ? 'text-blue-600' : 'text-gray-400'}`}>{event.is_hidden ? 'å…¬é–‹ã™ã‚‹' : 'éå…¬é–‹'}</button>}
                <Link href={`/events/${event.id}`} target="_blank" className="text-xs text-gray-500 font-bold">ç¢ºèª</Link>
                <Link href={`/admin/create?copy_from=${event.id}`} className="text-xs text-teal-600 font-bold">ã‚³ãƒ”ãƒ¼</Link>
                <Link href={`/admin/edit/${event.id}`} className="text-xs text-indigo-600 font-bold">ç·¨é›†</Link>
                <button onClick={() => onDelete(event.id, event.poster_id, event.title)} className="text-xs text-red-600">å‰Šé™¤</button>
              </div>
            </div>
            {/* PC */}
            <div className="hidden md:grid grid-cols-12 items-center">
              <div className="col-span-2 text-sm text-gray-500">{event.event_date}{event.is_hidden && <span className="ml-2 px-2 py-0.5 rounded text-xs bg-gray-500 text-white">éè¡¨ç¤º</span>}</div>
              <div className="col-span-5">
                <Link href={`/admin/edit/${event.id}`} className={`text-sm font-medium hover:underline ${event.is_hidden ? 'text-gray-500' : 'text-gray-900'}`}>{event.title}</Link>
                {event.category && <span className="ml-2 px-2 py-0.5 text-xs bg-teal-50 text-teal-700 rounded border border-teal-100">{event.category}</span>}
              </div>
              <div className="col-span-1 text-center text-sm font-bold text-gray-600">{event.view_count || 0}</div>
              <div className="col-span-4 text-right text-sm font-medium flex justify-end items-center gap-4">
                {isSuperAdmin && <button onClick={() => onToggleHidden(event.id, event.is_hidden, event.poster_id, event.title)} className={`${event.is_hidden ? 'text-blue-600' : 'text-gray-400'} whitespace-nowrap`}>{event.is_hidden ? 'å…¬é–‹' : 'éå…¬é–‹'}</button>}
                <Link href={`/events/${event.id}`} target="_blank" className="text-gray-500 hover:text-gray-900 whitespace-nowrap">ç¢ºèª</Link>
                <Link href={`/admin/create?copy_from=${event.id}`} className="text-teal-600 hover:text-teal-900 whitespace-nowrap">ã‚³ãƒ”ãƒ¼</Link>
                <Link href={`/admin/edit/${event.id}`} className="text-indigo-600 hover:text-indigo-900 whitespace-nowrap">ç·¨é›†</Link>
                <button onClick={() => onDelete(event.id, event.poster_id, event.title)} className="text-red-600 hover:text-red-900 whitespace-nowrap">å‰Šé™¤</button>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="app/page.tsx">
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import Link from 'next/link';
import EventList from '@/app/components/EventList';
import Maintenance from '@/app/components/Maintenance';
import FilterBar from '@/app/components/FilterBar'; // è¿½åŠ 

export const revalidate = 0;
export const dynamic = 'force-dynamic';
export const runtime = 'edge';

const PER_PAGE = 10;

// â–¼â–¼ å®šæ•°å®šç¾©ï¼ˆæ¤œç´¢ç”¨ï¼‰ â–¼â–¼
const CATEGORY_OPTIONS = [
  "ãŠç¥­ã‚Šãƒ»ãƒãƒ«ã‚·ã‚§",
  "éŸ³æ¥½ãƒ»ãƒ©ã‚¤ãƒ–",
  "ã‚¹ãƒãƒ¼ãƒ„ãƒ»é‹å‹•",
  "å­¦ã³ãƒ»è¬›åº§",
  "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢",
  "å­è‚²ã¦ãƒ»å­ä¾›å‘ã‘",
  "å±•ç¤ºãƒ»èŠ¸è¡“",
  "ãã®ä»–"
];

const AREA_OPTIONS = [
  "ä¸­å¤®åŒºï¼ˆæ—§ä¸­åŒºï¼‰",
  "ä¸­å¤®åŒºï¼ˆæ—§æ±åŒºï¼‰",
  "ä¸­å¤®åŒºï¼ˆæ—§è¥¿åŒºï¼‰",
  "ä¸­å¤®åŒºï¼ˆæ—§å—åŒºï¼‰",
  "ä¸­å¤®åŒºï¼ˆæ—§åŒ—åŒºãƒ»ä¸‰æ–¹åŸï¼‰",
  "æµœååŒºï¼ˆæ—§æµœåŒ—åŒºï¼‰",
  "æµœååŒºï¼ˆæ—§åŒ—åŒºï¼‰",
  "å¤©ç«œåŒºï¼ˆæ—§å¤©ç«œåŒºï¼‰"
];

type Event = {
  id: number;
  title: string;
  event_date: string;
  location: string | null;
  area: string | null;
  category: string | null;
  image_url: string | null;
  tags: string[] | null;
  profiles: {
    name: string | null;
    avatar_url: string | null;
  } | null;
};

type EventsResult = {
  events: Event[];
  total: number | null;
};

// æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‹å®šç¾©
type SearchParams = {
  page?: string;
  category?: string;
  area?: string;
  q?: string;
  rain?: string; // è¿½åŠ : é›¨ã§ã‚‚OKãƒ•ã‚£ãƒ«ã‚¿
  sort?: string; // è¿½åŠ : ä¸¦ã³æ›¿ãˆ
};

async function checkMaintenance(supabase: SupabaseClient) {
  const { data } = await supabase
    .from('system_settings')
    .select('value')
    .eq('key', 'maintenance_mode')
    .single();
  
  return data?.value === 'true';
}

// â–¼â–¼ æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ„ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•° â–¼â–¼
async function getEvents(params: SearchParams): Promise<EventsResult> {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
  const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

  if (!supabaseUrl || !supabaseKey) {
    return { events: [], total: 0 };
  }

  const supabase = createClient(supabaseUrl, supabaseKey);

  const page = params.page ? parseInt(params.page) : 1;
  const from = (page - 1) * PER_PAGE;
  const to = from + PER_PAGE - 1;

  const today = new Date().toISOString().split('T')[0];
  const twoWeeksLater = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

  let query = supabase
    .from('events')
    .select(`
      id, title, event_date, location, area, category, image_url, tags, created_at,
      profiles ( name, avatar_url ) 
    `, { count: 'exact' })
    .eq('is_hidden', false) 
    .gte('event_date', today);

  // 1. ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢
  if (params.category) {
    query = query.eq('category', params.category);
  }

  // 2. ã‚¨ãƒªã‚¢æ¤œç´¢
  if (params.area) {
    query = query.eq('area', params.area);
  }

  // 3. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ« OR ã‚¿ã‚°ï¼‰
  if (params.q) {
    query = query.or(`title.ilike.%${params.q}%,tags.cs.{${params.q}}`);
  }

  // 4. é›¨ã§ã‚‚OKæ¤œç´¢ï¼ˆã‚¿ã‚°ã«ã€Œé›¨ã§ã‚‚OKã€ãŒå«ã¾ã‚Œã‚‹ã‹ï¼‰
  if (params.rain === 'true') {
    // tagsé…åˆ—ãŒ 'é›¨ã§ã‚‚OK' ã‚’å«ã‚“ã§ã„ã‚‹ã‹
    query = query.contains('tags', ['é›¨ã§ã‚‚OK']);
  }

  // æ¤œç´¢æ¡ä»¶ãŒãªã„å ´åˆã®ã¿ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œ2é€±é–“å…ˆã¾ã§ã€ã«çµã‚‹
  // (ãŸã ã—ã€æ–°ç€é †ã§è¦‹ãŸã„å ´åˆãªã©ã¯æœŸé–“åˆ¶é™ã‚’å¤–ã™è€ƒãˆæ–¹ã‚‚ã‚ã‚‹ãŒã€ã“ã“ã§ã¯åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã«å¾“ã†)
  if (!params.q && !params.category && !params.area && !params.rain && !params.sort) {
     query = query.lte('event_date', twoWeeksLater);
  }

  // 5. ä¸¦ã³æ›¿ãˆ
  if (params.sort === 'newest') {
    // æ–°ç€é †ï¼ˆä½œæˆæ—¥ é™é †ï¼‰
    query = query.order('created_at', { ascending: false });
  } else {
    // é–‹å‚¬ãŒæ—©ã„é †ï¼ˆé–‹å‚¬æ—¥ æ˜‡é †ï¼‰ -> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    query = query.order('event_date', { ascending: true });
  }

  query = query.range(from, to);

  const { data, error, count } = await query;

  if (error) {
    console.error('Supabase Error:', error);
    return { events: [], total: 0 };
  }
  
  return { events: data as unknown as Event[], total: count };
}

export default async function Home({
  searchParams,
}: {
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}) {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
  const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
  const supabase = createClient(supabaseUrl, supabaseKey);
  
  const isMaintenance = await checkMaintenance(supabase);
  if (isMaintenance) {
    return <Maintenance />;
  }

  const resolvedSearchParams = await searchParams;
  
  // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ•´ç†
  const params: SearchParams = {
    page: typeof resolvedSearchParams.page === 'string' ? resolvedSearchParams.page : '1',
    category: typeof resolvedSearchParams.category === 'string' ? resolvedSearchParams.category : undefined,
    area: typeof resolvedSearchParams.area === 'string' ? resolvedSearchParams.area : undefined,
    q: typeof resolvedSearchParams.q === 'string' ? resolvedSearchParams.q : undefined,
    rain: typeof resolvedSearchParams.rain === 'string' ? resolvedSearchParams.rain : undefined,
    sort: typeof resolvedSearchParams.sort === 'string' ? resolvedSearchParams.sort : undefined,
  };
  
  const { events, total } = await getEvents(params);
  
  const totalEvents = total || 0;
  const currentPage = parseInt(params.page || '1');
  const totalPages = Math.ceil(totalEvents / PER_PAGE);
  const isSearching = !!(params.category || params.area || params.q || params.rain);

  return (
    <main className="min-h-screen bg-slate-100 font-sans flex flex-col text-slate-900">
      
      {/* â–¼â–¼ ãƒ˜ãƒƒãƒ€ãƒ¼ â–¼â–¼ */}
      <header className="bg-white border-b border-slate-300 sticky top-0 z-30 shadow-sm">
        <div className="max-w-5xl mx-auto px-6 h-20 flex justify-between items-center">
          <Link href="/" className="flex items-center gap-3 group">
            <div className="w-10 h-10 relative transition-transform group-hover:scale-105">
              <img src="/logo.png" alt="Logo" className="w-full h-full object-contain" />
            </div>
            <h1 className="text-2xl font-extrabold text-slate-900 tracking-tight">
              Hamamatsu<span className="text-blue-700">Events</span>
            </h1>
          </Link>
          
          <Link 
            href="/admin" 
            className="text-base font-bold text-blue-700 hover:text-blue-900 flex items-center gap-1 transition-colors px-4 py-2 rounded hover:bg-blue-50"
          >
            ã‚¤ãƒ™ãƒ³ãƒˆæŠ•ç¨¿
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
          </Link>
        </div>
      </header>

      {/* â–¼â–¼ ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ â–¼â–¼ */}
      <div className="bg-blue-50 pb-16 pt-12 px-6 rounded-b-[3rem] shadow-sm mb-10 border-b border-blue-200">
        <div className="max-w-2xl mx-auto text-center">
          
          <h2 className="text-3xl md:text-5xl font-extrabold text-slate-900 mb-4 leading-tight animate-fade-in-up">
            ä»Šé€±æœ«ã€<br/>
            <span className="text-blue-700">ã©ã“ã¸å‡ºã‹ã‘ã‚‹ï¼Ÿ</span>
          </h2>
          <p className="text-base md:text-lg font-bold text-slate-700 mb-10 animate-fade-in-up animation-delay-200">
            æµœæ¾ã‚¨ãƒªã‚¢ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å³é¸ã—ã¦ãŠå±Šã‘
          </p>

          {/* æ¤œç´¢ãƒãƒ¼ */}
          <form action="/" method="GET" className="relative mb-8 shadow-xl rounded-full group animate-fade-in-up animation-delay-400">
             {/* æ—¢å­˜ãƒ•ã‚£ãƒ«ã‚¿ç¶­æŒ */}
            {params.category && <input type="hidden" name="category" value={params.category} />}
            {params.area && <input type="hidden" name="area" value={params.area} />}
            {params.rain && <input type="hidden" name="rain" value={params.rain} />}

            <div className="absolute inset-y-0 left-5 flex items-center pointer-events-none">
              <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
            <input 
              type="text" 
              name="q"
              defaultValue={params.q}
              placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆä¾‹ï¼šç¥­ã‚Šã€ç„¡æ–™ï¼‰" 
              className="w-full py-5 pl-14 pr-6 rounded-full border-2 border-blue-100 focus:border-blue-600 focus:ring-0 text-lg font-bold placeholder-slate-400 text-slate-900 shadow-sm outline-none transition-colors"
            />
          </form>

          {/* ã‚«ãƒ†ã‚´ãƒªã‚¿ã‚° */}
          <div className="flex flex-wrap justify-center gap-3 animate-fade-in-up animation-delay-400">
             <Link 
              href="/" 
              className={`px-5 py-2 rounded-full text-sm font-bold shadow-md transition transform hover:-translate-y-0.5 ${
                !params.category 
                  ? 'bg-blue-700 text-white' 
                  : 'bg-white text-blue-800 border-2 border-blue-100 hover:bg-blue-50'
              }`}
            >
              ã™ã¹ã¦
            </Link>
            {CATEGORY_OPTIONS.map((cat) => (
              <Link
                key={cat}
                href={`/?${new URLSearchParams({
                  ...(params.q ? { q: params.q } : {}),
                  ...(params.area ? { area: params.area } : {}),
                  ...(params.rain ? { rain: params.rain } : {}),
                  ...(params.category === cat ? {} : { category: cat }),
                }).toString()}`}
                className={`px-5 py-2 rounded-full text-sm font-bold shadow-sm border-2 transition transform hover:-translate-y-0.5 ${
                  params.category === cat
                    ? 'bg-blue-600 text-white border-blue-600 shadow-md'
                    : 'bg-white text-blue-800 border-blue-100 hover:bg-blue-50 hover:border-blue-300'
                }`}
              >
                {cat}
              </Link>
            ))}
          </div>

          {/* ã‚¨ãƒªã‚¢ã‚¿ã‚° */}
          <div className="mt-6 animate-fade-in-up animation-delay-400">
            <p className="text-xs font-bold text-slate-500 mb-2">ã‚¨ãƒªã‚¢ã§çµã‚Šè¾¼ã‚€</p>
            <div className="flex flex-wrap justify-center gap-2">
              {AREA_OPTIONS.map((areaName) => {
                const match = areaName.match(/ï¼ˆ(.+)ï¼‰/);
                const shortName = match ? match[1] : areaName;
                return (
                  <Link
                    key={areaName}
                    href={`/?${new URLSearchParams({
                      ...(params.q ? { q: params.q } : {}),
                      ...(params.category ? { category: params.category } : {}),
                      ...(params.rain ? { rain: params.rain } : {}),
                      ...(params.area === areaName ? {} : { area: areaName }),
                    }).toString()}`}
                    className={`px-3 py-1.5 rounded-lg text-xs font-bold border-2 transition-colors ${
                      params.area === areaName
                        ? 'bg-blue-100 text-blue-800 border-blue-300'
                        : 'bg-white text-slate-500 border-blue-50 hover:border-blue-200 hover:text-blue-600'
                    }`}
                  >
                    {shortName}
                  </Link>
                );
              })}
            </div>
          </div>

        </div>
      </div>

      {/* â–¼â–¼ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ â–¼â–¼ */}
      <div className="max-w-5xl mx-auto px-6 flex-grow w-full">
        
        {/* â˜…è¿½åŠ : ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ï¼ˆé›¨ã§ã‚‚OKãƒ»ä¸¦ã³æ›¿ãˆï¼‰ */}
        <FilterBar />

        {/* æ¤œç´¢çµæœãƒ»ä»¶æ•°ãƒ»ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ */}
        <div className="flex items-center justify-between mb-6 px-1">
          <div className="flex items-center gap-3">
            <h3 className="text-2xl font-extrabold text-slate-900">
              {isSearching ? 'æ¤œç´¢çµæœ' : 'ãŠã™ã™ã‚ã‚¤ãƒ™ãƒ³ãƒˆ'}
            </h3>
            <span className="bg-blue-100 text-blue-800 text-sm font-black px-3 py-1 rounded-full border border-blue-200">{totalEvents}ä»¶</span>
          </div>
          
          {/* â˜…ä¿®æ­£: æ¡ä»¶ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ï¼ˆã‚ã‹ã‚Šã‚„ã™ã„ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ã«å¤‰æ›´ï¼‰ */}
          {isSearching && (
             <Link 
               href="/" 
               className="flex items-center gap-2 bg-slate-200 hover:bg-red-100 text-slate-600 hover:text-red-600 px-4 py-2 rounded-full text-xs font-bold transition-colors"
             >
               <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
               æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢
             </Link>
          )}
        </div>

        <EventList events={events} page={currentPage} totalPages={totalPages} />
      </div>

      {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
      <footer className="bg-white border-t border-slate-300 py-12 mt-20 text-base text-center">
        <div className="max-w-5xl mx-auto px-6">
          <p className="font-extrabold text-slate-900 text-xl mb-6">HamamatsuEvents</p>
          <div className="flex justify-center gap-8 mb-8">
            <Link href="/terms" className="text-slate-600 hover:text-blue-700 font-bold">åˆ©ç”¨è¦ç´„</Link>
            <Link href="/privacy" className="text-slate-600 hover:text-blue-700 font-bold">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</Link>
            <a href="#" className="text-slate-600 hover:text-blue-700 font-bold">ãŠå•ã„åˆã‚ã›</a>
          </div>
          <p className="text-slate-500 text-sm font-medium">Â© 2025 Hamamatsu Event Info</p>
        </div>
      </footer>
    </main>
  );
}
</file>

</files>
